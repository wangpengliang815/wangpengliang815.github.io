<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Wang’Notes’
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-exp.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 5.4.0"></head>

  <body>

    <div class="book-container">
      <div class="book-sidebar">
        <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>WANG’NOTES’</span>
  </a>
</div>
          <div id="menu" class="book-menu hide">
  <ul>
<li><a href="/index">Home</a></li>
</ul>
<h2 id="DotNET">DotNET</h2>
<ul>
<li><a href="/dotnet/%E5%9F%BA%E7%A1%80%E5%90%88%E9%9B%86">基础合集</a></li>
<li><a href="/dotnet/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
<li><a href="/dotnet/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1">面向对象</a></li>
<li><a href="/dotnet/%E6%B3%9B%E5%9E%8B%E6%8A%80%E6%9C%AF">泛型技术</a></li>
<li><a href="/dotnet/%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF">反射技术</a></li>
<li><a href="/dotnet/%E5%A7%94%E6%89%98%E5%92%8C%E4%BA%8B%E4%BB%B6%E8%AF%A6%E8%A7%A3">委托和事件详解</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91">多线程开发</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E6%8A%80%E6%9C%AF">多线程之线程同步技术</a></li>
<li><a href="/dotnet/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B">异步编程async/await</a></li>
<li><a href="/dotnet/%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D">值类型和引用类型的内存分配</a></li>
<li><a href="/dotnet/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B">并行编程</a></li>
<li><a href="/dotnet/1.1DataProtection%E7%AE%80%E4%BB%8B">【数据保护】1.1 DataProtection简介</a></li>
<li><a href="/dotnet/1.2DataProtection%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D">【数据保护】1.2 DataProtection方法介绍</a></li>
<li><a href="/dotnet/1.3%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E5%8F%8A%E5%A4%9A%E7%8E%AF%E5%A2%83%E8%B0%83%E8%AF%95">【数据保护】1.3 落地实践及多环境调试</a></li>
<li><a href="/dotnet/1.4UserSecrets">【数据保护】1.4 UserSecrets</a></li>
<li><a href="/dotnet/1.5%E5%9F%BA%E4%BA%8EDataProtection%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%96%B9%E6%A1%88">【数据保护】1.5 数据保护方案</a></li>
<li><a href="/dotnet/1.6%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5%E5%8F%8A%E9%9B%86%E6%88%90AzureDevops%E7%AE%A1%E9%81%93">【数据保护】1.6 集成AzureDevops</a></li>
</ul>
<h2 id="JAVA">JAVA</h2>
<ul>
<li><a href="/java/JavaSE%E5%9F%BA%E7%A1%80">JavaSE基础</a></li>
</ul>
<h2 id="Linux">Linux</h2>
<ul>
<li><a href="/linux/Centos%E5%AE%89%E8%A3%85">Centos安装</a></li>
<li><a href="/linux/Centos%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">Centos网络配置</a></li>
<li><a href="/linux/Centos7%E5%8D%87%E7%BA%A7gcc%E7%89%88%E6%9C%AC">Centos7升级gcc版本</a></li>
<li><a href="/linux/Linux%E7%9B%AE%E5%BD%95%E8%AF%B4%E6%98%8E">Linux目录说明</a></li>
<li><a href="/linux/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">Linux常用命令</a></li>
</ul>
<h2 id="Redis">Redis</h2>
<ul>
<li><a href="/redis/1.1NoSql%E6%A6%82%E8%BF%B0">1.1 NoSql概述</a></li>
<li><a href="/redis/1.2Redis%E5%AE%89%E8%A3%85">1.2 Redis安装</a></li>
<li><a href="/redis/1.3Redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.3 Redis基本数据类型</a></li>
<li><a href="/redis/1.4Redis%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.4 Redis特殊数据类型</a></li>
<li><a href="/redis/1.5Redis%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C">1.5 Redis事务操作</a></li>
<li><a href="/redis/1.6Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">1.6 Redis配置文件详解</a></li>
<li><a href="/redis/1.7Redis%E6%8C%81%E4%B9%85%E5%8C%96">1.7 Redis持久化</a></li>
<li><a href="/redis/1.8Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85">1.8 Redis发布订阅</a></li>
<li><a href="/redis/1.9Redis%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 Redis集群方案</a></li>
<li><a href="/redis/1.10Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.10 Redis常见问题</a></li>
<li><a href="/redis/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5Redis">客户端连接Redis</a></li>
<li><a href="/redis/%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BARedis%E9%9B%86%E7%BE%A4">使用Docker搭建Redis集群</a></li>
</ul>
<h2 id="RabbitMQ">RabbitMQ</h2>
<ul>
<li><a href="/rabbitMq/1.1RabbitMQ%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 RabbitMQ概念及安装</a></li>
<li><a href="/rabbitMq/1.2%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D">1.2 工作模式介绍</a></li>
<li><a href="/rabbitMq/1.3%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E5%8F%8A%E6%8C%81%E4%B9%85%E5%8C%96">1.3 消息确认及持久化</a></li>
<li><a href="/rabbitMq/1.4%E4%B8%A4%E7%A7%8D%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F%E5%92%8CQOS%E7%9A%84%E5%AE%9E%E7%8E%B0">1.4 两种消费模式和QOS的实现</a></li>
<li><a href="/rabbitMq/1.5Channel%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95">1.5 Channel常见方法</a></li>
<li><a href="/rabbitMq/1.6RabbitMQ%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">1.6 RabbitMQ常用命令</a></li>
<li><a href="/rabbitMq/1.7RabbitMQ%E5%B8%B8%E8%A7%81%E7%AD%96%E7%95%A5">1.7 RabbitMQ常见策略</a></li>
<li><a href="/rabbitMq/1.8RabbitMQ%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.8 RabbitMQ常见问题</a></li>
<li><a href="/rabbitMq/1.9RabbitMQ%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 RabbitMQ集群方案</a></li>
<li><a href="/rabbitMq/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5RabbitMQ">客户端连接RabbitMQ</a></li>
</ul>
<h2 id="Docker">Docker</h2>
<ul>
<li><a href="/docker/1.1Docker%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 Docker概念及安装</a></li>
<li><a href="/docker/1.2Docker%E9%95%9C%E5%83%8F(Image)">1.2 Docker镜像(Image)</a></li>
<li><a href="/docker/1.3Docker%E5%AE%B9%E5%99%A8(Container)">1.3 Docker容器(Container)</a></li>
<li><a href="/docker/1.4Docker%E4%BB%93%E5%BA%93(Repository)">1.4 Docker仓库(Repository)</a></li>
<li><a href="/docker/1.5Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">1.5 Docker数据管理</a></li>
<li><a href="/docker/1.6Docker%E5%AE%B9%E5%99%A8%E5%9B%9B%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F">1.6 Docker容器四种网络模式</a></li>
<li><a href="/docker/1.7Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">1.7 Docker高级网络配置</a></li>
<li><a href="/docker/1.8Dockerfile">1.8 Dockerfile</a></li>
<li><a href="/docker/1.9Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerCompose">1.9 Docker三剑客之DockerCompose</a></li>
<li><a href="/docker/2.0Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerMachine">2.0 Docker三剑客之DockerMachine</a></li>
<li><a href="/docker/2.1Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerSwarm">2.1 Docker三剑客之DockerSwarm</a></li>
<li><a href="/docker/2.2Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">2.2 Docker常用命令</a></li>
<li><a href="/docker/Portainer%E5%8F%AF%E8%A7%86%E5%8C%96%E9%9D%A2%E6%9D%BF">Portainer可视化面板</a></li>
</ul>
<h2 id="UnitTest">UnitTest</h2>
<ul>
<li><a href="/unittest/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">单元测试</a></li>
<li><a href="/unittest/%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95">集成测试</a></li>
<li><a href="/unittest/%E8%87%AA%E5%8A%A8%E5%8C%96UI%E6%B5%8B%E8%AF%95">自动化UI测试（Selenium）</a></li>
<li><a href="/unittest/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95k6">压力测试（k6）</a></li>
</ul>
<h2 id="【-NET-Core】：Microservice-Sample">【.NET Core】：Microservice.Sample</h2>
<ul>
<li><a href="/sample/microservice/1.1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA">1.1 微服务入门：项目搭建</a></li>
<li><a href="/sample/microservice/1.2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0">1.2 微服务入门：服务注册与发现</a></li>
<li><a href="/sample/microservice/1.3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E7%BD%91%E5%85%B3">1.3 微服务入门：网关</a></li>
<li><a href="/sample/microservice/1.4%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF">1.4 微服务入门：事件总线</a></li>
<li><a href="/sample/microservice/1.5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8BDockerCompose">1.5 微服务入门：DockerCompose</a></li>
</ul>
<h2 id="其它">其它</h2>
<ul>
<li><a href="/other/Consul%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0">Consul 服务注册发现</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

      </div>

      <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

        <div class="off-canvas-content">
          <div class="columns">
            <div class="column col-10 col-lg-12">
              <div class="book-navbar">
                <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

              </div>
              <div class="book-content">
                
<article id="page">
  <h1></h1>
  <h1 id="Redis集群">Redis集群</h1>
<p>Redis支持三种集群方案</p>
<ul>
<li>主从复制</li>
<li>Sentinel（哨兵）</li>
<li>Cluster</li>
</ul>
<h2 id="主从复制">主从复制</h2>
<p>通过持久化功能，Redis保证了即使在服务器重启的情况下也不会丢失（或少量丢失）数据，因为持久化会把内存中数据保存到硬盘上，重启会从硬盘上加载数据。 但是由于数据是存储在一台服务器上的，如果这台服务器出现硬盘故障等问题，也会导致数据丢失。为了避免单点故障，通常的做法是将数据库复制多个副本以部署在不同的服务器上，这样即使有一台服务器出现故障，其他服务器依然可以继续提供服务。</p>
<p>为此： <code>Redis 提供了复制（replication）功能，可以实现当一台数据库中的数据更新后，自动将更新的数据同步到其他数据库上</code>。</p>
<p>在复制的概念中，数据库分为两类，一类是主数据库（master），另一类是从数据库(slave）。主数据库可以进行读写操作，当写操作导致数据变化时会自动将数据同步给从数据库。而从数据库一般是只读的，只接受主数据库同步过来的数据。<code>一个主数据库可以拥有多个从数据库，而一个从数据库只能拥有一个主数据库</code>。</p>
<h3 id="实现原理">实现原理</h3>
<ol>
<li>从库启动成功后连接主库，发送 <code>SYNC</code> 命令</li>
<li>主库接收到 <code>SYNC</code> 命令后，开始执行 <code>BGSAVE</code> 命令生成 <code>rdb</code> 文件并使用缓冲区记录此后执行的所有写命令</li>
<li>主库 <code>BGSAVE</code> 执行完毕后，向所有从库发送快照文件，并在发送期间继续记录被执行的写命令</li>
<li>从库收到快照文件后丢弃所有旧数据，载入收到的快照</li>
<li>主库快照发送完毕后开始向从库发送缓冲区中的写命令</li>
<li>从库完成对快照的载入，开始接收命令请求，并执行来自主库缓冲区的写命令（至此：从库初始化完成）</li>
<li>主库每执行一个写命令就会向从库发送相同的写命令，从库接收并执行收到的写命令（备注：从库初始化完成后的操作）</li>
<li>出现断开重连后，2.8之后的版本会将断线期间的命令传给从库。增量复制</li>
<li>主从刚连接时：进行全量同步。全同步结束后：进行增量同步。当然如果有需要 slave 可以在任何时候都可以发起全量同步。Redis 的策略是：无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步</li>
</ol>
<h3 id="主从复制优缺点"><strong>主从复制优缺点</strong></h3>
<p><strong>优点</strong></p>
<ul>
<li>主机会自动将数据同步到从机，可以进行读写分离</li>
<li>为了分载 <code>master</code> 的读操作压力，<code>slave</code> 服务器可以为客户端提供只读操作的服务，但写服务仍必须由 <code>master</code> 完成</li>
<li><code>slave</code> 同样可以接受其它 <code>slaves</code> 的连接和同步请求，这样可以有效的分载 <code>master</code> 的同步压力</li>
<li><code>master-server</code> 是以非阻塞的方式为 <code>slaves</code>提供服务。所以在 <code>master-slave</code> 同步期间，客户端仍然可以提交查询或修改请求</li>
<li><code>slave-server</code> 同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，则返回同步之前的数据</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换 <code>IP</code> 才能恢复（人工介入方式）</li>
<li>主机宕机，宕机前如有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性</li>
<li>如果多个 <code>slave</code> 掉线需要重启时，尽量不要在同一时间段进行重启。因为只要 <code>slave</code> 启动，就会发送<code>sync</code> 请求和主机全量同步，当多个 <code>slave</code> 重启时，可能会导致 <code>master</code> <code>IO</code> 剧增从而宕机</li>
<li>较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂</li>
</ul>
<h3 id="主从复制搭建">主从复制搭建</h3>
<ul>
<li>集群至少需要3个节点，因为投票容错机制要求超过半数节点认为某个节点挂了该节点才是挂了，所以低于3个节点无法构成集群</li>
<li>要保证集群的高可用，需要每个节点都有从节点，也就是备份节点。所以Redis集群至少需要6台服务器。这里模拟搭建的是伪分布式集群（<strong>单机多实例</strong>）</li>
<li>默认情况下不指定主机的话，每台 Redis 都是主节点</li>
</ul>
<p>1)：虚机运行3个 Redis 实例（一主二从），修改端口号为（79-81）。复制2份 <code>redis.conf</code> 模拟2个从机实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ls</span></span><br><span class="line">conf  dump.rdb  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br><span class="line">[root@wangpengliang bin]<span class="comment"># cd conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment"># ls</span></span><br><span class="line">redis.conf</span><br><span class="line">[root@wangpengliang conf]<span class="comment"># cp redis.conf redis80.conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment"># cp redis.conf redis81.conf</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">端口</th>
<th style="text-align:center">配置文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master</td>
<td style="text-align:center">6379</td>
<td style="text-align:center">redis.conf</td>
</tr>
<tr>
<td style="text-align:center">slave1</td>
<td style="text-align:center">6380</td>
<td style="text-align:center">redis80.conf</td>
</tr>
<tr>
<td style="text-align:center">slave2</td>
<td style="text-align:center">6381</td>
<td style="text-align:center">redis81.conf</td>
</tr>
</tbody>
</table>
<p>2)：修改配置</p>
<ol>
<li><code>logfile</code></li>
<li><code>dbfilename</code></li>
<li><code>port</code></li>
<li><code>pidfile</code></li>
</ol>
<p>redis.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logfile <span class="string">&quot;6379.log&quot;</span></span><br><span class="line">dbfilename dump6379.rdb</span><br></pre></td></tr></table></figure>
<p>redis80.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logfile <span class="string">&quot;6380.log&quot;</span></span><br><span class="line">dbfilename dump6380.rdb</span><br><span class="line">port 6380</span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br></pre></td></tr></table></figure>
<p>redis81.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logfile <span class="string">&quot;6381.log&quot;</span></span><br><span class="line">dbfilename dump6381.rdb</span><br><span class="line">port 6381</span><br><span class="line">pidfile /var/run/redis_6381.pid</span><br></pre></td></tr></table></figure>
<p>3)：查看Redis进程信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang conf]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root       2679      1  0 02:53 ?        00:00:00 ./redis-server 0.0.0.0:6379</span><br><span class="line">root       2685      1  0 02:54 ?        00:00:00 ./redis-server 0.0.0.0:6380</span><br><span class="line">root       2691      1  0 02:54 ?        00:00:00 ./redis-server 0.0.0.0:6381</span><br><span class="line">root       2697   2643  0 02:54 pts/3    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>
<p>4)：设置主从：<code>SLAVEOF &#123;host&#125; &#123;port&#125;</code></p>
<p>80</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-cli -p 6380</span></span><br><span class="line">127.0.0.1:6380&gt; SLAVEOF 0.0.0.0 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:0.0.0.0</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:28</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:fb828085ccb5c0b804cfa2e8112656aef5f561c8</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:28</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:28</span><br></pre></td></tr></table></figure>
<p>81</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-cli -p 6381</span></span><br><span class="line">127.0.0.1:6381&gt; clear</span><br><span class="line">127.0.0.1:6381&gt; SLAVEOF 0.0.0.0 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:0.0.0.0</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:210</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:fb828085ccb5c0b804cfa2e8112656aef5f561c8</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:210</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:183</span><br><span class="line">repl_backlog_histlen:28</span><br></pre></td></tr></table></figure>
<p>79（master）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=210,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=210,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:fb828085ccb5c0b804cfa2e8112656aef5f561c8</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:210</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:210</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：使用命令的方式集群是暂时的；如果需要永久生效需要修改配置文件</p>
<p>5)：修改配置文件设置主从</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></table></figure>
<p>redis80.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof 0.0.0.0 6379</span><br></pre></td></tr></table></figure>
<p>redis81.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof 0.0.0.0 6379</span><br></pre></td></tr></table></figure>
<p>如果主机有密码通过 <code>masterauth &lt;master-password&gt;</code> 设置。</p>
<p><strong>注意</strong></p>
<ul>
<li>主机可写，从机只能读不能写</li>
<li>主机中数据会自动备份到从机</li>
</ul>
<p>6)：主机宕机测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SHUTDOWN</span><br><span class="line">not connected&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root       2723      1  0 03:12 ?        00:00:00 ./redis-server 0.0.0.0:6380</span><br><span class="line">root       2728   2605  0 03:12 pts/1    00:00:00 ./redis-cli -p 6380</span><br><span class="line">root       2730      1  0 03:12 ?        00:00:00 ./redis-server 0.0.0.0:6381</span><br><span class="line">root       2735   2624  0 03:12 pts/2    00:00:00 ./redis-cli -p 6381</span><br><span class="line">root       2738   2643  0 03:16 pts/3    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>
<p>80</p>
<p>此时并没有配置哨兵，所以在 <code>Master</code> 79宕机后，80依旧是从机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:0.0.0.0</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:down</span><br><span class="line">master_last_io_seconds_ago:-1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:1130</span><br><span class="line">master_link_down_since_seconds:17</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:fb828085ccb5c0b804cfa2e8112656aef5f561c8</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:1130</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:771</span><br><span class="line">repl_backlog_histlen:360</span><br></pre></td></tr></table></figure>
<ul>
<li>主机断线重连后，从机依旧可以读取到主机的值</li>
<li>从机断线重连后，从机依旧可以读取到主机的值</li>
</ul>
<p>7)：手动切换主节点</p>
<p>此时使用 <code>Slaveof no one</code> 命令可以使80变成主机。</p>
<h2 id="Sentinel（哨兵）模式">Sentinel（哨兵）模式</h2>
<p>主从切换的方法是：当主服务器宕机后，需要手动把从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式。哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是：哨兵通过发送命令等待Redis服务器响应，从而监控运行的多个Redis实例。</p>
<h3 id="哨兵作用">哨兵作用</h3>
<ul>
<li>通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器</li>
<li>当哨兵监测到 master 宕机，会自动将 slave切换成  master ，然后通过 发布订阅模式通知其他的从机修改配置文件，让它们切换主机</li>
<li>master 切换后，<code>master_redis.conf</code> 、<code>slave_redis.conf</code> 和 <code>sentinel.conf</code> 的内容都会发生改变，<code>master_redis.conf</code>  中会多一行 <code>slaveof </code>的配置，<code>sentinel.conf</code> 的监控目标会随之调换</li>
<li>一个哨兵进程对 <code>Redis</code> 服务器进行监控，可能会出现问题，为此可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这就形成了多哨兵模式</li>
</ul>
<h3 id="故障切换（failover）过程">故障切换（failover）过程</h3>
<ul>
<li>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行 <code>failover</code>，仅仅是哨兵1主观的认为主服务器不可用，这个现象称为 <strong>主观下线</strong></li>
<li>当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 <code>failover</code> 。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为 <strong>客观下线</strong></li>
</ul>
<h3 id="哨兵工作方式">哨兵工作方式</h3>
<ul>
<li>每个<code>sentinel</code>以每秒钟一次的频率向它所知的<code>master</code>、<code>slave</code>、 <code>sentinel</code> 实例发送一个 <code>PING</code> 命令</li>
<li>如果一个实例（<code>instance</code>）距离最后一次有效回复 <code>PING</code> 命令的时间超过 <code>down-after-milliseconds</code>选项所指定的值， 则这个实例会被 <code>sentinel</code> 标记为主观下线</li>
<li>如果一个<code>master</code>被标记为主观下线，则正在监视这个<code>master</code>的所有 <code>sentinels</code> 要以每秒一次的频率确认<code>master</code> 的确进入了主观下线状态</li>
<li>当有足够数量的 <code>sentinel</code>（大于等于配置文件指定的值）在指定的时间范围内确认 <code>master</code> 的确进入了主观下线状态，则 <code>master</code> 会被标记为客观下线</li>
<li>一般情况下， 每个 <code>sentinel</code> 会以每 10 秒一次的频率向它已知的所有 <code>master</code>、<code>slave</code>发送  <code>INFO </code>命令</li>
<li>当<code>master</code>被 <code>sentinel</code> 标记为客观下线时，<code>sentinel</code> 向 <code>master</code> 的所有 <code>slave</code> 发送 <code>INFO</code> 命令的频率会从 10 秒一次改为每秒一次</li>
<li>若没有足够数量的 <code>sentinel</code> 同意 <code>master</code> 已经下线， <code>master</code> 的客观下线状态就会被移除。若<code>master</code> 重新向 <code>sentinel</code> 的 <code>PING</code> 命令返回有效回复，<code>master</code> 的主观下线状态就会被移除</li>
</ul>
<h3 id="哨兵模式优缺点">哨兵模式优缺点</h3>
<p><strong>优点</strong></p>
<ul>
<li>哨兵模式是基于主从模式的，所有主从的优点哨兵模式都具有</li>
<li>主从可以自动切换。系统更健壮、可用性更高（可以看作自动版的主从复制）</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>Redis 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂</li>
</ul>
<h3 id="哨兵模式搭建">哨兵模式搭建</h3>
<p>1)：Redis安装目录下有一个 <code>sentinel.conf</code> 文件，<code>copy  </code>一份进行修改</p>
<p>2)：配置哨兵</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置监听的主服务器，这里sentinel monitor代表监控，mymaster代表服务器的名称，可以自定义</span></span><br><span class="line"><span class="comment"># 192.168.11.128代表监控的主服务器，6379代表端口，2代表只有两个或两个以上的哨兵认为主服务器不可用的时候，才会进行failover操作。权值为2，这里的权值，是用来计算我们需要将哪一台服务器升级升主服务器</span></span><br><span class="line">sentinel monitor mymaster 0.0.0.0 6379 2</span><br></pre></td></tr></table></figure>
<p>3)：启动哨兵</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-sentinel conf/sentinel.conf</span></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.075 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.075 <span class="comment"># Redis version=6.2.1, bits=64, commit=00000000, modified=0, pid=2821, just sta</span></span><br><span class="line">rted2821:X 19 Apr 2021 04:13:16.075 <span class="comment"># Configuration loaded</span></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.076 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 102</span><br><span class="line">4).2821:X 19 Apr 2021 04:13:16.076 * monotonic clock: POSIX clock_gettime</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ <span class="string">&#x27;&#x27;</span>-._                                             </span><br><span class="line">      _.-``    `.  `_.  <span class="string">&#x27;&#x27;</span>-._           Redis 6.2.1 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">&#x27;&#x27;</span>-._                                   </span><br><span class="line"> (    <span class="string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="string">&#x27;|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 2821</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |           http://redis.io        </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |                                  </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line">      `-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>                                       </span><br><span class="line">          `-._        _.-<span class="string">&#x27;                                           </span></span><br><span class="line"><span class="string">              `-.__.-&#x27;</span>                                               </span><br><span class="line"></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.076 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/</span></span><br><span class="line">net/core/somaxconn is <span class="built_in">set</span> to the lower value of 128.2821:X 19 Apr 2021 04:13:16.077 <span class="comment"># Sentinel ID is fdcb482b76a22f67429b1473ddc33d0d3769f7f3</span></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.077 <span class="comment"># +monitor master mymaster 0.0.0.0 6379 quorum 1</span></span><br><span class="line">2821:X 19 Apr 2021 04:13:16.078 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 0.0.0.0 6379</span><br><span class="line">2821:X 19 Apr 2021 04:13:16.080 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 0.0.0.0 6379</span><br></pre></td></tr></table></figure>
<p>Sentinel 启动之后，就会监视到现在有一个主服务器，两个从服务器；当把其中一个从服务器器关闭之后，可以看到日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2821:X 19 Apr 2021 04:14:03.125 <span class="comment"># +sdown master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.125 <span class="comment"># +odown master mymaster 0.0.0.0 6379 #quorum 1/1</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.125 <span class="comment"># +new-epoch 1</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.125 <span class="comment"># +try-failover master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.132 <span class="comment"># +vote-for-leader fdcb482b76a22f67429b1473ddc33d0d3769f7f3 1</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.132 <span class="comment"># +elected-leader master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.132 <span class="comment"># +failover-state-select-slave master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.199 <span class="comment"># +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.199 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ myma</span><br><span class="line">ster 0.0.0.0 63792821:X 19 Apr 2021 04:14:03.282 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster</span><br><span class="line"> 0.0.0.0 63792821:X 19 Apr 2021 04:14:03.288 <span class="comment"># +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.288 <span class="comment"># +failover-state-reconf-slaves master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:03.340 * +slave-reconf-sent slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 0.0.0.0 637</span><br><span class="line">92821:X 19 Apr 2021 04:14:04.312 * +slave-reconf-inprog slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 0.0.0.0 6</span><br><span class="line">3792821:X 19 Apr 2021 04:14:04.312 * +slave-reconf-done slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 0.0.0.0 637</span><br><span class="line">92821:X 19 Apr 2021 04:14:04.378 <span class="comment"># +failover-end master mymaster 0.0.0.0 6379</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:04.378 <span class="comment"># +switch-master mymaster 0.0.0.0 6379 127.0.0.1 6380</span></span><br><span class="line">2821:X 19 Apr 2021 04:14:04.379 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">2821:X 19 Apr 2021 04:14:04.379 * +slave slave 0.0.0.0:6379 0.0.0.0 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line">2821:X 19 Apr 2021 04:14:34.411 <span class="comment"># +sdown slave 0.0.0.0:6379 0.0.0.0 6379 @ mymaster 127.0.0.1 6380</span></span><br></pre></td></tr></table></figure>
<p>此时Master从79转移到了80</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=4615,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:872d3e4c9538abb9f117dcc47de99ac57791433a</span><br><span class="line">master_replid2:612af05d7a22d2b35e595f43be74ddd771765798</span><br><span class="line">master_repl_offset:4615</span><br><span class="line">second_repl_offset:1212</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:4615</span><br></pre></td></tr></table></figure>
<p>79重新连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis.conf</span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-cli -p 6379</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:35074</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:872d3e4c9538abb9f117dcc47de99ac57791433a</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:35074</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:32735</span><br><span class="line">repl_backlog_histlen:2340</span><br></pre></td></tr></table></figure>
<p>79重新连接后只能是从机了，master已经被80抢占。</p>
<h2 id="Cluster-集群模式">Cluster 集群模式</h2>
<p>Redis Cluster是一种服务器 Sharding 技术，3.0版本开始正式提供。Redis 的哨兵模式基本已经可以实现高可用，读写分离 ，但是在这种模式下每台 Redis 服务器都存储相同的数据，很浪费内存，所以在 Redis3.0上加入了 Cluster 集群模式，实现了 Redis 的分布式存储。也就是说每台 Redis 节点上存储不同的内容。</p>
<h3 id="Cluster特点">Cluster特点</h3>
<ul>
<li>多主多从去中心化：从节点作为备用，复制主节点，不做读写操作不提供服务（可通过 <code>readOnly</code> 实现只读）</li>
<li>不支持处理多个key：因为数据分散在多个节点，在数据量大高并发的情况下会影响性能</li>
<li>支持动态扩容节点：Rerdis Cluster 最大的优点之一</li>
<li>节点之间相互通信，相互选举，不再依赖Sentinel：准确来说是主节点之间相互“监督”，保证及时故障转移</li>
</ul>
<h3 id="Cluster集群模式对比">Cluster集群模式对比</h3>
<ul>
<li>相比哨兵模式：多个master节点保证主要业务（比如master节点主要负责写）稳定性，不需要搭建多个sentinel实例监控一个master节点</li>
<li>相比一主多从模式：不需要手动切换，具有自我故障检测，故障转移的特点</li>
<li>相比其哨兵和主从：对数据进行分片（sharding），不同节点存储数据不一样支持动态扩容。从某种程度上来说，Sentinel模式主要针对高可用（HA），而Cluster模式是不仅针对大数据量，高并发，同时也支持HA</li>
</ul>
<h3 id="数据存储设计"><strong>数据存储设计</strong></h3>
<ul>
<li>通过算法设计，计算出key应该保存的位置</li>
<li>将所有的存储空间计划切割成<code>16384</code>份，每台主机保存一部分每份代表的是一个存储空间，不是一个<code>key</code>的保存空间</li>
<li>将<code>key</code>按照计算出的结果放到对应的存储空间</li>
</ul>
<p>1)：<code>key</code>通过<code>hash</code>算法计算出一个值，然后拿这个值<code>%16384</code></p>
<p>2)：得到一个数（假如是37）为key的保存位置，然后再存入相应的存储空间位置</p>
<p><img src="../images/2021-09-03-17-12-12.png" alt=""></p>
<p>3)：假如又增加了一个节点，之前每个节点都会拿出部分槽给新的节点</p>
<p>4)：如果是去除节点，则把被去除节点的槽加入到存在的节点当中</p>
<h3 id="哈希槽Slot">哈希槽Slot</h3>
<p>Redis集群使用一种称作一致性哈希的复合分区形式（组合了哈希分区和列表分袂的特征来计算键的归属实例），键的<code>CRC16</code>哈希值被称为哈希槽。比如对于三个Redis节点，哈希槽的分配方式如下：</p>
<ul>
<li>第一节点拥有<code>0-5500</code>哈希槽</li>
<li>第二节点拥有<code>5501-11000</code>哈希槽</li>
<li>第三节点拥有剩余的<code>11001-16384</code>哈希槽</li>
</ul>
<p>通过计算键的 <code>CRC16</code> 哈希值，然后对16384进行取模得到：<code>HASH_SLOT=CRC16(key) modulo 16383</code>，Redis提供了<strong>CLUSTER KEYSLOT</strong>命令来执行哈希槽的计算。</p>
<p><strong>注意</strong>：集群节点保存键值对以及键值对过期时间的处理方式与Redis单机模式是一样的，唯一不同就是节点只能使用0号数据库，而单机Redis服务器则没有限制。</p>
<h3 id="集群内部通讯机制">集群内部通讯机制</h3>
<p>各个数据库互相通信，保存各个库中槽的编号数据。</p>
<p>1)：客户端发出一个key访问A，通过算法计算出key的存储位置</p>
<p>2)：如果一次命中，直接返回</p>
<p>3)：一次未命中，告知具体位置</p>
<p>4)：一次命中或者两次命中提高数据访问效率</p>
<p><img src="../images/2021-09-03-17-12-36.png" alt=""></p>
<h3 id="Cluster集群搭建">Cluster集群搭建</h3>
<p>1)：单虚机运行6个redis实例（三主三从），端口号为（79-84）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang <span class="built_in">local</span>]<span class="comment"># cd /usr/local/redis/bin</span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ls</span></span><br><span class="line">conf  redis-benchmark  redis-check-aof  redis-check-rdb  redis-cli  redis-sentinel  redis-server</span><br><span class="line">[root@wangpengliang bin]<span class="comment"># cd conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment"># ls</span></span><br><span class="line">redis80.conf  redis81.conf  redis.conf  sentinel.conf</span><br><span class="line">[root@wangpengliang conf]<span class="comment"># cp redis.conf redis82.conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment"># cp redis.conf redis83.conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment"># cp redis.conf redis84.conf</span></span><br><span class="line">[root@wangpengliang conf]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">端口</th>
<th style="text-align:center">配置文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">6379</td>
<td style="text-align:center">redis.conf</td>
</tr>
<tr>
<td style="text-align:center">6380</td>
<td style="text-align:center">redis80.conf</td>
</tr>
<tr>
<td style="text-align:center">6381</td>
<td style="text-align:center">redis81.conf</td>
</tr>
<tr>
<td style="text-align:center">6382</td>
<td style="text-align:center">redis82.conf</td>
</tr>
<tr>
<td style="text-align:center">6383</td>
<td style="text-align:center">redis83.conf</td>
</tr>
<tr>
<td style="text-align:center">6384</td>
<td style="text-align:center">redis84.conf</td>
</tr>
</tbody>
</table>
<p>2)：修改配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes <span class="comment"># 后台启动</span></span><br><span class="line">protected-mode no ; <span class="comment"># 允许外部访问</span></span><br><span class="line">port 6379 <span class="comment"># 修改端口号，从79~84</span></span><br><span class="line">cluster-enabled yes <span class="comment"># 开启cluster，去掉注释</span></span><br><span class="line">cluster-config-file nodes-6379.conf <span class="comment"># 自动生成</span></span><br><span class="line">cluster-node-timeout 15000 <span class="comment"># 节点通信时间</span></span><br><span class="line">logfile   /usr/<span class="built_in">local</span>/redis/bin/6379.log</span><br><span class="line">dbfilename 6379dump.rdb  <span class="comment"># 做伪集群的时候，一定要修改rdb文件的名字，如果aof也开的话也需要修改，否则扩容的时候会出现提示说新增扩容节点存在数据，需要先删除数据的提示。</span></span><br></pre></td></tr></table></figure>
<p>3)：启动Redis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis.conf </span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis80.conf </span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis81.conf </span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis82.conf </span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis83.conf </span></span><br><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-server conf/redis84.conf</span></span><br></pre></td></tr></table></figure>
<p>查看Redis进程信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root       3538      1  0 13:37 ?        00:00:01 ./redis-server 0.0.0.0:6382 [cluster]</span><br><span class="line">root       3545      1  0 13:38 ?        00:00:01 ./redis-server 0.0.0.0:6383 [cluster]</span><br><span class="line">root       3551      1  0 13:38 ?        00:00:01 ./redis-server 0.0.0.0:6384 [cluster]</span><br><span class="line">root       3797      1  0 13:48 ?        00:00:00 ./redis-server 0.0.0.0:6380 [cluster]</span><br><span class="line">root       3803      1  0 13:48 ?        00:00:00 ./redis-server 0.0.0.0:6381 [cluster]</span><br><span class="line">root       3816      1  0 13:49 ?        00:00:00 ./redis-server 0.0.0.0:6379 [cluster]</span><br><span class="line">root       3826   3494  0 13:49 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>
<p><strong>4)</strong>：创建集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--cluster create  192.168.80.251:6379 192.168.80.251:6380 192.168.80.251:6381 192.168.80.251:6382 192.168.80.251:6383 192.168.80.251:6384  --cluster-replicas 1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@wangpengliang bin]<span class="comment"># ./redis-cli --cluster create  192.168.15.251:6379 192.168.15.251:6380 192.168.15.251:6381 192.168.15.251:6382 192.168.15.251:6383 192.168.15.251:6384  --cluster-replicas 1</span></span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.168.15.251:6383 to 192.168.15.251:6379</span><br><span class="line">Adding replica 192.168.15.251:6384 to 192.168.15.251:6380</span><br><span class="line">Adding replica 192.168.15.251:6382 to 192.168.15.251:6381</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span><br><span class="line">[WARNING] Some slaves are <span class="keyword">in</span> the same host as their master</span><br><span class="line">M: 48f3cbacb014f1d0f89fe99bb494e1cabb1f80f4 192.168.15.251:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: ee511eed5a7d08d39ceef29823b98e299435523e 192.168.15.251:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: e4c70b085d10d51a3201c6bf4bfa47adfa000f2e 192.168.15.251:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 5261a1ccb42ac160a93572beae7344e6b0c7c520 192.168.15.251:6382</span><br><span class="line">   replicates 48f3cbacb014f1d0f89fe99bb494e1cabb1f80f4</span><br><span class="line">S: d420ca1e3ef8edd538286e1c7698783447312148 192.168.15.251:6383</span><br><span class="line">   replicates ee511eed5a7d08d39ceef29823b98e299435523e</span><br><span class="line">S: 235fb6093a7f1c92e7144109aee10d1e341d2fb9 192.168.15.251:6384</span><br><span class="line">   replicates e4c70b085d10d51a3201c6bf4bfa47adfa000f2e</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">&#x27;yes&#x27;</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 192.168.15.251:6379)</span><br><span class="line">M: 48f3cbacb014f1d0f89fe99bb494e1cabb1f80f4 192.168.15.251:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: e4c70b085d10d51a3201c6bf4bfa47adfa000f2e 192.168.15.251:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: ee511eed5a7d08d39ceef29823b98e299435523e 192.168.15.251:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5261a1ccb42ac160a93572beae7344e6b0c7c520 192.168.15.251:6382</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 48f3cbacb014f1d0f89fe99bb494e1cabb1f80f4</span><br><span class="line">S: 235fb6093a7f1c92e7144109aee10d1e341d2fb9 192.168.15.251:6384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates e4c70b085d10d51a3201c6bf4bfa47adfa000f2e</span><br><span class="line">S: d420ca1e3ef8edd538286e1c7698783447312148 192.168.15.251:6383</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee511eed5a7d08d39ceef29823b98e299435523e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
<h1 id="Redis-Cluster集群命令">Redis-Cluster集群命令</h1>
<ul>
<li><code>cluster info</code> ：打印集群的信息</li>
<li><code>cluster nodes</code>：列出集群当前已知的所有节点（ node），以及这些节点的相关信息</li>
<li><code>cluster meet</code>   ：将 ip 和 port 所指定的节点添加到集群当中</li>
<li><code>cluster forget &lt;node_id&gt;</code> ：从集群中移除 node_id 指定的节点</li>
<li><code>cluster replicate &lt;master_node_id&gt;</code> ：将当前从节点设置为 node_id 指定的master节点的slave节点。只能针对slave节点操作</li>
<li><code>cluster saveconfig</code>：将节点的配置文件保存到硬盘里面</li>
<li><code>cluster addslots  [slot ...]</code> ：将一个或多个槽（ slot）指派（ assign）给当前节点</li>
<li><code>cluster delslots  [slot ...] </code>：移除一个或多个槽对当前节点的指派</li>
<li><code>cluster flushslots</code> ：移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点</li>
<li><code>cluster setslot  node &lt;node_id&gt;</code> ：将槽 slot 指派给 node_id 指定的节点</li>
<li><code>cluster setslot  migrating &lt;node_id&gt;</code> ：将本节点的槽 slot 迁移到 node_id 指定的节点中</li>
<li><code>cluster setslot  importing &lt;node_id&gt;</code> ：从 node_id 指定的节点中导入槽 slot 到本节点</li>
<li><code>cluster setslot  stable</code> ：取消对槽 slot 的导入（ import）或者迁移（ migrate）</li>
<li><code>cluster keyslot</code>  ：计算键 key 应该被放置在哪个槽上</li>
<li><code>cluster countkeysinslot</code> ：返回槽 slot 目前包含的键值对数量</li>
<li><code>cluster getkeysinslot</code>   ：返回 count 个 slot 槽中的键</li>
</ul>
<h1 id="查看Redis数据库信息">查看Redis数据库信息</h1>
<p><code>info replication</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line"><span class="comment"># 角色</span></span><br><span class="line">role:master</span><br><span class="line"><span class="comment"># 连接的从机数量</span></span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:28d568fba5f2ed0f9034a4f63acc4960287099af</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>

</article>

<div id="paginator">
  
</div>

                  <script src="https://utteranc.es/client.js" repo="wangpengliang815/blog-comments"
                    issue-term="pathname" label="issue" theme="github-light" crossorigin="anonymous" async>
                    </script>
              </div>
            </div>
            <div class="column col-2 hide-lg">
              <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="W"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Wang,PengLiang</div>
      <div>2021-09-10</div>
    </div>
  </div>

  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
            </div>
          </div>

        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>

  </body>

</html>


<script src="/js/book.js"></script>
