<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="前言# 上一篇中使用 CAP 完成了一个简单的 Eventbus，实现了服务之间的解耦和异步调用，并且做到数据的最终一致性。搞到这里系统环境已经比较复杂了，想把整个系统运行起来会非常繁琐：要运行 Consul、订单服务、产品服务、网关、鉴权中心、RabbitMQ，本篇将使用 Docker Compose 来解决以上问题，仅需一个简单的命令，即可启动整个环境。
Docker Compose# 什么是Docker Compose？
Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务
简单来理解，Compose类似一个批量工具，可以执行一组命令，支持批量构建镜像，批量启动容器，批量删除容器等等功能。Windows的 Docker Desktop 中已经包括了 Compose，Linux下 Compose 则需要单独安装。关于 Compose 更多信息参考 【Docker三剑客之DockerCompose】。
yml file# yml 文件是使用 Compose 必不可少的，在编写 yml 文件之前需要准备Dockerfile。之前的章节中，网关服务不是在 Docker 中运行的，现在全部放到Docker中。确保解决方案中每个项目都添加Docker支持。
# See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging. # 基于 `mcr.microsoft.com/dotnet/aspnet:5.0 AS base` 来构建镜像 FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base # 设置工作目录,如不存在会被创建 WORKDIR /app # Copy release文件夹内容到工作目录app COPY . /app # 运行.dll ENTRYPOINT [&#34;dotnet&#34;, &#34;Ocelot.Geteway.dll&#34;]新建 docker-compose.yml 文件，以下是 docker-compose.yml文件内容：
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/posts/microservice/1.5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8Bdockercompose/">
  <meta property="og:site_name" content="CODE&#39;NOTE">
  <meta property="og:title" content="CODE&#39;NOTE">
  <meta property="og:description" content="前言# 上一篇中使用 CAP 完成了一个简单的 Eventbus，实现了服务之间的解耦和异步调用，并且做到数据的最终一致性。搞到这里系统环境已经比较复杂了，想把整个系统运行起来会非常繁琐：要运行 Consul、订单服务、产品服务、网关、鉴权中心、RabbitMQ，本篇将使用 Docker Compose 来解决以上问题，仅需一个简单的命令，即可启动整个环境。
Docker Compose# 什么是Docker Compose？
Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务
简单来理解，Compose类似一个批量工具，可以执行一组命令，支持批量构建镜像，批量启动容器，批量删除容器等等功能。Windows的 Docker Desktop 中已经包括了 Compose，Linux下 Compose 则需要单独安装。关于 Compose 更多信息参考 【Docker三剑客之DockerCompose】。
yml file# yml 文件是使用 Compose 必不可少的，在编写 yml 文件之前需要准备Dockerfile。之前的章节中，网关服务不是在 Docker 中运行的，现在全部放到Docker中。确保解决方案中每个项目都添加Docker支持。
# See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging. # 基于 `mcr.microsoft.com/dotnet/aspnet:5.0 AS base` 来构建镜像 FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base # 设置工作目录,如不存在会被创建 WORKDIR /app # Copy release文件夹内容到工作目录app COPY . /app # 运行.dll ENTRYPOINT [&#34;dotnet&#34;, &#34;Ocelot.Geteway.dll&#34;]新建 docker-compose.yml 文件，以下是 docker-compose.yml文件内容：">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">


  <meta itemprop="name" content="CODE&#39;NOTE">
  <meta itemprop="description" content="前言# 上一篇中使用 CAP 完成了一个简单的 Eventbus，实现了服务之间的解耦和异步调用，并且做到数据的最终一致性。搞到这里系统环境已经比较复杂了，想把整个系统运行起来会非常繁琐：要运行 Consul、订单服务、产品服务、网关、鉴权中心、RabbitMQ，本篇将使用 Docker Compose 来解决以上问题，仅需一个简单的命令，即可启动整个环境。
Docker Compose# 什么是Docker Compose？
Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务
简单来理解，Compose类似一个批量工具，可以执行一组命令，支持批量构建镜像，批量启动容器，批量删除容器等等功能。Windows的 Docker Desktop 中已经包括了 Compose，Linux下 Compose 则需要单独安装。关于 Compose 更多信息参考 【Docker三剑客之DockerCompose】。
yml file# yml 文件是使用 Compose 必不可少的，在编写 yml 文件之前需要准备Dockerfile。之前的章节中，网关服务不是在 Docker 中运行的，现在全部放到Docker中。确保解决方案中每个项目都添加Docker支持。
# See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging. # 基于 `mcr.microsoft.com/dotnet/aspnet:5.0 AS base` 来构建镜像 FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base # 设置工作目录,如不存在会被创建 WORKDIR /app # Copy release文件夹内容到工作目录app COPY . /app # 运行.dll ENTRYPOINT [&#34;dotnet&#34;, &#34;Ocelot.Geteway.dll&#34;]新建 docker-compose.yml 文件，以下是 docker-compose.yml文件内容：">
  <meta itemprop="wordCount" content="500">

<title>1.5微服务入门之 Docker Compose | CODE&#39;NOTE</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/posts/microservice/1.5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8Bdockercompose/">
<link rel="stylesheet" href="/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css" integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG&#43;T2l66Bw7pV8=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.3ed9c79c605914c45e19db90edfda0ca8d87c63064c1d6252862250c4e917346.js" integrity="sha256-PtnHnGBZFMReGduQ7f2gyo2HxjBkwdYlKGIlDE6Rc0Y=" crossorigin="anonymous"></script>



  
</head>
<body dir="ltr" class="book-kind-page book-type-posts">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>CODE&#39;NOTE</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="Search"
    aria-label="Search"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>
























</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>1.5微服务入门之 Docker Compose</h3>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
<article class="markdown book-post">
  <h1>
    1.5微服务入门之 Docker Compose
  </h1>
  


  

  


  <div class="book-post-content markdown-inner"><h1 id="前言">前言<a class="anchor" href="#%e5%89%8d%e8%a8%80">#</a></h1>
<p>上一篇中使用 CAP 完成了一个简单的 <code>Eventbus</code>，实现了服务之间的解耦和异步调用，并且做到数据的最终一致性。搞到这里系统环境已经比较复杂了，想把整个系统运行起来会非常繁琐：要运行 Consul、订单服务、产品服务、网关、<del>鉴权中心</del>、RabbitMQ，本篇将使用 <code>Docker Compose</code> 来解决以上问题，仅需一个简单的命令，即可启动整个环境。</p>
<!-- more -->
<h1 id="docker-compose">Docker Compose<a class="anchor" href="#docker-compose">#</a></h1>
<p>什么是Docker Compose？</p>
<blockquote class='book-hint '>
<p>Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务</p>
</blockquote><p>简单来理解，Compose类似一个批量工具，可以执行一组命令，支持批量构建镜像，批量启动容器，批量删除容器等等功能。Windows的 Docker Desktop 中已经包括了 Compose，Linux下 Compose 则需要单独安装。关于 Compose 更多信息参考 <a href="https://wpl.wiki/docker/1.9Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerCompose">【Docker三剑客之DockerCompose】</a>。</p>
<h1 id="yml-file">yml file<a class="anchor" href="#yml-file">#</a></h1>
<p>yml 文件是使用 Compose 必不可少的，在编写 yml 文件之前需要准备Dockerfile。之前的章节中，网关服务不是在 Docker 中运行的，现在全部放到Docker中。确保解决方案中每个项目都添加Docker支持。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># See https://aka.ms/containerfastmode to understand how Visual Studio uses this Dockerfile to build your images for faster debugging.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 基于 `mcr.microsoft.com/dotnet/aspnet:5.0 AS base` 来构建镜像</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">mcr.microsoft.com/dotnet/aspnet:5.0</span> <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">base</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 设置工作目录,如不存在会被创建</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy release文件夹内容到工作目录app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 运行.dll</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;Ocelot.Geteway.dll&#34;</span>]</span></span></code></pre></div><p>新建 <code>docker-compose.yml</code> 文件，以下是 <code>docker-compose.yml</code>文件内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span>version: <span style="color:#e6db74">&#39;3.4&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>services:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    apigateway: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: gateway<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        build: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            context: .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            dockerfile: ./gateway.release/Dockerfile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;8080:8080&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:8080<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - orderapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - orderapi2<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - orderapi3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - productapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - productapi2<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - productapi3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    orderapi1:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: order.api<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        build: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            context: .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            dockerfile: ./order.api.release/Dockerfile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - 80:80<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:80 <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - consul<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - rabbitmq<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    orderapi2:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: order.api<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;81:80&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:81<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span>orderapi2<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">81</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - orderapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    orderapi3:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: order.api<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;82:80&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:82<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span>orderapi3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">82</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - orderapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    productapi1: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: product.api <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        build: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            context: .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            dockerfile: ./product.api.release/Dockerfile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;85:80&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:85<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span>productapi1 <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - consul<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - rabbitmq<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    productapi2:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: product.api<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;86:80&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:86<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span>productapi2<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">86</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - productapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    productapi3:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: product.api<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;87:80&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        environment: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ASPNETCORE_URLS<span style="color:#f92672">=</span>http://+:87<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServiceIP<span style="color:#f92672">=</span>productapi3 <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - ConsulSetting:ServicePort<span style="color:#f92672">=</span><span style="color:#ae81ff">87</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        depends_on: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - productapi1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    consul:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: consul<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        container_name: consul<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - <span style="color:#e6db74">&#39;8500:8500&#39;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    rabbitmq:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        image: rabbitmq:3.9.5-management <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        container_name: rabbitmq<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - 15672:15672<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - 5672:5672<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            - my-testnet<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>networks: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    my-testnet: <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        driver: bridge</span></span></code></pre></div><p>以上 <code>yml</code> 文件定义了网关服务、订单服务、产品服务、Consul，rabbitMQ 9个服务（容器），和一个容器网络 <code>my-testnet</code>。这里 <code>product.api</code>和 <code>order.api</code> 是基于同样的镜像各运行了3个容器，真实开发中他们应该分布在多个docker主机中。将 <code>yml</code>文件扔到虚机目录中（这里为了快速测试，真实不会这么搞）。</p>
<p><img src="/images/2021-09-19-04-36-38.png" alt="" /></p>
<h1 id="容器网络">容器网络<a class="anchor" href="#%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c">#</a></h1>
<p>之前容器之间通讯是通过容器的IP访问，虽然是可以访问但不友好。更好的方式是：自定义一个bridge网络，将所有服务（容器）加入这个网络中，那么容器之间就可以直接通过服务名称通信了。（这里暂时没这么做）bridge 模式只是docker网络模式中的一种，更多信息参考：<a href="https://wpl.wiki/docker/1.7Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE#%E5%AE%B9%E5%99%A8%E8%B7%A8%E7%BD%91%E6%A1%A5%E9%80%9A%E4%BF%A1">【Docker高级网络配置#容器跨网桥通信】</a>。</p>
<h1 id="构建与启动">构建与启动<a class="anchor" href="#%e6%9e%84%e5%bb%ba%e4%b8%8e%e5%90%af%e5%8a%a8">#</a></h1>
<p>完成以上操作后，进入虚机目录执行<code>docker-compose up -d</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 dotnetcore_src<span style="color:#f92672">]</span><span style="color:#75715e"># docker-compose up -d</span>
</span></span><span style="display:flex;"><span>Creating rabbitmq ... 
</span></span><span style="display:flex;"><span>Creating consul ... 
</span></span><span style="display:flex;"><span>Creating rabbitmq
</span></span><span style="display:flex;"><span>Creating rabbitmq ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi1_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi1_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi1_1
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi1_1 ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi1_1 ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi2_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi3_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi3_1
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi2_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_productapi3_1
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi2_1
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_orderapi3_1 ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_apigateway_1 ... 
</span></span><span style="display:flex;"><span>Creating dotnetcoresrc_apigateway_1 ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 dotnetcore_src<span style="color:#f92672">]</span><span style="color:#75715e"># docker ps -a</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                                                                                                                                                 NAMES
</span></span><span style="display:flex;"><span>82e1221c03b5   gateway                     <span style="color:#e6db74">&#34;dotnet Ocelot.Gatew…&#34;</span>   <span style="color:#ae81ff">6</span> seconds ago   Up <span style="color:#ae81ff">5</span> seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp                                                                                                             dotnetcoresrc_apigateway_1
</span></span><span style="display:flex;"><span>90a760680cba   product.api                 <span style="color:#e6db74">&#34;dotnet Product.Api.…&#34;</span>   <span style="color:#ae81ff">7</span> seconds ago   Up <span style="color:#ae81ff">6</span> seconds   0.0.0.0:86-&gt;80/tcp, :::86-&gt;80/tcp                                                                                                                     dotnetcoresrc_productapi2_1
</span></span><span style="display:flex;"><span>352c6bce65e6   product.api                 <span style="color:#e6db74">&#34;dotnet Product.Api.…&#34;</span>   <span style="color:#ae81ff">7</span> seconds ago   Up <span style="color:#ae81ff">6</span> seconds   0.0.0.0:87-&gt;80/tcp, :::87-&gt;80/tcp                                                                                                                     dotnetcoresrc_productapi3_1
</span></span><span style="display:flex;"><span>eafce74e7582   order.api                   <span style="color:#e6db74">&#34;dotnet Order.Api.dll&#34;</span>   <span style="color:#ae81ff">7</span> seconds ago   Up <span style="color:#ae81ff">6</span> seconds   0.0.0.0:81-&gt;80/tcp, :::81-&gt;80/tcp                                                                                                                     dotnetcoresrc_orderapi2_1
</span></span><span style="display:flex;"><span>6b9c45e89c55   order.api                   <span style="color:#e6db74">&#34;dotnet Order.Api.dll&#34;</span>   <span style="color:#ae81ff">7</span> seconds ago   Up <span style="color:#ae81ff">6</span> seconds   0.0.0.0:82-&gt;80/tcp, :::82-&gt;80/tcp                                                                                                                     dotnetcoresrc_orderapi3_1
</span></span><span style="display:flex;"><span>2acb5ed6125e   order.api                   <span style="color:#e6db74">&#34;dotnet Order.Api.dll&#34;</span>   <span style="color:#ae81ff">8</span> seconds ago   Up <span style="color:#ae81ff">7</span> seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp                                                                                                                     dotnetcoresrc_orderapi1_1
</span></span><span style="display:flex;"><span>e9c6a88e6a72   product.api                 <span style="color:#e6db74">&#34;dotnet Product.Api.…&#34;</span>   <span style="color:#ae81ff">8</span> seconds ago   Up <span style="color:#ae81ff">7</span> seconds   0.0.0.0:85-&gt;80/tcp, :::85-&gt;80/tcp                                                                                                                     dotnetcoresrc_productapi1_1
</span></span><span style="display:flex;"><span>84b03969229f   consul                      <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> seconds ago   Up <span style="color:#ae81ff">8</span> seconds   8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp, :::8500-&gt;8500/tcp                                                           consul
</span></span><span style="display:flex;"><span>aff9066b3ff0   rabbitmq:3.9.5-management   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> seconds ago   Up <span style="color:#ae81ff">8</span> seconds   4369/tcp, 5671/tcp, 0.0.0.0:5672-&gt;5672/tcp, :::5672-&gt;5672/tcp, 15671/tcp, 15691-15692/tcp, 25672/tcp, 0.0.0.0:15672-&gt;15672/tcp, :::15672-&gt;15672/tcp   rabbitmq
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 dotnetcore_src<span style="color:#f92672">]</span><span style="color:#75715e"># </span></span></span></code></pre></div><p>浏览器访问网关测试：</p>
<p><img src="/images/2021-09-19-16-52-59.png" alt="" /></p>
<p>Postman调用下单接口：
<img src="/images/2021-09-19-16-54-27.png" alt="" /></p>
<p>查看数据库：
<img src="/images/2021-09-19-16-55-07.png" alt="" /></p>
<p>至此就完成了使用 <code>docker-compose</code> 一键启动整个环境，想要摧毁这个环境也很简单，只需要一句 <code>docker-compose down</code>。</p>
</div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">
  <div>
  
    <a href="/posts/microservice/1.4%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/" class="flex align-center">
      <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
      <span>1.4微服务入门之事件总线</span>
    </a>
  
  </div>
  <div>
  
    <a href="/posts/microservice/consul%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0/" class="flex align-center">
      <span>Consul服务注册发现</span>
      <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
    </a>
  
  </div>
</div>
 
        
  
 
        
        
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
 
  </main>

  
</body>
</html>




















