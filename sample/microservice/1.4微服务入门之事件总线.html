<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Wang’Notes’
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-exp.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 5.4.0"></head>

  <body>

    <div class="book-container">
      <div class="book-sidebar">
        <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>WANG’NOTES’</span>
  </a>
</div>
          <div id="menu" class="book-menu hide">
  <ul>
<li><a href="/index">Home</a></li>
</ul>
<h2 id="DotNET">DotNET</h2>
<ul>
<li><a href="/dotnet/%E5%9F%BA%E7%A1%80%E5%90%88%E9%9B%86">基础合集</a></li>
<li><a href="/dotnet/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</a></li>
<li><a href="/dotnet/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1">面向对象</a></li>
<li><a href="/dotnet/%E6%B3%9B%E5%9E%8B%E6%8A%80%E6%9C%AF">泛型技术</a></li>
<li><a href="/dotnet/%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF">反射技术</a></li>
<li><a href="/dotnet/%E5%A7%94%E6%89%98%E5%92%8C%E4%BA%8B%E4%BB%B6%E8%AF%A6%E8%A7%A3">委托和事件详解</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91">多线程开发</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E6%8A%80%E6%9C%AF">多线程之线程同步技术</a></li>
<li><a href="/dotnet/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B">异步编程async/await</a></li>
<li><a href="/dotnet/%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D">值类型和引用类型的内存分配</a></li>
<li><a href="/dotnet/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B">并行编程</a></li>
</ul>
<h2 id="DataProtection-数据保护">DataProtection 数据保护</h2>
<ul>
<li><a href="/dotnet/1.1DataProtection%E7%AE%80%E4%BB%8B">1.1 DataProtection简介</a></li>
<li><a href="/dotnet/1.2DataProtection%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D">1.2 DataProtection方法介绍</a></li>
<li><a href="/dotnet/1.3%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E5%8F%8A%E5%A4%9A%E7%8E%AF%E5%A2%83%E8%B0%83%E8%AF%95">1.3 落地实践及多环境调试</a></li>
<li><a href="/dotnet/1.4UserSecrets">1.4 UserSecrets</a></li>
<li><a href="/dotnet/1.5%E5%9F%BA%E4%BA%8EDataProtection%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4%E6%96%B9%E6%A1%88">1.5 基于DataProtection的数据保护方案</a></li>
<li><a href="/dotnet/1.6%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5%E5%8F%8A%E9%9B%86%E6%88%90AzureDevops%E7%AE%A1%E9%81%93">1.6 方案实践及集成AzureDevops管道</a></li>
</ul>
<h2 id="Linux">Linux</h2>
<ul>
<li><a href="/linux/Centos%E5%AE%89%E8%A3%85">Centos安装</a></li>
<li><a href="/linux/Centos%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">Centos网络配置</a></li>
<li><a href="/linux/Centos7%E5%8D%87%E7%BA%A7gcc%E7%89%88%E6%9C%AC">Centos7升级gcc版本</a></li>
<li><a href="/linux/Linux%E7%9B%AE%E5%BD%95%E8%AF%B4%E6%98%8E">Linux目录说明</a></li>
<li><a href="/linux/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">Linux常用命令</a></li>
</ul>
<h2 id="Redis">Redis</h2>
<ul>
<li><a href="/redis/1.1NoSql%E6%A6%82%E8%BF%B0">1.1 NoSql概述</a></li>
<li><a href="/redis/1.2Redis%E5%AE%89%E8%A3%85">1.2 Redis安装</a></li>
<li><a href="/redis/1.3Redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.3 Redis基本数据类型</a></li>
<li><a href="/redis/1.4Redis%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.4 Redis特殊数据类型</a></li>
<li><a href="/redis/1.5Redis%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C">1.5 Redis事务操作</a></li>
<li><a href="/redis/1.6Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">1.6 Redis配置文件详解</a></li>
<li><a href="/redis/1.7Redis%E6%8C%81%E4%B9%85%E5%8C%96">1.7 Redis持久化</a></li>
<li><a href="/redis/1.8Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85">1.8 Redis发布订阅</a></li>
<li><a href="/redis/1.9Redis%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 Redis集群方案</a></li>
<li><a href="/redis/1.10Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.10 Redis常见问题</a></li>
<li><a href="/redis/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5Redis">客户端连接Redis</a></li>
<li><a href="/redis/%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BARedis%E9%9B%86%E7%BE%A4">使用Docker搭建Redis集群</a></li>
</ul>
<h2 id="RabbitMQ">RabbitMQ</h2>
<ul>
<li><a href="/rabbitMq/1.1RabbitMQ%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 RabbitMQ概念及安装</a></li>
<li><a href="/rabbitMq/1.2%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D">1.2 工作模式介绍</a></li>
<li><a href="/rabbitMq/1.3%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E5%8F%8A%E6%8C%81%E4%B9%85%E5%8C%96">1.3 消息确认及持久化</a></li>
<li><a href="/rabbitMq/1.4%E4%B8%A4%E7%A7%8D%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F%E5%92%8CQOS%E7%9A%84%E5%AE%9E%E7%8E%B0">1.4 两种消费模式和QOS的实现</a></li>
<li><a href="/rabbitMq/1.5Channel%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95">1.5 Channel常见方法</a></li>
<li><a href="/rabbitMq/1.6RabbitMQ%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">1.6 RabbitMQ常用命令</a></li>
<li><a href="/rabbitMq/1.7RabbitMQ%E5%B8%B8%E8%A7%81%E7%AD%96%E7%95%A5">1.7 RabbitMQ常见策略</a></li>
<li><a href="/rabbitMq/1.8RabbitMQ%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.8 RabbitMQ常见问题</a></li>
<li><a href="/rabbitMq/1.9RabbitMQ%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 RabbitMQ集群方案</a></li>
<li><a href="/rabbitMq/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5RabbitMQ">客户端连接RabbitMQ</a></li>
</ul>
<h2 id="Docker">Docker</h2>
<ul>
<li><a href="/docker/1.1Docker%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 Docker概念及安装</a></li>
<li><a href="/docker/1.2Docker%E9%95%9C%E5%83%8F(Image)">1.2 Docker镜像(Image)</a></li>
<li><a href="/docker/1.3Docker%E5%AE%B9%E5%99%A8(Container)">1.3 Docker容器(Container)</a></li>
<li><a href="/docker/1.4Docker%E4%BB%93%E5%BA%93(Repository)">1.4 Docker仓库(Repository)</a></li>
<li><a href="/docker/1.5Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">1.5 Docker数据管理</a></li>
<li><a href="/docker/1.6Docker%E5%AE%B9%E5%99%A8%E5%9B%9B%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F">1.6 Docker容器四种网络模式</a></li>
<li><a href="/docker/1.7Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">1.7 Docker高级网络配置</a></li>
<li><a href="/docker/1.8Dockerfile">1.8 Dockerfile</a></li>
<li><a href="/docker/1.9Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerCompose">1.9 Docker三剑客之DockerCompose</a></li>
<li><a href="/docker/2.0Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerMachine">2.0 Docker三剑客之DockerMachine</a></li>
<li><a href="/docker/2.1Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerSwarm">2.1 Docker三剑客之DockerSwarm</a></li>
<li><a href="/docker/2.2Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">2.2 Docker常用命令</a></li>
<li><a href="/docker/Portainer%E5%8F%AF%E8%A7%86%E5%8C%96%E9%9D%A2%E6%9D%BF">Portainer可视化面板</a></li>
</ul>
<h2 id="UnitTest">UnitTest</h2>
<ul>
<li><a href="/unittest/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">单元测试</a></li>
<li><a href="/unittest/%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95">集成测试</a></li>
<li><a href="/unittest/%E8%87%AA%E5%8A%A8%E5%8C%96UI%E6%B5%8B%E8%AF%95">自动化UI测试（Selenium）</a></li>
<li><a href="/unittest/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95k6">压力测试（k6）</a></li>
</ul>
<h2 id="示例项目：Microservice-Sample">示例项目：Microservice.Sample</h2>
<ul>
<li><a href="/sample/microservice/1.1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA">1.1 微服务入门：项目搭建</a></li>
<li><a href="/sample/microservice/1.2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0">1.2 微服务入门：服务注册与发现</a></li>
<li><a href="/sample/microservice/1.3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E7%BD%91%E5%85%B3">1.3 微服务入门：网关</a></li>
<li><a href="/sample/microservice/1.4%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF">1.4 微服务入门：事件总线</a></li>
<li><a href="/sample/microservice/1.5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8BDockerCompose">1.5 微服务入门：DockerCompose</a></li>
</ul>
<h2 id="其它">其它</h2>
<ul>
<li><a href="/other/Consul%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0">Consul 服务注册发现</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

      </div>

      <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

        <div class="off-canvas-content">
          <div class="columns">
            <div class="column col-10 col-lg-12">
              <div class="book-navbar">
                <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

              </div>
              <div class="book-content">
                
<article id="page">
  <h1></h1>
  <h1 id="前言">前言</h1>
<p>上一篇中已经完成了 Ocelot + Consul 的搭建，这篇简单说一下事件总线（<code>EventBus</code>)。</p>
<h1 id="事件总线">事件总线</h1>
<p>什么是事件总线？</p>
<blockquote>
<p>事件总线是对观察者（发布-订阅）模式的一种实现。它是一种集中式事件处理机制，允许不同的组件之间进行彼此通信而又不需要相互依赖，达到解耦的目的</p>
</blockquote>
<p>为什么要使用事件总线？</p>
<blockquote>
<ol>
<li>以当前项目举例，假设有一个订单服务，一个产品服务。客户端有一个下单功能，下单时调用订单服务的下单接口，下单接口需要调用产品服务的减库存接口，这涉及到服务与服务之间的调用。服务之间调用可以选择 <code>RestAPI</code> 或者效率更高的 <code>gRPC</code>。可能这两者各有各的使用场景，但是它们都存在服务之间的耦合问题，或者难以做到异步调用</li>
<li>假设下单调用订单服务，订单服务需要调用产品服务，产品服务又要调用物流服务，物流服务再去调用xx服务等等，如果每个服务处理时间需要2s，不使用异步处理的话，响应时间可想而知。如果使用EventBus的话，那么订单服务只需要向EventBus发一个“下单事件”就可以了。产品服务会订阅“下单事件”，当产品服务收到下单事件时，自己去减库存。这样就避免了两个服务之间直接调用的耦合性，并且真正做到了异步调用</li>
</ol>
</blockquote>
<p>既然涉及到多个服务之间的异步调用，那么就不得不提分布式事务。分布式事务并不是微服务独有的问题，而是所有的分布式系统都会存在的问题。关于分布式事务，可以查一下 “CAP原则” 和 “BASE理论” 了解更多。如今分布式系统更多时候会追求事务的最终一致性。</p>
<p>下面使用开源框架 <code>CAP</code>来演示 <code>EventBus</code> 的基本使用。之所以使用 <code>CAP</code> 是因为它既能解决分布式系统的最终一致性，同时又是一个 <code>EventBus</code>，它具备<code>EventBus</code> 的所有功能。<a target="_blank" rel="noopener" href="https://www.cnblogs.com/savorboard/p/cap.html">点击了解更多</a>。</p>
<h1 id="CAP">CAP</h1>
<p>目前 CAP 支持使用 <code>RabbitMQ</code> ，<code>Kafka</code>，<code>Azure Service Bus</code> 等进行底层之间的消息发送，不需要具备这些消息队列的使用经验就可以轻松的集成到项目中。CAP 目前支持使用 <code>Sql Server</code>，<code>MySql</code>，<code>PostgreSql</code>，<code>MongoDB</code> 数据库的项目。这里选择：消息组件使用 <code>RabbitMq</code>，数据库存储使用 <code>SqlServer</code>。</p>
<p><code>Nuget</code> 安装 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.EntityFrameworkCore</span><br><span class="line">Microsoft.EntityFrameworkCore.Tools</span><br><span class="line">Microsoft.EntityFrameworkCore.SqlServer</span><br><span class="line">DotNetCore.CAP</span><br><span class="line">DotNetCore.CAP.RabbitMQ</span><br><span class="line">DotNetCore.CAP.SqlServer</span><br></pre></td></tr></table></figure>
<h1 id="Product-Api">Product.Api</h1>
<p>新增 <code>Product.Api</code> 作为产品服务，代码结构与 <code>Order.Api</code> 结构类似：</p>
<p><img src="../../images/2021-09-19-01-07-00.png" alt=""></p>
<h2 id="ProductsController-cs">ProductsController.cs</h2>
<p>增加减库存接口：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCore.CAP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Product.Api.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Product.Api.Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;[Controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration configuration;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ICapPublisher capBus;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ProductContext context;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">IConfiguration configuration, ICapPublisher capBus, ProductContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">            <span class="keyword">this</span>.capBus = capBus;</span><br><span class="line">            <span class="keyword">this</span>.context = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> result = <span class="string">$&quot;产品服务：<span class="subst">&#123;DateTime.Now:yyyy-MM-dd HH:mm:ss&#125;</span>,-<span class="subst">&#123;Request.HttpContext.Connection.LocalIpAddress&#125;</span>:<span class="subst">&#123;configuration[<span class="string">&quot;ConsulSetting:ServicePort&quot;</span>]&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> Ok(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 减库存 订阅下单事件</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">NonAction</span>]</span><br><span class="line">        [<span class="meta">CapSubscribe(<span class="meta-string">&quot;order.services.createorder&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">ReduceStock</span>(<span class="params">CreateOrderMessageDto message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;message:&quot;</span> + JsonConvert.SerializeObject(message));</span><br><span class="line">            <span class="keyword">var</span> product = <span class="keyword">await</span> context.Products.FirstOrDefaultAsync(p =&gt; p.ID == message.ProductID);</span><br><span class="line">            product.Stock -= message.Count;</span><br><span class="line">            <span class="keyword">await</span> context.SaveChangesAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="CreateOrderMessageDto-cs">CreateOrderMessageDto.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Product.Api.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 下单事件消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateOrderMessageDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 产品ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ProductID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 购买数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Count &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Product-cs">Product.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Product.Api.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 产品名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">Column(TypeName = <span class="meta-string">&quot;VARCHAR(16)&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 库存</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Stock &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ProductContext-cs">ProductContext.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Product.Api</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProductContext</span>(<span class="params">DbContextOptions&lt;ProductContext&gt; options</span>)</span></span><br><span class="line"><span class="function">           : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Models.Product&gt; Products &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//初始化种子数据</span></span><br><span class="line">            modelBuilder.Entity&lt;Models.Product&gt;().HasData(<span class="keyword">new</span> Models.Product</span><br><span class="line">            &#123;</span><br><span class="line">                ID = <span class="number">1</span>,</span><br><span class="line">                Name = <span class="string">&quot;ThinkPad&quot;</span>,</span><br><span class="line">                Stock = <span class="number">100</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">new</span> Models.Product</span><br><span class="line">            &#123;</span><br><span class="line">                ID = <span class="number">2</span>,</span><br><span class="line">                Name = <span class="string">&quot;Mac&quot;</span>,</span><br><span class="line">                Stock = <span class="number">100</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="appsettings-json">appsettings.json</h2>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;Default&quot;</span>: <span class="string">&quot;Information&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Microsoft&quot;</span>: <span class="string">&quot;Warning&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Microsoft.Hosting.Lifetime&quot;</span>: <span class="string">&quot;Information&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;ConsulSetting&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ServiceName&quot;</span>: <span class="string">&quot;product.service&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ServiceIP&quot;</span>: <span class="string">&quot;192.168.31.191&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ServiceHealthCheck&quot;</span>: <span class="string">&quot;/healthcheck&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ConsulAddress&quot;</span>: <span class="string">&quot;http://192.168.31.191:8500&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;ConnectionString&quot;</span>: <span class="string">&quot;Server=192.168.31.210;Database=Microservice.Sample.Product;user id=sa;password=wpl19950815;MultipleActiveResultSets=true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Startup-cs">Startup.cs</h2>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">    services<span class="selector-class">.AddControllers</span>();</span><br><span class="line"></span><br><span class="line">    services<span class="selector-class">.AddDbContext</span>&lt;ProductContext&gt;(opt =&gt; opt<span class="selector-class">.UseSqlServer</span>(Configuration<span class="selector-attr">[<span class="string">&quot;ConnectionString&quot;</span>]</span>));</span><br><span class="line"></span><br><span class="line">    services<span class="selector-class">.AddCap</span>(x =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        x<span class="selector-class">.UseEntityFramework</span>&lt;ProductContext&gt;()<span class="selector-class">.UseRabbitMQ</span>(option =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            option<span class="selector-class">.HostName</span> = &quot;<span class="number">192.168</span>.<span class="number">31.191</span>&quot;;</span><br><span class="line">            option<span class="selector-class">.UserName</span> = &quot;guest&quot;;</span><br><span class="line">            option<span class="selector-class">.Password</span> = &quot;guest&quot;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Order-Api">Order.Api</h1>
<h2 id="OrdersController-cs">OrdersController.cs</h2>
<p>增加下单接口：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DotNetCore.CAP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Order.Api.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Order.Api.Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;[Controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrdersController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration configuration;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ICapPublisher capBus;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> OrderContext context;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OrdersController</span>(<span class="params">IConfiguration configuration, ICapPublisher capBus, OrderContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">            <span class="keyword">this</span>.capBus = capBus;</span><br><span class="line">            <span class="keyword">this</span>.context = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> result = <span class="string">$&quot;订单服务：<span class="subst">&#123;DateTime.Now:yyyy-MM-dd HH:mm:ss&#125;</span>,-<span class="subst">&#123;Request.HttpContext.Connection.LocalIpAddress&#125;</span>:<span class="subst">&#123;configuration[<span class="string">&quot;ConsulSetting:ServicePort&quot;</span>]&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> Ok(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建订单</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;order&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;Create&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreateOrder</span>(<span class="params">Models.Order order</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> trans = context.Database.BeginTransaction(capBus, autoCommit: <span class="literal">true</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                order.CreateTime = DateTime.Now;</span><br><span class="line">                context.Orders.Add(order);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">await</span> context.SaveChangesAsync() &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 发布下单事件</span></span><br><span class="line">                    <span class="keyword">await</span> capBus.PublishAsync(<span class="string">&quot;order.services.createorder&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> CreateOrderMessageDto() &#123; Count = order.Count, ProductID = order.ProductID &#125;);</span><br><span class="line">                    <span class="keyword">return</span> Ok();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> BadRequest();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="CreateOrderMessageDto-cs-v2">CreateOrderMessageDto.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Order.Api.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 下单事件消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateOrderMessageDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 产品ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ProductID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 购买数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Count &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Order-cs">Order.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Order.Api.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Order</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 下单时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> DateTime CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 产品ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ProductID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 购买数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Count &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OrderContext-cs">OrderContext.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Order.Api</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OrderContext</span>(<span class="params">DbContextOptions&lt;OrderContext&gt; options</span>)</span></span><br><span class="line"><span class="function">           : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Models.Order&gt; Orders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="appsettings-json-v2">appsettings.json</h2>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;Default&quot;</span>: <span class="string">&quot;Information&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Microsoft&quot;</span>: <span class="string">&quot;Warning&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Microsoft.Hosting.Lifetime&quot;</span>: <span class="string">&quot;Information&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;ConsulSetting&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ServiceName&quot;</span>: <span class="string">&quot;order.service&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ServiceIP&quot;</span>: <span class="string">&quot;192.168.31.191&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ServiceHealthCheck&quot;</span>: <span class="string">&quot;/healthcheck&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ConsulAddress&quot;</span>: <span class="string">&quot;http://192.168.31.191:8500&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;ConnectionString&quot;</span>: <span class="string">&quot;Server=192.168.31.210;Database=Microservice.Sample.Order;user id=sa;password=wpl19950815;MultipleActiveResultSets=true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Startup-cs-v2">Startup.cs</h2>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    services.AddControllers();</span><br><span class="line"></span><br><span class="line">    services.AddDbContext&lt;OrderContext&gt;(opt =&gt; opt.UseSqlServer(Configuration[<span class="string">&quot;ConnectionString&quot;</span>]));</span><br><span class="line"></span><br><span class="line">    services.AddCap(x =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        x.UseEntityFramework&lt;OrderContext&gt;().UseRabbitMQ(option =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            option.HostName = <span class="string">&quot;192.168.31.191&quot;</span>;</span><br><span class="line">            option.UserName = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line">            option.Password = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/2021-09-19-01-20-20.png" alt=""></p>
<p>以上就是产品服务的新增以及订单服务的部分代码调整，功能很简单：各自添加自己的数据库表，订单服务增加下单接口，下单接口会发出“下单事件”。产品服务增加减库存接口，减库存接口会订阅“下单事件”。然后客户端调用下单接口下单时，产品服务会减去相应的库存。关于EF数据库迁移之类的基本使用不做介绍。</p>
<h1 id="重新构建镜像">重新构建镜像</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-01 dotnetcore_src]<span class="comment"># cd order.api.release/</span></span><br><span class="line">[root@centos-01 order.api.release]<span class="comment"># docker build -t order.api .</span></span><br><span class="line">Sending build context to Docker daemon  16.05MB</span><br><span class="line">Step 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base</span><br><span class="line"> ---&gt; a2be3e478ffa</span><br><span class="line">Step 2/4 : WORKDIR /app</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 9f551bd1698a</span><br><span class="line">Step 3/4 : COPY . /app</span><br><span class="line"> ---&gt; e19ab440e8a5</span><br><span class="line">Step 4/4 : ENTRYPOINT [<span class="string">&quot;dotnet&quot;</span>, <span class="string">&quot;Order.Api.dll&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 3d1e4110f02e</span><br><span class="line">Removing intermediate container 3d1e4110f02e</span><br><span class="line"> ---&gt; 06322a6c6e83</span><br><span class="line">Successfully built 06322a6c6e83</span><br><span class="line">Successfully tagged order.api:latest</span><br><span class="line"></span><br><span class="line">[root@centos-01 order.api.release]<span class="comment"># cd ../product.api.release/</span></span><br><span class="line">[root@centos-01 product.api.release]<span class="comment"># docker build -t product.api .</span></span><br><span class="line">Sending build context to Docker daemon  16.38MB</span><br><span class="line">Step 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base</span><br><span class="line"> ---&gt; a2be3e478ffa</span><br><span class="line">Step 2/4 : WORKDIR /app</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 9f551bd1698a</span><br><span class="line">Step 3/4 : COPY . /app</span><br><span class="line"> ---&gt; 6f6d08e02d78</span><br><span class="line">Step 4/4 : ENTRYPOINT [<span class="string">&quot;dotnet&quot;</span>, <span class="string">&quot;Product.Api.dll&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 7616a505741e</span><br><span class="line">Removing intermediate container 7616a505741e</span><br><span class="line"> ---&gt; 6be08521c6fe</span><br><span class="line">Successfully built 6be08521c6fe</span><br><span class="line">Successfully tagged product.api:latest</span><br></pre></td></tr></table></figure>
<p>运行订单服务，产品服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name order.api -p 80:80 order.api  --ConsulSetting:ServicePort=<span class="string">&quot;80&quot;</span></span><br><span class="line">docker run -d --name order.api1 -p 81:80 order.api --ConsulSetting:ServicePort=<span class="string">&quot;81&quot;</span></span><br><span class="line">docker run -d --name order.api2 -p 82:80 order.api --ConsulSetting:ServicePort=<span class="string">&quot;82&quot;</span></span><br><span class="line">docker run -d --name product.api -p 85:80 product.api --ConsulSetting:ServicePort=<span class="string">&quot;85&quot;</span></span><br><span class="line">docker run -d --name product.api1 -p 86:80 product.api --ConsulSetting:ServicePort=<span class="string">&quot;86&quot;</span></span><br><span class="line">docker run -d --name product.api2 -p 87:80 product.api --ConsulSetting:ServicePort=<span class="string">&quot;87&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="../../images/2021-09-19-01-51-19.png" alt=""></p>
<p><code>ocelot.json</code> 增加路由配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Routes&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 路由规则匹配</span></span><br><span class="line">      <span class="attr">&quot;DownstreamPathTemplate&quot;</span>: <span class="string">&quot;/orders/&#123;url&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DownstreamScheme&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UpstreamPathTemplate&quot;</span>: <span class="string">&quot;/orders/&#123;url&#125;&quot;</span>,</span><br><span class="line">      <span class="comment">// 增加Post请求</span></span><br><span class="line">      <span class="attr">&quot;UpstreamHttpMethod&quot;</span>: [ <span class="string">&quot;Get&quot;</span>, <span class="string">&quot;Post&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;ServiceName&quot;</span>: <span class="string">&quot;order.service&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;LoadBalancerOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RoundRobin&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 缓存</span></span><br><span class="line">      <span class="attr">&quot;FileCacheOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;TtlSeconds&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;Region&quot;</span>: <span class="string">&quot;regionname&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 限流</span></span><br><span class="line">      <span class="attr">&quot;RateLimitOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ClientWhitelist&quot;</span>: [ <span class="string">&quot;SuperClient&quot;</span> ],</span><br><span class="line">        <span class="attr">&quot;EnableRateLimiting&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;Period&quot;</span>: <span class="string">&quot;2s&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;PeriodTimespan&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;Limit&quot;</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 超时熔断</span></span><br><span class="line">      <span class="attr">&quot;QoSOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ExceptionsAllowedBeforeBreaking&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;DurationOfBreak&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">        <span class="attr">&quot;TimeoutValue&quot;</span>: <span class="number">5000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;DownstreamPathTemplate&quot;</span>: <span class="string">&quot;/products&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;DownstreamScheme&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UpstreamPathTemplate&quot;</span>: <span class="string">&quot;/products&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;UpstreamHttpMethod&quot;</span>: [ <span class="string">&quot;Get&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;ServiceName&quot;</span>: <span class="string">&quot;product.service&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;LoadBalancerOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RoundRobin&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 缓存</span></span><br><span class="line">      <span class="attr">&quot;FileCacheOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;TtlSeconds&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;Region&quot;</span>: <span class="string">&quot;regionname&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 限流</span></span><br><span class="line">      <span class="attr">&quot;RateLimitOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ClientWhitelist&quot;</span>: [ <span class="string">&quot;SuperClient&quot;</span> ],</span><br><span class="line">        <span class="attr">&quot;EnableRateLimiting&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;Period&quot;</span>: <span class="string">&quot;2s&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;PeriodTimespan&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;Limit&quot;</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 超时熔断</span></span><br><span class="line">      <span class="attr">&quot;QoSOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ExceptionsAllowedBeforeBreaking&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;DurationOfBreak&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">        <span class="attr">&quot;TimeoutValue&quot;</span>: <span class="number">5000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;GlobalConfiguration&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;BaseUrl&quot;</span>: <span class="string">&quot;http://localhost:5000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ServiceDiscoveryProvider&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;Scheme&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Host&quot;</span>: <span class="string">&quot;192.168.31.191&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Port&quot;</span>: <span class="number">8500</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;Consul&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;RateLimitOptions&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;DisableRateLimitHeaders&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;QuotaExceededMessage&quot;</span>: <span class="string">&quot;too many requests...&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;HttpStatusCode&quot;</span>: <span class="number">999</span>,</span><br><span class="line">      <span class="attr">&quot;ClientIdHeader&quot;</span>: <span class="string">&quot;Test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此整个环境就有点复杂了。要确保 SqlServer，RabbitMQ，Consul，服务实例、Gateway都正常运行：</p>
<p><img src="../../images/2021-09-19-02-13-24.png" alt=""></p>
<p><img src="../../images/2021-09-19-02-00-46.png" alt=""></p>
<p><img src="../../images/2021-09-19-02-01-06.png" alt=""></p>
<p><code>cap.published</code> 表和 <code>cap.received</code> 表由 <code>CAP</code> 自动生成，内部使用本地消息表+MQ来实现异步确保。</p>
<h1 id="测试">测试</h1>
<p>使用Postman作为客户端调用下单接口（5000是Ocelot网关端口）：</p>
<p><img src="../../images/2021-09-19-02-19-58.png" alt=""></p>
<p>订单库：<br>
<img src="../../images/2021-09-19-02-30-39.png" alt=""></p>
<p>产品库：<br>
<img src="../../images/2021-09-19-02-30-59.png" alt=""></p>
<p>至此虽然功能很简单，但是实现了服务的解耦，异步调用，和最终一致性。要注意的是：</p>
<ol>
<li>这里的事务是指：订单持久化到数据库/和下单事件保存到 <code>cap.published</code>表（保存到 <code>cap.published</code> 表理论上代表消息正常发送到MQ），要么一同成功，要么一同失败。如果这个事务成功，那么就可以认为这个业务流程是成功的</li>
<li>产品服务的减库存是否成功那是产品服务的事，理论上也应该是成功的。因为消息已经确保发到了MQ，产品服务必然会收到消息。CAP也提供了失败重试，和失败回调机制，要理解 “CAP 是基于MQ加本地消息表来实现异步确保”</li>
<li>如果下单成功但是库存不足导致减库存失败了怎么办，是否需要回滚订单表的数据？如果产生这种想法，说明还没有真正理解最终一致性的思想。首先下单前肯定会检查一下库存数量，既然允许下单那么必然是库存充足的。（高并发下保证不超卖是另一个问题这里不考虑）如果非要数据回滚也是能实现的，CAP的 <code>ICapPublisher.Publish</code> 方法提供一个<code>callbackName</code> 参数，当减库存时，可以触发这个回调。其本质也是通过发布订阅完成，但不推荐</li>
<li>CAP无法保证消息不重复，实际使用中需要自己考虑一下实现消息的重复过滤和幂等</li>
</ol>

</article>

<div id="paginator">
  
</div>

                  <script src="https://utteranc.es/client.js" repo="wangpengliang815/blog-comments"
                    issue-term="pathname" label="issue" theme="github-light" crossorigin="anonymous" async>
                    </script>
              </div>
            </div>
            <div class="column col-2 hide-lg">
              <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="W"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Wang,PengLiang</div>
      <div>2021-09-19</div>
    </div>
  </div>

  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
            </div>
          </div>

        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>

  </body>

</html>


<script src="/js/book.js"></script>
