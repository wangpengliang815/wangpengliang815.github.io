<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="背景介绍# 借助一个Redis实例来学习 Docker Swarm，背景：standalone 部署模式故障转移机制：独立部署 Redis ，借助 docker swarm 故障转移机制做到基本HA，多节点的Redis通过 NFS 实现容器数据共享。
环境准备# 独立的 NFS 服务器
192.168.158.143 部署NFS服务 Swarm 集群由 管理节点 和 工作节点 组成。这里创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群
IP IsManager 192.168.158.144 Yes 192.168.158.145 ​ 192.168.158.146 Docker Swarm# Docker Swarm 是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。
注意：Docker 1.12.0&#43; Swarm mode 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm，Docker 引擎 API 已经删除 Docker Swarm
Swarm mode 内置 kv 存储功能，提供了众多新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/posts/docker/2.1dockerswarm/">
  <meta property="og:site_name" content="CODE&#39;NOTE">
  <meta property="og:title" content="CODE&#39;NOTE">
  <meta property="og:description" content="背景介绍# 借助一个Redis实例来学习 Docker Swarm，背景：standalone 部署模式故障转移机制：独立部署 Redis ，借助 docker swarm 故障转移机制做到基本HA，多节点的Redis通过 NFS 实现容器数据共享。
环境准备# 独立的 NFS 服务器
192.168.158.143 部署NFS服务 Swarm 集群由 管理节点 和 工作节点 组成。这里创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群
IP IsManager 192.168.158.144 Yes 192.168.158.145 ​ 192.168.158.146 Docker Swarm# Docker Swarm 是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。
注意：Docker 1.12.0&#43; Swarm mode 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm，Docker 引擎 API 已经删除 Docker Swarm
Swarm mode 内置 kv 存储功能，提供了众多新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">


  <meta itemprop="name" content="CODE&#39;NOTE">
  <meta itemprop="description" content="背景介绍# 借助一个Redis实例来学习 Docker Swarm，背景：standalone 部署模式故障转移机制：独立部署 Redis ，借助 docker swarm 故障转移机制做到基本HA，多节点的Redis通过 NFS 实现容器数据共享。
环境准备# 独立的 NFS 服务器
192.168.158.143 部署NFS服务 Swarm 集群由 管理节点 和 工作节点 组成。这里创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群
IP IsManager 192.168.158.144 Yes 192.168.158.145 ​ 192.168.158.146 Docker Swarm# Docker Swarm 是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。
注意：Docker 1.12.0&#43; Swarm mode 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm，Docker 引擎 API 已经删除 Docker Swarm
Swarm mode 内置 kv 存储功能，提供了众多新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。">
  <meta itemprop="wordCount" content="885">

<title>2.1 Docker Swarm | CODE&#39;NOTE</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/posts/docker/2.1dockerswarm/">
<link rel="stylesheet" href="/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css" integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG&#43;T2l66Bw7pV8=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.3ed9c79c605914c45e19db90edfda0ca8d87c63064c1d6252862250c4e917346.js" integrity="sha256-PtnHnGBZFMReGduQ7f2gyo2HxjBkwdYlKGIlDE6Rc0Y=" crossorigin="anonymous"></script>



  
</head>
<body dir="ltr" class="book-kind-page book-type-posts">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>CODE&#39;NOTE</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="Search"
    aria-label="Search"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>
























</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>2.1 Docker Swarm</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#节点">节点</a></li>
    <li><a href="#服务和任务">服务和任务</a></li>
  </ul>

  <ul>
    <li><a href="#服务端nfs配置">服务端NFS配置</a></li>
    <li><a href="#客户端nfs配置">客户端NFS配置</a></li>
  </ul>

  <ul>
    <li><a href="#创建集群">创建集群</a></li>
    <li><a href="#更改节点可用性">更改节点可用性</a></li>
    <li><a href="#查看集群状态">查看集群状态</a></li>
    <li><a href="#解散集群">解散集群</a></li>
  </ul>

  <ul>
    <li><a href="#redis配置共享">Redis配置共享</a></li>
    <li><a href="#redis服务部署">Redis服务部署</a></li>
  </ul>

  <ul>
    <li><a href="#基本功能测试">基本功能测试</a></li>
    <li><a href="#故障转移测试">故障转移测试</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h1>
    2.1 Docker Swarm
  </h1>
  


  

  


  <div class="book-post-content markdown-inner"><h1 id="背景介绍">背景介绍<a class="anchor" href="#%e8%83%8c%e6%99%af%e4%bb%8b%e7%bb%8d">#</a></h1>
<p>借助一个Redis实例来学习 <code>Docker Swarm</code>，背景：<code>standalone</code> 部署模式故障转移机制：独立部署 <code>Redis</code> ，借助 <code>docker swarm</code> 故障转移机制做到基本HA，多节点的Redis通过 <code>NFS</code> 实现容器数据共享。</p>
<h1 id="环境准备">环境准备<a class="anchor" href="#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87">#</a></h1>
<p>独立的 <code>NFS</code> 服务器</p>
<table>
  <thead>
      <tr>
          <th>192.168.158.143</th>
          <th>部署NFS服务</th>
      </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<p><code>Swarm</code> 集群由 <strong>管理节点</strong> 和 <strong>工作节点</strong> 组成。这里创建一个包含一个管理节点和两个工作节点的最小 <code>Swarm</code> 集群</p>
<table>
  <thead>
      <tr>
          <th>IP</th>
          <th>IsManager</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>192.168.158.144</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>192.168.158.145</td>
          <td>​</td>
      </tr>
      <tr>
          <td>192.168.158.146</td>
          <td></td>
      </tr>
  </tbody>
</table>
<h1 id="docker-swarm">Docker Swarm<a class="anchor" href="#docker-swarm">#</a></h1>
<p>Docker Swarm 是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。</p>
<blockquote class='book-hint '>
<p>注意：Docker 1.12.0+ <a href="https://docs.docker.com/engine/swarm/">Swarm mode</a> 已经内嵌入 Docker 引擎，成为了 docker 子命令 <code>docker swarm</code>，Docker 引擎 API 已经删除 Docker Swarm</p>
</blockquote><p><code>Swarm mode</code> 内置 kv 存储功能，提供了众多新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。</p>
<p><code>Swarm</code> 是使用 <code>[SwarmKit](https://github.com/docker/swarmkit/)</code> 构建的 Docker 引擎内置（原生）的集群管理和编排工具。使用 <code>Swarm</code> 集群之前需要了解以下几个概念。</p>
<h2 id="节点">节点<a class="anchor" href="#%e8%8a%82%e7%82%b9">#</a></h2>
<p>运行 Docker 的主机可以主动初始化一个 <code>Swarm</code> 集群或者加入一个已存在的 <code>Swarm</code> 集群，这样这个运行 Docker 的主机就成为一个 <code>Swarm</code> 集群的节点 (<code>node</code>) 。节点分为管理 (<code>manager</code>) 节点和工作 (<code>worker</code>) 节点。管理节点用于 <code>Swarm</code> 集群的管理，<code>docker swarm</code> 命令基本只能在管理节点执行（节点退出集群命令 <code>docker swarm leave</code> 可以在工作节点执行）。一个 <code>Swarm</code> 集群可以有多个管理节点，但只有一个管理节点可以成为 <code>leader</code>，<code>leader</code> 通过 <code>raft</code> 协议实现。工作节点是任务执行节点，管理节点将服务 (<code>service</code>) 下发至工作节点执行。管理节点默认也作为工作节点。也可以通过配置让服务只运行在管理节点。</p>
<p><strong>集群中管理节点与工作节点的关系</strong></p>
<p><img src="/images/2021-09-09-16-46-11.png" alt="" /></p>
<h2 id="服务和任务">服务和任务<a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e5%92%8c%e4%bb%bb%e5%8a%a1">#</a></h2>
<p>任务 （<code>Task</code>）是 <code>Swarm</code> 中的最小的调度单位，目前来说就是一个单一的容器。服务 （<code>Services</code>） 是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>
<ul>
<li><code>replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务</li>
<li><code>global services</code> 每个工作节点上运行一个任务</li>
</ul>
<p>两种模式通过 <code>docker service create</code> 的 <code>--mode</code> 参数指定。</p>
<p><strong>容器/任务/服务的关系</strong></p>
<p><img src="/images/2021-09-09-16-46-39.png" alt="" /></p>
<h1 id="nfs-服务搭建">NFS 服务搭建<a class="anchor" href="#nfs-%e6%9c%8d%e5%8a%a1%e6%90%ad%e5%bb%ba">#</a></h1>
<p><strong>服务端</strong>： <code>192.168.158.143</code>安装 <code>nfs-server</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum -y install rpcbind nfs-utils
</span></span><span style="display:flex;"><span>systemctl start rpcbind
</span></span><span style="display:flex;"><span>systemctl enable rpcbind
</span></span><span style="display:flex;"><span>systemctl start nfs-server　　//NFS依赖rpcbind进行通讯，所以要先启动rpcbind
</span></span><span style="display:flex;"><span>systemctl enable nfs-server</span></span></code></pre></div><p><strong>客户端</strong> ：<code>192.168.158.145/192.168.158.146</code> 安装 <code>nfs-utils</code>，这里管理节点 <code>192.168.158.144</code> 并不打算部署服务故不需要安装<code>nfs-utils</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum -y install nfs-utils</span></span></code></pre></div><p>创建共享目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>//服务端
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 /<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir -p /mnt/nfs_file/redis </span>
</span></span><span style="display:flex;"><span>//客户端
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 /<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir -p /mnt/nfs_file/redis </span></span></span></code></pre></div><h2 id="服务端nfs配置">服务端NFS配置<a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e7%ab%afnfs%e9%85%8d%e7%bd%ae">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/exports</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/mnt/nfs_file/ 192.168.158.143/24<span style="color:#f92672">(</span>rw,sync,no_root_squash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//ro只读权限
</span></span><span style="display:flex;"><span>//rw读写权限
</span></span><span style="display:flex;"><span>//sync同步写入内存与磁盘当中
</span></span><span style="display:flex;"><span>//no_all_squash保留共享文件的UID和GID（默认）
</span></span><span style="display:flex;"><span>//no_root_squash使得root用户具有根目录的完全访问权限</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vi /etc/exports</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /etc/exports</span>
</span></span><span style="display:flex;"><span>/mnt/nfs_file/ 192.168.57.0/24<span style="color:#f92672">(</span>rw,sync,no_root_squash<span style="color:#f92672">)</span></span></span></code></pre></div><p>配置生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># exportfs -rv</span>
</span></span><span style="display:flex;"><span>exporting 192.168.158.143/24:/mnt/nfs_file</span></span></code></pre></div><h2 id="客户端nfs配置">客户端NFS配置<a class="anchor" href="#%e5%ae%a2%e6%88%b7%e7%ab%afnfs%e9%85%8d%e7%bd%ae">#</a></h2>
<p>关联服务器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount -t nfs 192.168.158.143:/mnt/nfs_file /mnt/nfs_file</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>//挂载测试
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># showmount -e 192.168.158.143</span>
</span></span><span style="display:flex;"><span>Export list <span style="color:#66d9ef">for</span> 192.168.158.143:
</span></span><span style="display:flex;"><span>/mnt/nfs_file 192.168.158.143/24</span></span></code></pre></div><p>备注：出现 <code>clnt_create:RPC:Port mapper failure - Unable to receive:error 113(NO route to host)</code> 报错时，需要关闭服务端与客户端之间的防火墙，或者开放NFS使用的2049端口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop firewalld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//添加规则<span style="color:#f92672">(</span>指定端口，--permanent永久生效，没有此参数重启后失效）
</span></span><span style="display:flex;"><span>//firewall-cmd --zone<span style="color:#f92672">=</span>public --add-port<span style="color:#f92672">=</span>2049/tcp --permanent</span></span></code></pre></div><h1 id="docker-集群搭建">Docker 集群搭建<a class="anchor" href="#docker-%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba">#</a></h1>
<h2 id="创建集群">创建集群<a class="anchor" href="#%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4">#</a></h2>
<p><strong>管理节点</strong>：<code>192.168.158.144</code> </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker swarm init</span>
</span></span><span style="display:flex;"><span>Swarm initialized: current node <span style="color:#f92672">(</span>khtc8jboe8dy7wm73x1cacnqf<span style="color:#f92672">)</span> is now a manager.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a worker to this swarm, run the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    docker swarm join --token SWMTKN-1-4fixdycxiue0273gkral83cn9bgqvkct13r9fo1k01iy6oaadm-e3rd668t3ww1b2w3e0xfxi8yo 192.168.158.144:2377
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a manager to this swarm, run <span style="color:#e6db74">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.</span></span></code></pre></div><p><strong>工作节点1</strong>：<code>192.168.158.145</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  docker swarm join --token SWMTKN-1-4fixdycxiue0273gkral83cn9bgqvkct13r9fo1k01iy6oaadm-e3rd668t3ww1b2w3e0xfxi8yo 192.168.158.144:2377</span>
</span></span><span style="display:flex;"><span>This node joined a swarm as a worker.</span></span></code></pre></div><p><strong>工作节点2</strong>：<code>192.168.158.146</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker swarm join --token SWMTKN-1-4fixdycxiue0273gkral83cn9bgqvkct13r9fo1k01iy6oaadm-e3rd668t3ww1b2w3e0xfxi8yo 192.168.158.144:2377</span>
</span></span><span style="display:flex;"><span>This node joined a swarm as a worker.</span></span></code></pre></div><h2 id="更改节点可用性">更改节点可用性<a class="anchor" href="#%e6%9b%b4%e6%94%b9%e8%8a%82%e7%82%b9%e5%8f%af%e7%94%a8%e6%80%a7">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker node ls</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>0aw4rk8kwos84yi0ca57q5pcq     centos-01   Ready     Active                          20.10.6<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>579nqzz3p512aobe6mp4g93ep     centos-01   Ready     Active                          20.10.6<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>khtc8jboe8dy7wm73x1cacnqf *   centos-01   Ready     Active         Leader           20.10.6<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker node update --availability drain khtc8jboe8dy7wm73x1cacnqf</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>khtc8jboe8dy7wm73x1cacnqf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker node ls</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>0aw4rk8kwos84yi0ca57q5pcq     centos-01   Ready     Active                          20.10.6<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>579nqzz3p512aobe6mp4g93ep     centos-01   Ready     Active                          20.10.6<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>khtc8jboe8dy7wm73x1cacnqf *   centos-01   Ready     Drain          Leader           20.10.6</span></span></code></pre></div><h2 id="查看集群状态">查看集群状态<a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e9%9b%86%e7%be%a4%e7%8a%b6%e6%80%81">#</a></h2>
<p><code>192.168.158.144</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker node ls</span>
</span></span><span style="display:flex;"><span>ID                            HOSTNAME    STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
</span></span><span style="display:flex;"><span>0aw4rk8kwos84yi0ca57q5pcq     centos-01   Ready     Active                          20.10.6
</span></span><span style="display:flex;"><span>579nqzz3p512aobe6mp4g93ep     centos-01   Ready     Active                          20.10.6
</span></span><span style="display:flex;"><span>khtc8jboe8dy7wm73x1cacnqf *   centos-01   Ready     Active         Leader           20.10.6</span></span></code></pre></div><h2 id="解散集群">解散集群<a class="anchor" href="#%e8%a7%a3%e6%95%a3%e9%9b%86%e7%be%a4">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span>docker swarm leave                       <span style="color:#75715e"># 工作节点：主动离开集群，让节点处于down状态，才能删除</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>docker node rm g36lvv23ypjd8v7ovlst2n3yt <span style="color:#75715e"># 管理节点：删除指定节点</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>docker swarm leave --force               <span style="color:#75715e"># 管理节点：解散集群</span></span></span></code></pre></div><h1 id="redis部署">Redis部署<a class="anchor" href="#redis%e9%83%a8%e7%bd%b2">#</a></h1>
<p><code>standalone</code> 部署模式区别于传统 <code>Redis Cluster</code> 部署，首先需要借助 <code>NFS</code> 实现多主机 <code>Redis配置和持久化数据共享</code> 借助 <code>Docker Swarm</code> 的故障转移机制来达到 <code>基本的HA</code>。</p>
<h2 id="redis配置共享">Redis配置共享<a class="anchor" href="#redis%e9%85%8d%e7%bd%ae%e5%85%b1%e4%ba%ab">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cd /mnt/nfs_file/redis/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">[</span>root@centos-01 redis<span style="color:#f92672">]</span><span style="color:#75715e"># ls</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.conf</span></span></code></pre></div><blockquote class='book-hint '>
<p>备注：<code>redis.conf</code> 需要关闭 <code>Cluster-Enable</code> </p>
</blockquote><h2 id="redis服务部署">Redis服务部署<a class="anchor" href="#redis%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service create -p 6379:6379 --name redis --mount type=bind,src=/mnt/nfs_file/redis/redis.conf,dst=/etc/redis/redis.conf --mount type=bind,src=/mnt/nfs_file/redis,dst=/data redis redis-server /etc/redis/redis.conf --appendonly yes</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>gc4q2nrqwp6qbimjwy3un0lmn<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>verify: Service converged </span></span></code></pre></div><p><code>Docker Swarm</code> 会随机选择一个工作节点（这里是 <code>192.168.158.145</code> ）部署 一个<code>Redis</code>容器。</p>
<h1 id="查看运行服务">查看运行服务<a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e8%bf%90%e8%a1%8c%e6%9c%8d%e5%8a%a1">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service ls</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ID             NAME      MODE         REPLICAS   IMAGE          PORTS<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>gc4q2nrqwp6q   redis     replicated   1/1        redis:latest   *:6379-&gt;6379/tcp</span></span></code></pre></div><h1 id="查看服务详情"> 查看服务详情<a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e6%9c%8d%e5%8a%a1%e8%af%a6%e6%83%85">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service  ps redis </span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ID             NAME      IMAGE          NODE        DESIRED STATE   CURRENT STATE           ERROR     PORTS<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>zf137g379xj6   redis.1   redis:latest   centos-01   Running         Running <span style="color:#ae81ff">3</span> minutes ago  </span></span></code></pre></div><h1 id="查看服务日志">查看服务日志<a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e6%9c%8d%e5%8a%a1%e6%97%a5%e5%bf%97">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service logs redis </span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:C <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.388 <span style="color:#75715e"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:C <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.388 <span style="color:#75715e"># Redis version=6.2.4, bits=64, commit=00000000, modified=0, pid=1, just started</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:C <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.389 <span style="color:#75715e"># Configuration loaded</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.389 * monotonic clock: POSIX clock_gettime<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.391 <span style="color:#75715e"># Warning: Could not create server TCP listening socket ::1:6379: bind: Cannot assign requested address</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.393 * Running mode<span style="color:#f92672">=</span>standalone, port<span style="color:#f92672">=</span>6379.<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.394 <span style="color:#75715e"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.394 <span style="color:#75715e"># Server initialized</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.394 <span style="color:#75715e"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory = 1&#39; to /etc/sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory=1&#39; for this to take effect.</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>redis.1.zf137g379xj6@centos-01    | 1:M <span style="color:#ae81ff">16</span> Jul <span style="color:#ae81ff">2021</span> 05:46:38.396 * Ready to accept connections</span></span></code></pre></div><p>这里保证只有一个 <code>Redis</code> 容器运行（<code>standalone</code> 部署）,所以不需要使用 <code>--replicas number</code> 。 关于<strong>服务动态伸缩</strong>/<strong>服务更新与回滚</strong>/<strong>滚动更新</strong>等相关知识参考：https://www.bookstack.cn/read/docker_practice-v1.1.0/swarm_mode-README.md。</p>
<h1 id="删除服务">删除服务<a class="anchor" href="#%e5%88%a0%e9%99%a4%e6%9c%8d%e5%8a%a1">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span>docker service rm redis</span></span></code></pre></div><h1 id="测试">测试<a class="anchor" href="#%e6%b5%8b%e8%af%95">#</a></h1>
<h2 id="基本功能测试">基本功能测试<a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e5%8a%9f%e8%83%bd%e6%b5%8b%e8%af%95">#</a></h2>
<p>使用 <code>RedisClient</code> 连接Redis <code>192.168.158.146</code> </p>
<p><img src="/images/2021-09-09-16-52-30.png" alt="" /></p>
<h2 id="故障转移测试">故障转移测试<a class="anchor" href="#%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb%e6%b5%8b%e8%af%95">#</a></h2>
<p>这里手动将 <code>192.168.158.146</code> Redis容器停止，查看Swarm会怎么处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker ps -a</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS      NAMES
</span></span><span style="display:flex;"><span>9855ebf35829   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago   Up <span style="color:#ae81ff">4</span> minutes   6379/tcp   redis.1.vys54q07u7egrmc64rnn2frj4
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker stop redis.1.vys54q07u7egrmc64rnn2frj4 </span>
</span></span><span style="display:flex;"><span>redis.1.vys54q07u7egrmc64rnn2frj4
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker ps -a</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS                     PORTS     NAMES
</span></span><span style="display:flex;"><span>9855ebf35829   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago   Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">4</span> seconds ago             redis.1.vys54q07u7egrmc64rnn2frj4</span></span></code></pre></div><p>发现 <code>192.168.158.145</code> 上启动了一个新的Redis容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker ps -a</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS         PORTS      NAMES
</span></span><span style="display:flex;"><span>ef95253a0d79   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">16</span> seconds ago   Up <span style="color:#ae81ff">9</span> seconds   6379/tcp   redis.1.jb9b26y4ikj8vc1k04j2gj35w</span></span></code></pre></div><p>管理节点中查看服务运行情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service ps redis </span>
</span></span><span style="display:flex;"><span>ID             NAME          IMAGE          NODE        DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>jb9b26y4ikj8   redis.1       redis:latest   centos-01   Running         Running <span style="color:#ae81ff">2</span> minutes ago              
</span></span><span style="display:flex;"><span>vys54q07u7eg    <span style="color:#ae81ff">\_</span> redis.1   redis:latest   centos-01   Shutdown        Complete <span style="color:#ae81ff">2</span> minutes ago  </span></span></code></pre></div><p>发现 <code>Redis</code> 已经被转移到了<code>192.168.158.145</code> 使用 <code>RedisClient</code> 连接<code>192.168.158.145</code> 使用 <code>get name</code> 发现可以找到数据，说明Redis容器的数据共享是没问题的。一旦某个节点挂掉，Swarm会自动转移到其他可用的工作节点，结合NFS的文件共享就可以实现Redis独立部署但拥有基本的HA。</p>
<p><img src="/images/2021-09-09-16-53-04.png" alt="" /></p>
<h1 id="portainer可视化">Portainer可视化<a class="anchor" href="#portainer%e5%8f%af%e8%a7%86%e5%8c%96">#</a></h1>
<p>在 <code>192.168.158.1434</code> 管理节点上运行 Portainer 容器。</p>
<p><img src="/images/2021-09-09-16-53-29.png" alt="" /></p>
</div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">
  <div>
  
    <a href="/posts/docker/2.0dockermachine/" class="flex align-center">
      <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
      <span>2.0 Docker Machine</span>
    </a>
  
  </div>
  <div>
  
    <a href="/posts/docker/2.2docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="flex align-center">
      <span>2.2 Docker常用命令</span>
      <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
    </a>
  
  </div>
</div>
 
        
  
 
        
        
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
  <aside class="book-toc">
    <div class="book-toc-content">
      
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#节点">节点</a></li>
    <li><a href="#服务和任务">服务和任务</a></li>
  </ul>

  <ul>
    <li><a href="#服务端nfs配置">服务端NFS配置</a></li>
    <li><a href="#客户端nfs配置">客户端NFS配置</a></li>
  </ul>

  <ul>
    <li><a href="#创建集群">创建集群</a></li>
    <li><a href="#更改节点可用性">更改节点可用性</a></li>
    <li><a href="#查看集群状态">查看集群状态</a></li>
    <li><a href="#解散集群">解散集群</a></li>
  </ul>

  <ul>
    <li><a href="#redis配置共享">Redis配置共享</a></li>
    <li><a href="#redis服务部署">Redis服务部署</a></li>
  </ul>

  <ul>
    <li><a href="#基本功能测试">基本功能测试</a></li>
    <li><a href="#故障转移测试">故障转移测试</a></li>
  </ul>
</nav>



    </div>
  </aside>
  
 
  </main>

  
</body>
</html>




















