<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="测试代码：https://github.com/wangpengliang815/CodeSnippet/tree/master/CommonLib/CommonLib
参考文档：https://www.bookstack.cn/books/StackExchange.Redis-docs-cn
客户端# ServiceStack.Redis 是商业版，免费版有限制 StackExchange.Redis 是免费版，但是内核在 .NETCore 运行有问题经常 Timeout，暂无法解决 csRedis于2016年开始支持.NETCore一直迭代至今，实现了低门槛、高性能，和分区高级玩法的.NETCore redis-cli SDK ServiceStack.Redis# 商业版，免费版有限制。放弃。
StackExchange.Redis# 安装# StackExchange.Redis 是 C# 操作 Redis 数据库的客户端。在 NuGet 中搜索 StackExchange.Redis ，直接点击按钮安装即可。
封装# RedisHelper
namespace CommonLib { using Newtonsoft.Json; using StackExchange.Redis; using System; using System.Collections.Generic; using System.Linq; using System.Threading.Tasks; /// &lt;summary&gt; /// 基于StackExchange.Redis封装的Helper /// /// &lt;/summary&gt; public class RedisHelper { /// &lt;summary&gt; /// 自定义缓存Key前缀 /// &lt;/summary&gt; /// &lt;value&gt; /// The custom key prefix. /// &lt;/value&gt; private string CustomKeyPrefix { get; } /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private readonly ConnectionMultiplexer conn; /// &lt;summary&gt; /// Redis数据库对象 /// &lt;/summary&gt; public readonly IDatabase db; /// &lt;summary&gt; /// Initializes a new instance of the &lt;see cref=&#34;RedisHelper&#34;/&gt; class. /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;param name=&#34;redisConnectionString&#34;&gt;The redis connection string.&lt;/param&gt; /// &lt;param name=&#34;customKeyPrefix&#34;&gt;The custom key prefix.&lt;/param&gt; public RedisHelper(int dbSerialNumber , string redisConnectionString , string customKeyPrefix = null) { CustomKeyPrefix = customKeyPrefix; #if customSingleton RedisConnectionMultiplexerHelper.RedisConnectionString = redisConnectionString; conn = RedisConnectionMultiplexerHelper.Instance; #endif conn = ConnectionMultiplexer.Connect(redisConnectionString); db = conn.GetDatabase(dbSerialNumber); } /// &lt;summary&gt; /// 保存单个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.StringSet(key, value, expiry); } /// &lt;summary&gt; /// 保存多个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;keyValues&#34;&gt;The key values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return db.StringSet(newkeyValues.ToArray()); } /// &lt;summary&gt; /// 以Json格式保存对象 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;object&#34;&gt;The object.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return db.StringSet(key, json, expiry); } /// &lt;summary&gt; /// 获取单个Key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public string StringGet(string key) { key = GenerateCustomKey(key); return db.StringGet(key); } /// &lt;summary&gt; /// 获取多个Key /// &lt;/summary&gt; /// &lt;param name=&#34;listKeys&#34;&gt;The list keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public RedisValue[] StringGet(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return db.StringGet(ConvertToRedisKeys(redisKeys)); } /// &lt;summary&gt; /// 获取value转换为Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T StringGet&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(db.StringGet(key)); } /// &lt;summary&gt; /// Increment,如果key存在,则:value&#43;=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double StringIncrement(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return db.StringIncrement(key, incrementVal); } /// &lt;summary&gt; /// Decrement,如果key存在,则:value-=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;减少后的值&lt;/returns&gt; public double StringDecrement(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return db.StringDecrement(key, decrementVal); } /// &lt;summary&gt; /// 判断hash中某个key是否已经被缓存 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashExists(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashExists(key, hashFieldName); } /// &lt;summary&gt; /// 存储数据到hash表 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;hashValue&#34;&gt;The hash value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashSet&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return db.HashSet(key, hashFieldName, json); } /// &lt;summary&gt; /// 移除hash中的某值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashDelete(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldName); } /// &lt;summary&gt; /// 移除hash中的多个值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldNames&#34;&gt;The hash field names.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long HashDelete(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldNames.ToArray()); } /// &lt;summary&gt; /// 从hash表获取数据 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T HashGet&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = db.HashGet(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// hash为数字增长value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashIncrement(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return db.HashIncrement(key, hashFieldName, incrementVal); } /// &lt;summary&gt; /// hash为数字减少value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashDecrement(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return db.HashDecrement(key, hashFieldName, decrementVal); } /// &lt;summary&gt; /// 获取hashkey所有rediskey /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; HashKeys&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.HashKeys(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 移除指定List内部的值 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; public void ListRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); db.ListRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 获取指定key的List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; ListRange&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.ListRange(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 入队：列表从最右边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListRightPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListRightPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出队：列表从最右边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListRightPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = db.ListRightPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 入栈：列表从最左边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLeftPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListLeftPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出栈：列表从最左边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListLeftPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = db.ListLeftPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 获取集合中的数量 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLength(string key) { key = GenerateCustomKey(key); return db.ListLength(key); } /// &lt;summary&gt; /// Sorteds the set add. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;score&#34;&gt;The score.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetAdd&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return db.SortedSetAdd(key, ConvertToJson&lt;T&gt;(value), score); } /// &lt;summary&gt; /// Sorteds the set remove. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.SortedSetRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// Sorteds the set range by rank. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;start&#34;&gt;The start.&lt;/param&gt; /// &lt;param name=&#34;stop&#34;&gt;The stop.&lt;/param&gt; /// &lt;param name=&#34;order&#34;&gt;The order.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; SortedSetRangeByRank&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = db.SortedSetRangeByRank(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// Sorteds the length of the set. /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long SortedSetLength(string key) { key = GenerateCustomKey(key); return db.SortedSetLength(key); } /// &lt;summary&gt; /// 删除单个key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyDelete(string key) { key = GenerateCustomKey(key); return db.KeyDelete(key); } /// &lt;summary&gt; /// 删除多个key /// &lt;/summary&gt; /// &lt;param name=&#34;keys&#34;&gt;The keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long KeyDelete(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return db.KeyDelete(ConvertToRedisKeys(newKeys)); } /// &lt;summary&gt; /// 判断key是否存储 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExists(string key) { key = GenerateCustomKey(key); return db.KeyExists(key); } /// &lt;summary&gt; /// 重命名key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;newKey&#34;&gt;The new key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyRename(string key, string newKey) { key = GenerateCustomKey(key); return db.KeyRename(key, newKey); } /// &lt;summary&gt; /// 设置Key过期时间 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExpire(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.KeyExpire(key, expiry); } /// &lt;summary&gt; /// Redis订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;subChannel&#34;&gt;The sub channel.&lt;/param&gt; /// &lt;param name=&#34;handler&#34;&gt;The handler.&lt;/param&gt; public void Subscribe(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); sub.Subscribe(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } /// &lt;summary&gt; /// Redis发布 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; /// &lt;param name=&#34;message&#34;&gt;The message.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long Publish&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return sub.Publish(channel, ConvertToJson(message)); } /// &lt;summary&gt; /// Redis取消订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; public void Unsubscribe(string channel) { ISubscriber sub = conn.GetSubscriber(); sub.Unsubscribe(channel); } /// &lt;summary&gt; /// Redis取消全部订阅 /// &lt;/summary&gt; public void UnsubscribeAll() { ISubscriber sub = conn.GetSubscriber(); sub.UnsubscribeAll(); } /// &lt;summary&gt; /// 创建一个Redis事务 /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public ITransaction CreateTransaction(int dbSerialNumber) { return conn.GetDatabase(dbSerialNumber).CreateTransaction(); } public async Task&lt;bool&gt; StringSetAsync(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.StringSetAsync(key, value, expiry); } public async Task&lt;bool&gt; StringSetAsync(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return await db.StringSetAsync(newkeyValues.ToArray()); } public async Task&lt;bool&gt; StringSetAsync&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return await db.StringSetAsync(key, json, expiry); } public async Task&lt;string&gt; StringGetAsync(string key) { key = GenerateCustomKey(key); return await db.StringGetAsync(key); } public async Task&lt;RedisValue[]&gt; StringGetAsync(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return await db.StringGetAsync(ConvertToRedisKeys(redisKeys)); } public async Task&lt;T&gt; StringGetAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(await db.StringGetAsync(key)); } public async Task&lt;double&gt; StringIncrementAsync(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.StringIncrementAsync(key, incrementVal); } public async Task&lt;double&gt; StringDecrementAsync(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.StringDecrementAsync(key, decrementVal); } public async Task&lt;bool&gt; HashExistsAsync(string key, string dataKey) { key = GenerateCustomKey(key); return await db.HashExistsAsync(key, dataKey); } public async Task&lt;bool&gt; HashSetAsync&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return await db.HashSetAsync(key, hashFieldName, json); } public async Task&lt;bool&gt; HashDeleteAsync(string key, string hashFieldName) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldName); } public async Task&lt;long&gt; HashDeleteAsync(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldNames.ToArray()); } public async Task&lt;T&gt; HashGetAsync&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = await db.HashGetAsync(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;double&gt; HashIncrementAsync(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.HashIncrementAsync(key, hashFieldName, incrementVal); } public async Task&lt;double&gt; HashDecrementAsync(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.HashDecrementAsync(key, hashFieldName, decrementVal); } public async Task&lt;List&lt;T&gt;&gt; HashKeysAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.HashKeysAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; ListRangeAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.ListRangeAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRightPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRightPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListRightPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = await db.ListRightPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLeftPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListLeftPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListLeftPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = await db.ListLeftPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLengthAsync(string key) { key = GenerateCustomKey(key); return await db.ListLengthAsync(key); } public async Task&lt;bool&gt; SortedSetAddAsync&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return await db.SortedSetAddAsync(key, ConvertToJson&lt;T&gt;(value), score); } public async Task&lt;bool&gt; SortedSetRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.SortedSetRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; SortedSetRangeByRankAsync&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = await db.SortedSetRangeByRankAsync(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; SortedSetLengthAsync(string key) { key = GenerateCustomKey(key); return await db.SortedSetLengthAsync(key); } public async Task&lt;bool&gt; KeyDeleteAsync(string key) { key = GenerateCustomKey(key); return await db.KeyDeleteAsync(key); } public async Task&lt;long&gt; KeyDeleteAsync(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return await db.KeyDeleteAsync(ConvertToRedisKeys(newKeys)); } public async Task&lt;bool&gt; KeyExistsAsync(string key) { key = GenerateCustomKey(key); return await db.KeyExistsAsync(key); } public async Task&lt;bool&gt; KeyRenameAsync(string key, string newKey) { key = GenerateCustomKey(key); return await db.KeyRenameAsync(key, newKey); } public async Task&lt;bool&gt; KeyExpireAsync(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.KeyExpireAsync(key, expiry); } public async Task SubscribeAsync(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); await sub.SubscribeAsync(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } public async Task&lt;long&gt; PublishAsync&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return await sub.PublishAsync(channel, ConvertToJson(message)); } public async Task UnsubscribeAsync(string channel) { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAsync(channel); } public async Task UnsubscribeAllAsync() { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAllAsync(); } /// &lt;summary&gt; /// 生成自定义Key,格式(CustomKeyPrefix&#43;&#34;_&#34;&#43;Key) /// &lt;/summary&gt; /// &lt;param name=&#34;oldKey&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private string GenerateCustomKey(string oldKey) { if (!string.IsNullOrWhiteSpace(CustomKeyPrefix)) { return $&#34;{CustomKeyPrefix}_{oldKey}&#34;; } return oldKey; } /// &lt;summary&gt; /// 对象序列化 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static string ConvertToJson&lt;T&gt;(T value) { return value is string ? value.ToString() : JsonConvert.SerializeObject(value); } /// &lt;summary&gt; /// RedisValue转Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static T ConvertToObject&lt;T&gt;(RedisValue value) { if (typeof(T).Name.Equals(typeof(string).Name)) { return JsonConvert.DeserializeObject&lt;T&gt;($&#34;&#39;{value}&#39;&#34;); } return JsonConvert.DeserializeObject&lt;T&gt;(value); } /// &lt;summary&gt; /// RedisValue转List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;values&#34;&gt;The values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static List&lt;T&gt; ConvetToList&lt;T&gt;(RedisValue[] values) { List&lt;T&gt; result = new(); foreach (RedisValue item in values) { T @object = ConvertToObject&lt;T&gt;(item); result.Add(@object); } return result; } /// &lt;summary&gt; /// 转换为RedisKey /// &lt;/summary&gt; /// &lt;param name=&#34;redisKeys&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static RedisKey[] ConvertToRedisKeys(List&lt;string&gt; redisKeys) { return redisKeys.Select(redisKey =&gt; (RedisKey)redisKey).ToArray(); } } /// &lt;summary&gt; /// 单例获取RedisConnectionMultiplexer /// &lt;/summary&gt; static class RedisConnectionMultiplexerHelper { /// &lt;summary&gt; /// Redis连接字符串 /// &lt;/summary&gt; public static string RedisConnectionString { get; set; } private static readonly object locker = new(); /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private static ConnectionMultiplexer connectionMultiplexerInstance; /// &lt;summary&gt; /// 单例获取 /// &lt;/summary&gt; public static ConnectionMultiplexer Instance { get { if (connectionMultiplexerInstance == null) { lock (locker) { if (connectionMultiplexerInstance == null || !connectionMultiplexerInstance.IsConnected) { connectionMultiplexerInstance = GetConnectionMultiplexer(); } } } return connectionMultiplexerInstance; } } private static ConnectionMultiplexer GetConnectionMultiplexer() { if (string.IsNullOrWhiteSpace(RedisConnectionString)) { throw new Exception(&#34;RedisConnectionString IsNullOrWhiteSpace!&#34;); } var connect = ConnectionMultiplexer.Connect(RedisConnectionString); connect.ConnectionFailed &#43;= MuxerConnectionFailed; connect.ConnectionRestored &#43;= MuxerConnectionRestored; connect.ErrorMessage &#43;= MuxerErrorMessage; connect.ConfigurationChanged &#43;= MuxerConfigurationChanged; connect.HashSlotMoved &#43;= MuxerHashSlotMoved; connect.InternalError &#43;= MuxerInternalError; return connect; } /// &lt;summary&gt; /// 配置更改时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConfigurationChanged(object sender, EndPointEventArgs e) { Console.WriteLine($&#34;Configuration changed: {e.EndPoint}&#34;); } /// &lt;summary&gt; /// 发生错误时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerErrorMessage(object sender, RedisErrorEventArgs e) { Console.WriteLine($&#34;ErrorMessage:{e.Message}&#34;); } /// &lt;summary&gt; /// 重新建立连接之前的错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionRestored(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;ConnectionRestored:{e.EndPoint}&#34;); } /// &lt;summary&gt; /// 连接失败,如果重新连接成功将不会收到这个通知 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionFailed(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;重新连接：Endpoint failed:{e.EndPoint},{e.FailureType},{e.Exception.Message}&#34;); } /// &lt;summary&gt; /// 更改集群 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerHashSlotMoved(object sender, HashSlotMovedEventArgs e) { Console.WriteLine($&#34;HashSlotMoved:NewEndPoint={e.NewEndPoint},OldEndPoint={ e.OldEndPoint}&#34;); } /// &lt;summary&gt; /// Redis类库错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerInternalError(object sender, InternalErrorEventArgs e) { Console.WriteLine($&#34;InternalError:Message={e.Exception.Message}&#34;); } } }CSRedisCore# csRedis 对所有方法名称进行了调整，使其和 redis-cli保持一致，如果熟悉 redis-cli 的命令可以直接上手，学习成本降低很多。
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/posts/redis/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5redis/">
  <meta property="og:site_name" content="CODE&#39;NOTE">
  <meta property="og:title" content="CODE&#39;NOTE">
  <meta property="og:description" content="测试代码：https://github.com/wangpengliang815/CodeSnippet/tree/master/CommonLib/CommonLib
参考文档：https://www.bookstack.cn/books/StackExchange.Redis-docs-cn
客户端# ServiceStack.Redis 是商业版，免费版有限制 StackExchange.Redis 是免费版，但是内核在 .NETCore 运行有问题经常 Timeout，暂无法解决 csRedis于2016年开始支持.NETCore一直迭代至今，实现了低门槛、高性能，和分区高级玩法的.NETCore redis-cli SDK ServiceStack.Redis# 商业版，免费版有限制。放弃。
StackExchange.Redis# 安装# StackExchange.Redis 是 C# 操作 Redis 数据库的客户端。在 NuGet 中搜索 StackExchange.Redis ，直接点击按钮安装即可。
封装# RedisHelper
namespace CommonLib { using Newtonsoft.Json; using StackExchange.Redis; using System; using System.Collections.Generic; using System.Linq; using System.Threading.Tasks; /// &lt;summary&gt; /// 基于StackExchange.Redis封装的Helper /// /// &lt;/summary&gt; public class RedisHelper { /// &lt;summary&gt; /// 自定义缓存Key前缀 /// &lt;/summary&gt; /// &lt;value&gt; /// The custom key prefix. /// &lt;/value&gt; private string CustomKeyPrefix { get; } /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private readonly ConnectionMultiplexer conn; /// &lt;summary&gt; /// Redis数据库对象 /// &lt;/summary&gt; public readonly IDatabase db; /// &lt;summary&gt; /// Initializes a new instance of the &lt;see cref=&#34;RedisHelper&#34;/&gt; class. /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;param name=&#34;redisConnectionString&#34;&gt;The redis connection string.&lt;/param&gt; /// &lt;param name=&#34;customKeyPrefix&#34;&gt;The custom key prefix.&lt;/param&gt; public RedisHelper(int dbSerialNumber , string redisConnectionString , string customKeyPrefix = null) { CustomKeyPrefix = customKeyPrefix; #if customSingleton RedisConnectionMultiplexerHelper.RedisConnectionString = redisConnectionString; conn = RedisConnectionMultiplexerHelper.Instance; #endif conn = ConnectionMultiplexer.Connect(redisConnectionString); db = conn.GetDatabase(dbSerialNumber); } /// &lt;summary&gt; /// 保存单个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.StringSet(key, value, expiry); } /// &lt;summary&gt; /// 保存多个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;keyValues&#34;&gt;The key values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return db.StringSet(newkeyValues.ToArray()); } /// &lt;summary&gt; /// 以Json格式保存对象 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;object&#34;&gt;The object.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return db.StringSet(key, json, expiry); } /// &lt;summary&gt; /// 获取单个Key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public string StringGet(string key) { key = GenerateCustomKey(key); return db.StringGet(key); } /// &lt;summary&gt; /// 获取多个Key /// &lt;/summary&gt; /// &lt;param name=&#34;listKeys&#34;&gt;The list keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public RedisValue[] StringGet(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return db.StringGet(ConvertToRedisKeys(redisKeys)); } /// &lt;summary&gt; /// 获取value转换为Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T StringGet&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(db.StringGet(key)); } /// &lt;summary&gt; /// Increment,如果key存在,则:value&#43;=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double StringIncrement(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return db.StringIncrement(key, incrementVal); } /// &lt;summary&gt; /// Decrement,如果key存在,则:value-=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;减少后的值&lt;/returns&gt; public double StringDecrement(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return db.StringDecrement(key, decrementVal); } /// &lt;summary&gt; /// 判断hash中某个key是否已经被缓存 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashExists(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashExists(key, hashFieldName); } /// &lt;summary&gt; /// 存储数据到hash表 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;hashValue&#34;&gt;The hash value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashSet&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return db.HashSet(key, hashFieldName, json); } /// &lt;summary&gt; /// 移除hash中的某值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashDelete(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldName); } /// &lt;summary&gt; /// 移除hash中的多个值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldNames&#34;&gt;The hash field names.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long HashDelete(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldNames.ToArray()); } /// &lt;summary&gt; /// 从hash表获取数据 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T HashGet&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = db.HashGet(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// hash为数字增长value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashIncrement(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return db.HashIncrement(key, hashFieldName, incrementVal); } /// &lt;summary&gt; /// hash为数字减少value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashDecrement(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return db.HashDecrement(key, hashFieldName, decrementVal); } /// &lt;summary&gt; /// 获取hashkey所有rediskey /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; HashKeys&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.HashKeys(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 移除指定List内部的值 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; public void ListRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); db.ListRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 获取指定key的List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; ListRange&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.ListRange(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 入队：列表从最右边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListRightPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListRightPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出队：列表从最右边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListRightPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = db.ListRightPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 入栈：列表从最左边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLeftPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListLeftPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出栈：列表从最左边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListLeftPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = db.ListLeftPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 获取集合中的数量 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLength(string key) { key = GenerateCustomKey(key); return db.ListLength(key); } /// &lt;summary&gt; /// Sorteds the set add. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;score&#34;&gt;The score.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetAdd&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return db.SortedSetAdd(key, ConvertToJson&lt;T&gt;(value), score); } /// &lt;summary&gt; /// Sorteds the set remove. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.SortedSetRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// Sorteds the set range by rank. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;start&#34;&gt;The start.&lt;/param&gt; /// &lt;param name=&#34;stop&#34;&gt;The stop.&lt;/param&gt; /// &lt;param name=&#34;order&#34;&gt;The order.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; SortedSetRangeByRank&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = db.SortedSetRangeByRank(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// Sorteds the length of the set. /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long SortedSetLength(string key) { key = GenerateCustomKey(key); return db.SortedSetLength(key); } /// &lt;summary&gt; /// 删除单个key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyDelete(string key) { key = GenerateCustomKey(key); return db.KeyDelete(key); } /// &lt;summary&gt; /// 删除多个key /// &lt;/summary&gt; /// &lt;param name=&#34;keys&#34;&gt;The keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long KeyDelete(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return db.KeyDelete(ConvertToRedisKeys(newKeys)); } /// &lt;summary&gt; /// 判断key是否存储 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExists(string key) { key = GenerateCustomKey(key); return db.KeyExists(key); } /// &lt;summary&gt; /// 重命名key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;newKey&#34;&gt;The new key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyRename(string key, string newKey) { key = GenerateCustomKey(key); return db.KeyRename(key, newKey); } /// &lt;summary&gt; /// 设置Key过期时间 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExpire(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.KeyExpire(key, expiry); } /// &lt;summary&gt; /// Redis订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;subChannel&#34;&gt;The sub channel.&lt;/param&gt; /// &lt;param name=&#34;handler&#34;&gt;The handler.&lt;/param&gt; public void Subscribe(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); sub.Subscribe(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } /// &lt;summary&gt; /// Redis发布 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; /// &lt;param name=&#34;message&#34;&gt;The message.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long Publish&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return sub.Publish(channel, ConvertToJson(message)); } /// &lt;summary&gt; /// Redis取消订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; public void Unsubscribe(string channel) { ISubscriber sub = conn.GetSubscriber(); sub.Unsubscribe(channel); } /// &lt;summary&gt; /// Redis取消全部订阅 /// &lt;/summary&gt; public void UnsubscribeAll() { ISubscriber sub = conn.GetSubscriber(); sub.UnsubscribeAll(); } /// &lt;summary&gt; /// 创建一个Redis事务 /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public ITransaction CreateTransaction(int dbSerialNumber) { return conn.GetDatabase(dbSerialNumber).CreateTransaction(); } public async Task&lt;bool&gt; StringSetAsync(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.StringSetAsync(key, value, expiry); } public async Task&lt;bool&gt; StringSetAsync(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return await db.StringSetAsync(newkeyValues.ToArray()); } public async Task&lt;bool&gt; StringSetAsync&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return await db.StringSetAsync(key, json, expiry); } public async Task&lt;string&gt; StringGetAsync(string key) { key = GenerateCustomKey(key); return await db.StringGetAsync(key); } public async Task&lt;RedisValue[]&gt; StringGetAsync(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return await db.StringGetAsync(ConvertToRedisKeys(redisKeys)); } public async Task&lt;T&gt; StringGetAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(await db.StringGetAsync(key)); } public async Task&lt;double&gt; StringIncrementAsync(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.StringIncrementAsync(key, incrementVal); } public async Task&lt;double&gt; StringDecrementAsync(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.StringDecrementAsync(key, decrementVal); } public async Task&lt;bool&gt; HashExistsAsync(string key, string dataKey) { key = GenerateCustomKey(key); return await db.HashExistsAsync(key, dataKey); } public async Task&lt;bool&gt; HashSetAsync&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return await db.HashSetAsync(key, hashFieldName, json); } public async Task&lt;bool&gt; HashDeleteAsync(string key, string hashFieldName) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldName); } public async Task&lt;long&gt; HashDeleteAsync(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldNames.ToArray()); } public async Task&lt;T&gt; HashGetAsync&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = await db.HashGetAsync(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;double&gt; HashIncrementAsync(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.HashIncrementAsync(key, hashFieldName, incrementVal); } public async Task&lt;double&gt; HashDecrementAsync(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.HashDecrementAsync(key, hashFieldName, decrementVal); } public async Task&lt;List&lt;T&gt;&gt; HashKeysAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.HashKeysAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; ListRangeAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.ListRangeAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRightPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRightPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListRightPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = await db.ListRightPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLeftPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListLeftPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListLeftPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = await db.ListLeftPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLengthAsync(string key) { key = GenerateCustomKey(key); return await db.ListLengthAsync(key); } public async Task&lt;bool&gt; SortedSetAddAsync&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return await db.SortedSetAddAsync(key, ConvertToJson&lt;T&gt;(value), score); } public async Task&lt;bool&gt; SortedSetRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.SortedSetRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; SortedSetRangeByRankAsync&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = await db.SortedSetRangeByRankAsync(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; SortedSetLengthAsync(string key) { key = GenerateCustomKey(key); return await db.SortedSetLengthAsync(key); } public async Task&lt;bool&gt; KeyDeleteAsync(string key) { key = GenerateCustomKey(key); return await db.KeyDeleteAsync(key); } public async Task&lt;long&gt; KeyDeleteAsync(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return await db.KeyDeleteAsync(ConvertToRedisKeys(newKeys)); } public async Task&lt;bool&gt; KeyExistsAsync(string key) { key = GenerateCustomKey(key); return await db.KeyExistsAsync(key); } public async Task&lt;bool&gt; KeyRenameAsync(string key, string newKey) { key = GenerateCustomKey(key); return await db.KeyRenameAsync(key, newKey); } public async Task&lt;bool&gt; KeyExpireAsync(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.KeyExpireAsync(key, expiry); } public async Task SubscribeAsync(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); await sub.SubscribeAsync(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } public async Task&lt;long&gt; PublishAsync&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return await sub.PublishAsync(channel, ConvertToJson(message)); } public async Task UnsubscribeAsync(string channel) { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAsync(channel); } public async Task UnsubscribeAllAsync() { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAllAsync(); } /// &lt;summary&gt; /// 生成自定义Key,格式(CustomKeyPrefix&#43;&#34;_&#34;&#43;Key) /// &lt;/summary&gt; /// &lt;param name=&#34;oldKey&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private string GenerateCustomKey(string oldKey) { if (!string.IsNullOrWhiteSpace(CustomKeyPrefix)) { return $&#34;{CustomKeyPrefix}_{oldKey}&#34;; } return oldKey; } /// &lt;summary&gt; /// 对象序列化 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static string ConvertToJson&lt;T&gt;(T value) { return value is string ? value.ToString() : JsonConvert.SerializeObject(value); } /// &lt;summary&gt; /// RedisValue转Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static T ConvertToObject&lt;T&gt;(RedisValue value) { if (typeof(T).Name.Equals(typeof(string).Name)) { return JsonConvert.DeserializeObject&lt;T&gt;($&#34;&#39;{value}&#39;&#34;); } return JsonConvert.DeserializeObject&lt;T&gt;(value); } /// &lt;summary&gt; /// RedisValue转List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;values&#34;&gt;The values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static List&lt;T&gt; ConvetToList&lt;T&gt;(RedisValue[] values) { List&lt;T&gt; result = new(); foreach (RedisValue item in values) { T @object = ConvertToObject&lt;T&gt;(item); result.Add(@object); } return result; } /// &lt;summary&gt; /// 转换为RedisKey /// &lt;/summary&gt; /// &lt;param name=&#34;redisKeys&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static RedisKey[] ConvertToRedisKeys(List&lt;string&gt; redisKeys) { return redisKeys.Select(redisKey =&gt; (RedisKey)redisKey).ToArray(); } } /// &lt;summary&gt; /// 单例获取RedisConnectionMultiplexer /// &lt;/summary&gt; static class RedisConnectionMultiplexerHelper { /// &lt;summary&gt; /// Redis连接字符串 /// &lt;/summary&gt; public static string RedisConnectionString { get; set; } private static readonly object locker = new(); /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private static ConnectionMultiplexer connectionMultiplexerInstance; /// &lt;summary&gt; /// 单例获取 /// &lt;/summary&gt; public static ConnectionMultiplexer Instance { get { if (connectionMultiplexerInstance == null) { lock (locker) { if (connectionMultiplexerInstance == null || !connectionMultiplexerInstance.IsConnected) { connectionMultiplexerInstance = GetConnectionMultiplexer(); } } } return connectionMultiplexerInstance; } } private static ConnectionMultiplexer GetConnectionMultiplexer() { if (string.IsNullOrWhiteSpace(RedisConnectionString)) { throw new Exception(&#34;RedisConnectionString IsNullOrWhiteSpace!&#34;); } var connect = ConnectionMultiplexer.Connect(RedisConnectionString); connect.ConnectionFailed &#43;= MuxerConnectionFailed; connect.ConnectionRestored &#43;= MuxerConnectionRestored; connect.ErrorMessage &#43;= MuxerErrorMessage; connect.ConfigurationChanged &#43;= MuxerConfigurationChanged; connect.HashSlotMoved &#43;= MuxerHashSlotMoved; connect.InternalError &#43;= MuxerInternalError; return connect; } /// &lt;summary&gt; /// 配置更改时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConfigurationChanged(object sender, EndPointEventArgs e) { Console.WriteLine($&#34;Configuration changed: {e.EndPoint}&#34;); } /// &lt;summary&gt; /// 发生错误时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerErrorMessage(object sender, RedisErrorEventArgs e) { Console.WriteLine($&#34;ErrorMessage:{e.Message}&#34;); } /// &lt;summary&gt; /// 重新建立连接之前的错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionRestored(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;ConnectionRestored:{e.EndPoint}&#34;); } /// &lt;summary&gt; /// 连接失败,如果重新连接成功将不会收到这个通知 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionFailed(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;重新连接：Endpoint failed:{e.EndPoint},{e.FailureType},{e.Exception.Message}&#34;); } /// &lt;summary&gt; /// 更改集群 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerHashSlotMoved(object sender, HashSlotMovedEventArgs e) { Console.WriteLine($&#34;HashSlotMoved:NewEndPoint={e.NewEndPoint},OldEndPoint={ e.OldEndPoint}&#34;); } /// &lt;summary&gt; /// Redis类库错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerInternalError(object sender, InternalErrorEventArgs e) { Console.WriteLine($&#34;InternalError:Message={e.Exception.Message}&#34;); } } }CSRedisCore# csRedis 对所有方法名称进行了调整，使其和 redis-cli保持一致，如果熟悉 redis-cli 的命令可以直接上手，学习成本降低很多。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">


  <meta itemprop="name" content="CODE&#39;NOTE">
  <meta itemprop="description" content="测试代码：https://github.com/wangpengliang815/CodeSnippet/tree/master/CommonLib/CommonLib
参考文档：https://www.bookstack.cn/books/StackExchange.Redis-docs-cn
客户端# ServiceStack.Redis 是商业版，免费版有限制 StackExchange.Redis 是免费版，但是内核在 .NETCore 运行有问题经常 Timeout，暂无法解决 csRedis于2016年开始支持.NETCore一直迭代至今，实现了低门槛、高性能，和分区高级玩法的.NETCore redis-cli SDK ServiceStack.Redis# 商业版，免费版有限制。放弃。
StackExchange.Redis# 安装# StackExchange.Redis 是 C# 操作 Redis 数据库的客户端。在 NuGet 中搜索 StackExchange.Redis ，直接点击按钮安装即可。
封装# RedisHelper
namespace CommonLib { using Newtonsoft.Json; using StackExchange.Redis; using System; using System.Collections.Generic; using System.Linq; using System.Threading.Tasks; /// &lt;summary&gt; /// 基于StackExchange.Redis封装的Helper /// /// &lt;/summary&gt; public class RedisHelper { /// &lt;summary&gt; /// 自定义缓存Key前缀 /// &lt;/summary&gt; /// &lt;value&gt; /// The custom key prefix. /// &lt;/value&gt; private string CustomKeyPrefix { get; } /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private readonly ConnectionMultiplexer conn; /// &lt;summary&gt; /// Redis数据库对象 /// &lt;/summary&gt; public readonly IDatabase db; /// &lt;summary&gt; /// Initializes a new instance of the &lt;see cref=&#34;RedisHelper&#34;/&gt; class. /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;param name=&#34;redisConnectionString&#34;&gt;The redis connection string.&lt;/param&gt; /// &lt;param name=&#34;customKeyPrefix&#34;&gt;The custom key prefix.&lt;/param&gt; public RedisHelper(int dbSerialNumber , string redisConnectionString , string customKeyPrefix = null) { CustomKeyPrefix = customKeyPrefix; #if customSingleton RedisConnectionMultiplexerHelper.RedisConnectionString = redisConnectionString; conn = RedisConnectionMultiplexerHelper.Instance; #endif conn = ConnectionMultiplexer.Connect(redisConnectionString); db = conn.GetDatabase(dbSerialNumber); } /// &lt;summary&gt; /// 保存单个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.StringSet(key, value, expiry); } /// &lt;summary&gt; /// 保存多个k/v /// &lt;/summary&gt; /// &lt;param name=&#34;keyValues&#34;&gt;The key values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return db.StringSet(newkeyValues.ToArray()); } /// &lt;summary&gt; /// 以Json格式保存对象 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;object&#34;&gt;The object.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool StringSet&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return db.StringSet(key, json, expiry); } /// &lt;summary&gt; /// 获取单个Key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public string StringGet(string key) { key = GenerateCustomKey(key); return db.StringGet(key); } /// &lt;summary&gt; /// 获取多个Key /// &lt;/summary&gt; /// &lt;param name=&#34;listKeys&#34;&gt;The list keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public RedisValue[] StringGet(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return db.StringGet(ConvertToRedisKeys(redisKeys)); } /// &lt;summary&gt; /// 获取value转换为Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T StringGet&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(db.StringGet(key)); } /// &lt;summary&gt; /// Increment,如果key存在,则:value&#43;=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double StringIncrement(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return db.StringIncrement(key, incrementVal); } /// &lt;summary&gt; /// Decrement,如果key存在,则:value-=value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;减少后的值&lt;/returns&gt; public double StringDecrement(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return db.StringDecrement(key, decrementVal); } /// &lt;summary&gt; /// 判断hash中某个key是否已经被缓存 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashExists(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashExists(key, hashFieldName); } /// &lt;summary&gt; /// 存储数据到hash表 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;hashValue&#34;&gt;The hash value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashSet&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return db.HashSet(key, hashFieldName, json); } /// &lt;summary&gt; /// 移除hash中的某值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HashDelete(string key, string hashFieldName) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldName); } /// &lt;summary&gt; /// 移除hash中的多个值 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldNames&#34;&gt;The hash field names.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long HashDelete(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return db.HashDelete(key, hashFieldNames.ToArray()); } /// &lt;summary&gt; /// 从hash表获取数据 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T HashGet&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = db.HashGet(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// hash为数字增长value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashIncrement(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return db.HashIncrement(key, hashFieldName, incrementVal); } /// &lt;summary&gt; /// hash为数字减少value /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt; /// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public double HashDecrement(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return db.HashDecrement(key, hashFieldName, decrementVal); } /// &lt;summary&gt; /// 获取hashkey所有rediskey /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; HashKeys&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.HashKeys(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 移除指定List内部的值 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; public void ListRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); db.ListRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 获取指定key的List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; ListRange&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = db.ListRange(key); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// 入队：列表从最右边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListRightPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListRightPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出队：列表从最右边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListRightPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = db.ListRightPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 入栈：列表从最左边插入一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLeftPush&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.ListLeftPush(key, ConvertToJson(value)); } /// &lt;summary&gt; /// 出栈：列表从最左边获取一个元素 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T ListLeftPop&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = db.ListLeftPop(key); return ConvertToObject&lt;T&gt;(value); } /// &lt;summary&gt; /// 获取集合中的数量 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long ListLength(string key) { key = GenerateCustomKey(key); return db.ListLength(key); } /// &lt;summary&gt; /// Sorteds the set add. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;param name=&#34;score&#34;&gt;The score.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetAdd&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return db.SortedSetAdd(key, ConvertToJson&lt;T&gt;(value), score); } /// &lt;summary&gt; /// Sorteds the set remove. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool SortedSetRemove&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return db.SortedSetRemove(key, ConvertToJson(value)); } /// &lt;summary&gt; /// Sorteds the set range by rank. /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;start&#34;&gt;The start.&lt;/param&gt; /// &lt;param name=&#34;stop&#34;&gt;The stop.&lt;/param&gt; /// &lt;param name=&#34;order&#34;&gt;The order.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;T&gt; SortedSetRangeByRank&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = db.SortedSetRangeByRank(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } /// &lt;summary&gt; /// Sorteds the length of the set. /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long SortedSetLength(string key) { key = GenerateCustomKey(key); return db.SortedSetLength(key); } /// &lt;summary&gt; /// 删除单个key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyDelete(string key) { key = GenerateCustomKey(key); return db.KeyDelete(key); } /// &lt;summary&gt; /// 删除多个key /// &lt;/summary&gt; /// &lt;param name=&#34;keys&#34;&gt;The keys.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long KeyDelete(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return db.KeyDelete(ConvertToRedisKeys(newKeys)); } /// &lt;summary&gt; /// 判断key是否存储 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExists(string key) { key = GenerateCustomKey(key); return db.KeyExists(key); } /// &lt;summary&gt; /// 重命名key /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;newKey&#34;&gt;The new key.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyRename(string key, string newKey) { key = GenerateCustomKey(key); return db.KeyRename(key, newKey); } /// &lt;summary&gt; /// 设置Key过期时间 /// &lt;/summary&gt; /// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt; /// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool KeyExpire(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return db.KeyExpire(key, expiry); } /// &lt;summary&gt; /// Redis订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;subChannel&#34;&gt;The sub channel.&lt;/param&gt; /// &lt;param name=&#34;handler&#34;&gt;The handler.&lt;/param&gt; public void Subscribe(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); sub.Subscribe(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } /// &lt;summary&gt; /// Redis发布 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; /// &lt;param name=&#34;message&#34;&gt;The message.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public long Publish&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return sub.Publish(channel, ConvertToJson(message)); } /// &lt;summary&gt; /// Redis取消订阅 /// &lt;/summary&gt; /// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt; public void Unsubscribe(string channel) { ISubscriber sub = conn.GetSubscriber(); sub.Unsubscribe(channel); } /// &lt;summary&gt; /// Redis取消全部订阅 /// &lt;/summary&gt; public void UnsubscribeAll() { ISubscriber sub = conn.GetSubscriber(); sub.UnsubscribeAll(); } /// &lt;summary&gt; /// 创建一个Redis事务 /// &lt;/summary&gt; /// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public ITransaction CreateTransaction(int dbSerialNumber) { return conn.GetDatabase(dbSerialNumber).CreateTransaction(); } public async Task&lt;bool&gt; StringSetAsync(string key, string value, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.StringSetAsync(key, value, expiry); } public async Task&lt;bool&gt; StringSetAsync(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues) { List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues .Select(p =&gt; new KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value)) .ToList(); return await db.StringSetAsync(newkeyValues.ToArray()); } public async Task&lt;bool&gt; StringSetAsync&lt;T&gt;(string key, T @object, TimeSpan? expiry = default) { key = GenerateCustomKey(key); string json = ConvertToJson(@object); return await db.StringSetAsync(key, json, expiry); } public async Task&lt;string&gt; StringGetAsync(string key) { key = GenerateCustomKey(key); return await db.StringGetAsync(key); } public async Task&lt;RedisValue[]&gt; StringGetAsync(List&lt;string&gt; listKeys) { List&lt;string&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList(); return await db.StringGetAsync(ConvertToRedisKeys(redisKeys)); } public async Task&lt;T&gt; StringGetAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); return ConvertToObject&lt;T&gt;(await db.StringGetAsync(key)); } public async Task&lt;double&gt; StringIncrementAsync(string key, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.StringIncrementAsync(key, incrementVal); } public async Task&lt;double&gt; StringDecrementAsync(string key, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.StringDecrementAsync(key, decrementVal); } public async Task&lt;bool&gt; HashExistsAsync(string key, string dataKey) { key = GenerateCustomKey(key); return await db.HashExistsAsync(key, dataKey); } public async Task&lt;bool&gt; HashSetAsync&lt;T&gt;(string key, string hashFieldName, T hashValue) { key = GenerateCustomKey(key); string json = ConvertToJson(hashValue); return await db.HashSetAsync(key, hashFieldName, json); } public async Task&lt;bool&gt; HashDeleteAsync(string key, string hashFieldName) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldName); } public async Task&lt;long&gt; HashDeleteAsync(string key, List&lt;RedisValue&gt; hashFieldNames) { key = GenerateCustomKey(key); return await db.HashDeleteAsync(key, hashFieldNames.ToArray()); } public async Task&lt;T&gt; HashGetAsync&lt;T&gt;(string key, string hashFieldName) { key = GenerateCustomKey(key); string value = await db.HashGetAsync(key, hashFieldName); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;double&gt; HashIncrementAsync(string key, string hashFieldName, double incrementVal = 1) { key = GenerateCustomKey(key); return await db.HashIncrementAsync(key, hashFieldName, incrementVal); } public async Task&lt;double&gt; HashDecrementAsync(string key, string hashFieldName, double decrementVal = 1) { key = GenerateCustomKey(key); return await db.HashDecrementAsync(key, hashFieldName, decrementVal); } public async Task&lt;List&lt;T&gt;&gt; HashKeysAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.HashKeysAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; ListRangeAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue[] values = await db.ListRangeAsync(key); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; ListRightPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListRightPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListRightPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); RedisValue value = await db.ListRightPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLeftPushAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.ListLeftPushAsync(key, ConvertToJson(value)); } public async Task&lt;T&gt; ListLeftPopAsync&lt;T&gt;(string key) { key = GenerateCustomKey(key); var value = await db.ListLeftPopAsync(key); return ConvertToObject&lt;T&gt;(value); } public async Task&lt;long&gt; ListLengthAsync(string key) { key = GenerateCustomKey(key); return await db.ListLengthAsync(key); } public async Task&lt;bool&gt; SortedSetAddAsync&lt;T&gt;(string key, T value, double score) { key = GenerateCustomKey(key); return await db.SortedSetAddAsync(key, ConvertToJson&lt;T&gt;(value), score); } public async Task&lt;bool&gt; SortedSetRemoveAsync&lt;T&gt;(string key, T value) { key = GenerateCustomKey(key); return await db.SortedSetRemoveAsync(key, ConvertToJson(value)); } public async Task&lt;List&lt;T&gt;&gt; SortedSetRangeByRankAsync&lt;T&gt;(string key, long start, long stop, Order order = Order.Ascending) { key = GenerateCustomKey(key); var values = await db.SortedSetRangeByRankAsync(key, start, stop, order); return ConvetToList&lt;T&gt;(values); } public async Task&lt;long&gt; SortedSetLengthAsync(string key) { key = GenerateCustomKey(key); return await db.SortedSetLengthAsync(key); } public async Task&lt;bool&gt; KeyDeleteAsync(string key) { key = GenerateCustomKey(key); return await db.KeyDeleteAsync(key); } public async Task&lt;long&gt; KeyDeleteAsync(List&lt;string&gt; keys) { List&lt;string&gt; newKeys = keys.Select(GenerateCustomKey).ToList(); return await db.KeyDeleteAsync(ConvertToRedisKeys(newKeys)); } public async Task&lt;bool&gt; KeyExistsAsync(string key) { key = GenerateCustomKey(key); return await db.KeyExistsAsync(key); } public async Task&lt;bool&gt; KeyRenameAsync(string key, string newKey) { key = GenerateCustomKey(key); return await db.KeyRenameAsync(key, newKey); } public async Task&lt;bool&gt; KeyExpireAsync(string key, TimeSpan? expiry = default) { key = GenerateCustomKey(key); return await db.KeyExpireAsync(key, expiry); } public async Task SubscribeAsync(string subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = null) { ISubscriber sub = conn.GetSubscriber(); await sub.SubscribeAsync(subChannel, (channel, message) =&gt; { if (handler == null) { Console.WriteLine(subChannel &#43; &#34; 订阅收到消息：&#34; &#43; message); } else { handler(channel, message); } }); } public async Task&lt;long&gt; PublishAsync&lt;T&gt;(string channel, T message) { ISubscriber sub = conn.GetSubscriber(); return await sub.PublishAsync(channel, ConvertToJson(message)); } public async Task UnsubscribeAsync(string channel) { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAsync(channel); } public async Task UnsubscribeAllAsync() { ISubscriber sub = conn.GetSubscriber(); await sub.UnsubscribeAllAsync(); } /// &lt;summary&gt; /// 生成自定义Key,格式(CustomKeyPrefix&#43;&#34;_&#34;&#43;Key) /// &lt;/summary&gt; /// &lt;param name=&#34;oldKey&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private string GenerateCustomKey(string oldKey) { if (!string.IsNullOrWhiteSpace(CustomKeyPrefix)) { return $&#34;{CustomKeyPrefix}_{oldKey}&#34;; } return oldKey; } /// &lt;summary&gt; /// 对象序列化 /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static string ConvertToJson&lt;T&gt;(T value) { return value is string ? value.ToString() : JsonConvert.SerializeObject(value); } /// &lt;summary&gt; /// RedisValue转Object /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static T ConvertToObject&lt;T&gt;(RedisValue value) { if (typeof(T).Name.Equals(typeof(string).Name)) { return JsonConvert.DeserializeObject&lt;T&gt;($&#34;&#39;{value}&#39;&#34;); } return JsonConvert.DeserializeObject&lt;T&gt;(value); } /// &lt;summary&gt; /// RedisValue转List /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;param name=&#34;values&#34;&gt;The values.&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static List&lt;T&gt; ConvetToList&lt;T&gt;(RedisValue[] values) { List&lt;T&gt; result = new(); foreach (RedisValue item in values) { T @object = ConvertToObject&lt;T&gt;(item); result.Add(@object); } return result; } /// &lt;summary&gt; /// 转换为RedisKey /// &lt;/summary&gt; /// &lt;param name=&#34;redisKeys&#34;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private static RedisKey[] ConvertToRedisKeys(List&lt;string&gt; redisKeys) { return redisKeys.Select(redisKey =&gt; (RedisKey)redisKey).ToArray(); } } /// &lt;summary&gt; /// 单例获取RedisConnectionMultiplexer /// &lt;/summary&gt; static class RedisConnectionMultiplexerHelper { /// &lt;summary&gt; /// Redis连接字符串 /// &lt;/summary&gt; public static string RedisConnectionString { get; set; } private static readonly object locker = new(); /// &lt;summary&gt; /// ConnectionMultiplexer对象 /// &lt;/summary&gt; private static ConnectionMultiplexer connectionMultiplexerInstance; /// &lt;summary&gt; /// 单例获取 /// &lt;/summary&gt; public static ConnectionMultiplexer Instance { get { if (connectionMultiplexerInstance == null) { lock (locker) { if (connectionMultiplexerInstance == null || !connectionMultiplexerInstance.IsConnected) { connectionMultiplexerInstance = GetConnectionMultiplexer(); } } } return connectionMultiplexerInstance; } } private static ConnectionMultiplexer GetConnectionMultiplexer() { if (string.IsNullOrWhiteSpace(RedisConnectionString)) { throw new Exception(&#34;RedisConnectionString IsNullOrWhiteSpace!&#34;); } var connect = ConnectionMultiplexer.Connect(RedisConnectionString); connect.ConnectionFailed &#43;= MuxerConnectionFailed; connect.ConnectionRestored &#43;= MuxerConnectionRestored; connect.ErrorMessage &#43;= MuxerErrorMessage; connect.ConfigurationChanged &#43;= MuxerConfigurationChanged; connect.HashSlotMoved &#43;= MuxerHashSlotMoved; connect.InternalError &#43;= MuxerInternalError; return connect; } /// &lt;summary&gt; /// 配置更改时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConfigurationChanged(object sender, EndPointEventArgs e) { Console.WriteLine($&#34;Configuration changed: {e.EndPoint}&#34;); } /// &lt;summary&gt; /// 发生错误时 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerErrorMessage(object sender, RedisErrorEventArgs e) { Console.WriteLine($&#34;ErrorMessage:{e.Message}&#34;); } /// &lt;summary&gt; /// 重新建立连接之前的错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionRestored(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;ConnectionRestored:{e.EndPoint}&#34;); } /// &lt;summary&gt; /// 连接失败,如果重新连接成功将不会收到这个通知 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerConnectionFailed(object sender, ConnectionFailedEventArgs e) { Console.WriteLine($&#34;重新连接：Endpoint failed:{e.EndPoint},{e.FailureType},{e.Exception.Message}&#34;); } /// &lt;summary&gt; /// 更改集群 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerHashSlotMoved(object sender, HashSlotMovedEventArgs e) { Console.WriteLine($&#34;HashSlotMoved:NewEndPoint={e.NewEndPoint},OldEndPoint={ e.OldEndPoint}&#34;); } /// &lt;summary&gt; /// Redis类库错误 /// &lt;/summary&gt; /// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt; private static void MuxerInternalError(object sender, InternalErrorEventArgs e) { Console.WriteLine($&#34;InternalError:Message={e.Exception.Message}&#34;); } } }CSRedisCore# csRedis 对所有方法名称进行了调整，使其和 redis-cli保持一致，如果熟悉 redis-cli 的命令可以直接上手，学习成本降低很多。">
  <meta itemprop="wordCount" content="3198">

<title>客户端连接 Redis | CODE&#39;NOTE</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/posts/redis/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5redis/">
<link rel="stylesheet" href="/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css" integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG&#43;T2l66Bw7pV8=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.3ed9c79c605914c45e19db90edfda0ca8d87c63064c1d6252862250c4e917346.js" integrity="sha256-PtnHnGBZFMReGduQ7f2gyo2HxjBkwdYlKGIlDE6Rc0Y=" crossorigin="anonymous"></script>



  
</head>
<body dir="ltr" class="book-kind-page book-type-posts">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>CODE&#39;NOTE</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="Search"
    aria-label="Search"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>
























</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>客户端连接 Redis</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#安装">安装</a></li>
    <li><a href="#封装">封装</a></li>
  </ul>

  <ul>
    <li><a href="#安装-1">安装</a></li>
    <li><a href="#初始化">初始化</a></li>
    <li><a href="#字符串string">字符串(string)</a></li>
    <li><a href="#简单操作">简单操作</a></li>
    <li><a href="#非正常情况">非正常情况</a></li>
    <li><a href="#列表list">列表(List)</a></li>
    <li><a href="#集合set">集合(Set)</a></li>
    <li><a href="#散列hashmap">散列(HashMap)</a></li>
    <li><a href="#有序集合">有序集合</a></li>
    <li><a href="#事务">事务</a></li>
    <li><a href="#key的过期">Key的过期</a></li>
    <li><a href="#分区">分区</a></li>
    <li><a href="#发布订阅">发布订阅</a></li>
    <li><a href="#缓存壳">缓存壳</a></li>
    <li><a href="#管道">管道</a></li>
    <li><a href="#多数据库">多数据库</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h1>
    客户端连接 Redis
  </h1>
  


  

  


  <div class="book-post-content markdown-inner"><p>测试代码：https://github.com/wangpengliang815/CodeSnippet/tree/master/CommonLib/CommonLib</p>
<p>参考文档：https://www.bookstack.cn/books/StackExchange.Redis-docs-cn</p>
<!-- more -->
<h1 id="客户端">客户端<a class="anchor" href="#%e5%ae%a2%e6%88%b7%e7%ab%af">#</a></h1>
<ul>
<li>ServiceStack.Redis 是商业版，免费版有限制</li>
<li>StackExchange.Redis 是免费版，但是内核在 .NETCore 运行有问题经常 Timeout，暂无法解决</li>
<li>csRedis于2016年开始支持.NETCore一直迭代至今，实现了低门槛、高性能，和分区高级玩法的.NETCore redis-cli SDK</li>
</ul>
<h1 id="servicestackredis">ServiceStack.Redis<a class="anchor" href="#servicestackredis">#</a></h1>
<p>商业版，免费版有限制。放弃。</p>
<h1 id="stackexchangeredis">StackExchange.Redis<a class="anchor" href="#stackexchangeredis">#</a></h1>
<h2 id="安装">安装<a class="anchor" href="#%e5%ae%89%e8%a3%85">#</a></h2>
<p><code>StackExchange.Redis</code> 是 C# 操作 <code>Redis</code> 数据库的客户端。在 <code>NuGet</code> 中搜索 <code>StackExchange.Redis</code> ，直接点击按钮安装即可。</p>
<h2 id="封装">封装<a class="anchor" href="#%e5%b0%81%e8%a3%85">#</a></h2>
<p><code>RedisHelper</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> CommonLib
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> Newtonsoft.Json;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> StackExchange.Redis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> System.Threading.Tasks;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 基于StackExchange.Redis封装的Helper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisHelper</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 自定义缓存Key前缀</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;value&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The custom key prefix.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/value&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span> CustomKeyPrefix { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// ConnectionMultiplexer对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ConnectionMultiplexer conn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis数据库对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">readonly</span> IDatabase db;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Initializes a new instance of the &lt;see cref=&#34;RedisHelper&#34;/&gt; class.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;redisConnectionString&#34;&gt;The redis connection string.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;customKeyPrefix&#34;&gt;The custom key prefix.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> RedisHelper(<span style="color:#66d9ef">int</span> dbSerialNumber
</span></span><span style="display:flex;"><span>            , <span style="color:#66d9ef">string</span> redisConnectionString
</span></span><span style="display:flex;"><span>            , <span style="color:#66d9ef">string</span> customKeyPrefix = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            CustomKeyPrefix = customKeyPrefix;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> customSingleton 
</span></span><span style="display:flex;"><span>            RedisConnectionMultiplexerHelper.RedisConnectionString = redisConnectionString;
</span></span><span style="display:flex;"><span>            conn = RedisConnectionMultiplexerHelper.Instance;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>            conn = ConnectionMultiplexer.Connect(redisConnectionString);
</span></span><span style="display:flex;"><span>            db = conn.GetDatabase(dbSerialNumber);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 保存单个k/v</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> StringSet(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringSet(key, <span style="color:#66d9ef">value</span>, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 保存多个k/v</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;keyValues&#34;&gt;The key values.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> StringSet(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues
</span></span><span style="display:flex;"><span>                .Select(p =&gt; <span style="color:#66d9ef">new</span> KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value))
</span></span><span style="display:flex;"><span>                .ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringSet(newkeyValues.ToArray());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 以Json格式保存对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;object&#34;&gt;The object.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> StringSet&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T @object, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> json = ConvertToJson(@object);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringSet(key, json, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取单个Key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> StringGet(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringGet(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取多个Key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;listKeys&#34;&gt;The list keys.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> RedisValue[] StringGet(List&lt;<span style="color:#66d9ef">string</span>&gt; listKeys)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;<span style="color:#66d9ef">string</span>&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringGet(ConvertToRedisKeys(redisKeys));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取value转换为Object</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> T StringGet&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(db.StringGet(key));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Increment,如果key存在,则:value+=value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> StringIncrement(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">double</span> incrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringIncrement(key, incrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Decrement,如果key存在,则:value-=value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;减少后的值&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> StringDecrement(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">double</span> decrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.StringDecrement(key, decrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 判断hash中某个key是否已经被缓存</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> HashExists(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashExists(key, hashFieldName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 存储数据到hash表</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashValue&#34;&gt;The hash value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> HashSet&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, T hashValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> json = ConvertToJson(hashValue);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashSet(key, hashFieldName, json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 移除hash中的某值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> HashDelete(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashDelete(key, hashFieldName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 移除hash中的多个值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldNames&#34;&gt;The hash field names.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> HashDelete(<span style="color:#66d9ef">string</span> key, List&lt;RedisValue&gt; hashFieldNames)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashDelete(key, hashFieldNames.ToArray());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 从hash表获取数据</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> T HashGet&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span> = db.HashGet(key, hashFieldName);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// hash为数字增长value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;incrementVal&#34;&gt;The increment value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> HashIncrement(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, <span style="color:#66d9ef">double</span> incrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashIncrement(key, hashFieldName, incrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// hash为数字减少value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;hashFieldName&#34;&gt;Name of the hash field.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;decrementVal&#34;&gt;The decrement value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> HashDecrement(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, <span style="color:#66d9ef">double</span> decrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.HashDecrement(key, hashFieldName, decrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取hashkey所有rediskey</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;T&gt; HashKeys&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue[] values = db.HashKeys(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 移除指定List内部的值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ListRemove&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            db.ListRemove(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取指定key的List</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;T&gt; ListRange&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue[] values = db.ListRange(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 入队：列表从最右边插入一个元素</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> ListRightPush&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.ListRightPush(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 出队：列表从最右边获取一个元素</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> T ListRightPop&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue <span style="color:#66d9ef">value</span> = db.ListRightPop(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 入栈：列表从最左边插入一个元素</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> ListLeftPush&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.ListLeftPush(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 出栈：列表从最左边获取一个元素</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> T ListLeftPop&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#66d9ef">value</span> = db.ListLeftPop(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 获取集合中的数量</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> ListLength(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.ListLength(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Sorteds the set add.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;score&#34;&gt;The score.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> SortedSetAdd&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>, <span style="color:#66d9ef">double</span> score)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.SortedSetAdd(key, ConvertToJson&lt;T&gt;(<span style="color:#66d9ef">value</span>), score);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Sorteds the set remove.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;The value.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> SortedSetRemove&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.SortedSetRemove(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Sorteds the set range by rank.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;start&#34;&gt;The start.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;stop&#34;&gt;The stop.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;order&#34;&gt;The order.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;T&gt; SortedSetRangeByRank&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">long</span> start, <span style="color:#66d9ef">long</span> stop, Order order = Order.Ascending)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> values = db.SortedSetRangeByRank(key, start, stop, order);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Sorteds the length of the set.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> SortedSetLength(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.SortedSetLength(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 删除单个key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> KeyDelete(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.KeyDelete(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 删除多个key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;keys&#34;&gt;The keys.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> KeyDelete(List&lt;<span style="color:#66d9ef">string</span>&gt; keys)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;<span style="color:#66d9ef">string</span>&gt; newKeys = keys.Select(GenerateCustomKey).ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.KeyDelete(ConvertToRedisKeys(newKeys));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 判断key是否存储</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> KeyExists(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.KeyExists(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 重命名key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;newKey&#34;&gt;The new key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> KeyRename(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> newKey)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.KeyRename(key, newKey);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 设置Key过期时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;key&#34;&gt;The key.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;expiry&#34;&gt;The expiry.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> KeyExpire(<span style="color:#66d9ef">string</span> key, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.KeyExpire(key, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis订阅</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;subChannel&#34;&gt;The sub channel.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;handler&#34;&gt;The handler.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Subscribe(<span style="color:#66d9ef">string</span> subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            sub.Subscribe(subChannel, (channel, message) =&gt;
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (handler == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    Console.WriteLine(subChannel + <span style="color:#e6db74">&#34; 订阅收到消息：&#34;</span> + message);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    handler(channel, message);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis发布</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;message&#34;&gt;The message.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> Publish&lt;T&gt;(<span style="color:#66d9ef">string</span> channel, T message)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> sub.Publish(channel, ConvertToJson(message));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis取消订阅</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;channel&#34;&gt;The channel.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Unsubscribe(<span style="color:#66d9ef">string</span> channel)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            sub.Unsubscribe(channel);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis取消全部订阅</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> UnsubscribeAll()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            sub.UnsubscribeAll();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 创建一个Redis事务</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;dbSerialNumber&#34;&gt;The database serial number.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> ITransaction CreateTransaction(<span style="color:#66d9ef">int</span> dbSerialNumber)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> conn.GetDatabase(dbSerialNumber).CreateTransaction();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; StringSetAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringSetAsync(key, <span style="color:#66d9ef">value</span>, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; StringSetAsync(List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; keyValues)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;KeyValuePair&lt;RedisKey, RedisValue&gt;&gt; newkeyValues = keyValues
</span></span><span style="display:flex;"><span>                .Select(p =&gt; <span style="color:#66d9ef">new</span> KeyValuePair&lt;RedisKey, RedisValue&gt;(GenerateCustomKey(p.Key), p.Value))
</span></span><span style="display:flex;"><span>                .ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringSetAsync(newkeyValues.ToArray());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; StringSetAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T @object, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> json = ConvertToJson(@object);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringSetAsync(key, json, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">string</span>&gt; StringGetAsync(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringGetAsync(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;RedisValue[]&gt; StringGetAsync(List&lt;<span style="color:#66d9ef">string</span>&gt; listKeys)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;<span style="color:#66d9ef">string</span>&gt; redisKeys = listKeys.Select(GenerateCustomKey).ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringGetAsync(ConvertToRedisKeys(redisKeys));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;T&gt; StringGetAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">await</span> db.StringGetAsync(key));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">double</span>&gt; StringIncrementAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">double</span> incrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringIncrementAsync(key, incrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">double</span>&gt; StringDecrementAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">double</span> decrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.StringDecrementAsync(key, decrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; HashExistsAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> dataKey)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashExistsAsync(key, dataKey);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; HashSetAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, T hashValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> json = ConvertToJson(hashValue);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashSetAsync(key, hashFieldName, json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; HashDeleteAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashDeleteAsync(key, hashFieldName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; HashDeleteAsync(<span style="color:#66d9ef">string</span> key, List&lt;RedisValue&gt; hashFieldNames)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashDeleteAsync(key, hashFieldNames.ToArray());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;T&gt; HashGetAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span> = <span style="color:#66d9ef">await</span> db.HashGetAsync(key, hashFieldName);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">double</span>&gt; HashIncrementAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, <span style="color:#66d9ef">double</span> incrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashIncrementAsync(key, hashFieldName, incrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">double</span>&gt; HashDecrementAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> hashFieldName, <span style="color:#66d9ef">double</span> decrementVal = <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.HashDecrementAsync(key, hashFieldName, decrementVal);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;List&lt;T&gt;&gt; HashKeysAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue[] values = <span style="color:#66d9ef">await</span> db.HashKeysAsync(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; ListRemoveAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.ListRemoveAsync(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;List&lt;T&gt;&gt; ListRangeAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue[] values = <span style="color:#66d9ef">await</span> db.ListRangeAsync(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; ListRightPushAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.ListRightPushAsync(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;T&gt; ListRightPopAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            RedisValue <span style="color:#66d9ef">value</span> = <span style="color:#66d9ef">await</span> db.ListRightPopAsync(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; ListLeftPushAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.ListLeftPushAsync(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;T&gt; ListLeftPopAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#66d9ef">value</span> = <span style="color:#66d9ef">await</span> db.ListLeftPopAsync(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvertToObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; ListLengthAsync(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.ListLengthAsync(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; SortedSetAddAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>, <span style="color:#66d9ef">double</span> score)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.SortedSetAddAsync(key, ConvertToJson&lt;T&gt;(<span style="color:#66d9ef">value</span>), score);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; SortedSetRemoveAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.SortedSetRemoveAsync(key, ConvertToJson(<span style="color:#66d9ef">value</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;List&lt;T&gt;&gt; SortedSetRangeByRankAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">long</span> start, <span style="color:#66d9ef">long</span> stop, Order order = Order.Ascending)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> values = <span style="color:#66d9ef">await</span> db.SortedSetRangeByRankAsync(key, start, stop, order);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ConvetToList&lt;T&gt;(values);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; SortedSetLengthAsync(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.SortedSetLengthAsync(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; KeyDeleteAsync(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.KeyDeleteAsync(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; KeyDeleteAsync(List&lt;<span style="color:#66d9ef">string</span>&gt; keys)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;<span style="color:#66d9ef">string</span>&gt; newKeys = keys.Select(GenerateCustomKey).ToList();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.KeyDeleteAsync(ConvertToRedisKeys(newKeys));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; KeyExistsAsync(<span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.KeyExistsAsync(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; KeyRenameAsync(<span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> newKey)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.KeyRenameAsync(key, newKey);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; KeyExpireAsync(<span style="color:#66d9ef">string</span> key, TimeSpan? expiry = <span style="color:#66d9ef">default</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            key = GenerateCustomKey(key);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db.KeyExpireAsync(key, expiry);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task SubscribeAsync(<span style="color:#66d9ef">string</span> subChannel, Action&lt;RedisChannel, RedisValue&gt; handler = <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> sub.SubscribeAsync(subChannel, (channel, message) =&gt;
</span></span><span style="display:flex;"><span>             {
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">if</span> (handler == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                 {
</span></span><span style="display:flex;"><span>                     Console.WriteLine(subChannel + <span style="color:#e6db74">&#34; 订阅收到消息：&#34;</span> + message);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                 {
</span></span><span style="display:flex;"><span>                     handler(channel, message);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>             });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">long</span>&gt; PublishAsync&lt;T&gt;(<span style="color:#66d9ef">string</span> channel, T message)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> sub.PublishAsync(channel, ConvertToJson(message));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task UnsubscribeAsync(<span style="color:#66d9ef">string</span> channel)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> sub.UnsubscribeAsync(channel);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task UnsubscribeAllAsync()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ISubscriber sub = conn.GetSubscriber();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> sub.UnsubscribeAllAsync();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 生成自定义Key,格式(CustomKeyPrefix+&#34;_&#34;+Key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;oldKey&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span> GenerateCustomKey(<span style="color:#66d9ef">string</span> oldKey)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(CustomKeyPrefix))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">$&#34;{CustomKeyPrefix}_{oldKey}&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> oldKey;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 对象序列化</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> ConvertToJson&lt;T&gt;(T <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">value</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">string</span> ? <span style="color:#66d9ef">value</span>.ToString() : JsonConvert.SerializeObject(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// RedisValue转Object</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;value&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> T ConvertToObject&lt;T&gt;(RedisValue <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span>(T).Name.Equals(<span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">string</span>).Name))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> JsonConvert.DeserializeObject&lt;T&gt;(<span style="color:#e6db74">$&#34;&#39;{value}&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> JsonConvert.DeserializeObject&lt;T&gt;(<span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// RedisValue转List</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;values&#34;&gt;The values.&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> List&lt;T&gt; ConvetToList&lt;T&gt;(RedisValue[] values)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            List&lt;T&gt; result = <span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> (RedisValue item <span style="color:#66d9ef">in</span> values)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                T @object = ConvertToObject&lt;T&gt;(item);
</span></span><span style="display:flex;"><span>                result.Add(@object);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 转换为RedisKey</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;redisKeys&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> RedisKey[] ConvertToRedisKeys(List&lt;<span style="color:#66d9ef">string</span>&gt; redisKeys)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redisKeys.Select(redisKey =&gt; (RedisKey)redisKey).ToArray();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 单例获取RedisConnectionMultiplexer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisConnectionMultiplexerHelper</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis连接字符串</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> RedisConnectionString { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">object</span> locker = <span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// ConnectionMultiplexer对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ConnectionMultiplexer connectionMultiplexerInstance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 单例获取</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ConnectionMultiplexer Instance
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">get</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (connectionMultiplexerInstance == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">lock</span> (locker)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> (connectionMultiplexerInstance == <span style="color:#66d9ef">null</span> || !connectionMultiplexerInstance.IsConnected)
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            connectionMultiplexerInstance = GetConnectionMultiplexer();
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> connectionMultiplexerInstance;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ConnectionMultiplexer GetConnectionMultiplexer()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(RedisConnectionString))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception(<span style="color:#e6db74">&#34;RedisConnectionString IsNullOrWhiteSpace!&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> connect = ConnectionMultiplexer.Connect(RedisConnectionString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            connect.ConnectionFailed += MuxerConnectionFailed;
</span></span><span style="display:flex;"><span>            connect.ConnectionRestored += MuxerConnectionRestored;
</span></span><span style="display:flex;"><span>            connect.ErrorMessage += MuxerErrorMessage;
</span></span><span style="display:flex;"><span>            connect.ConfigurationChanged += MuxerConfigurationChanged;
</span></span><span style="display:flex;"><span>            connect.HashSlotMoved += MuxerHashSlotMoved;
</span></span><span style="display:flex;"><span>            connect.InternalError += MuxerInternalError;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> connect;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 配置更改时</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerConfigurationChanged(<span style="color:#66d9ef">object</span> sender, EndPointEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;Configuration changed: {e.EndPoint}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 发生错误时</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerErrorMessage(<span style="color:#66d9ef">object</span> sender, RedisErrorEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;ErrorMessage:{e.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 重新建立连接之前的错误</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerConnectionRestored(<span style="color:#66d9ef">object</span> sender, ConnectionFailedEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;ConnectionRestored:{e.EndPoint}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 连接失败,如果重新连接成功将不会收到这个通知</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerConnectionFailed(<span style="color:#66d9ef">object</span> sender, ConnectionFailedEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;重新连接：Endpoint failed:{e.EndPoint},{e.FailureType},{e.Exception.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 更改集群</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerHashSlotMoved(<span style="color:#66d9ef">object</span> sender, HashSlotMovedEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;HashSlotMoved:NewEndPoint={e.NewEndPoint},OldEndPoint={ e.OldEndPoint}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Redis类库错误</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;sender&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;e&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MuxerInternalError(<span style="color:#66d9ef">object</span> sender, InternalErrorEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;InternalError:Message={e.Exception.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h1 id="csrediscore">CSRedisCore<a class="anchor" href="#csrediscore">#</a></h1>
<p><code>csRedis</code> 对所有方法名称进行了调整，使其和 <code>redis-cli</code>保持一致，如果熟悉 <code>redis-cli</code> 的命令可以直接上手，学习成本降低很多。</p>
<h2 id="安装-1">安装<a class="anchor" href="#%e5%ae%89%e8%a3%85-1">#</a></h2>
<p>Github：https://github.com/2881099/csRedis</p>
<p><code>csRedisCore</code> 是 C# 操作 <code>Redis</code> 数据库的另一个客户端。在 <code>NuGet</code> 中搜索 <code>csRedisCore</code> ，直接点击按钮安装即可。</p>
<h2 id="初始化">初始化<a class="anchor" href="#%e5%88%9d%e5%a7%8b%e5%8c%96">#</a></h2>
<p>使用连接字符串创建redis实例，可使用以下两种方式</p>
<ol>
<li>使用<code>RedisHelper</code> ： <code>RedisHelper.Initialization(new csRedisClient(&quot;127.0.0.1:6379&quot;))</code></li>
<li>使用<code>csRedisClient</code>：<code>csRedisClient var csRedis = new csRedisClient(&quot;127.0.0.1:6379&quot;);</code></li>
</ol>
<p>然后就可以进行操作了。</p>
<h2 id="字符串string">字符串(string)<a class="anchor" href="#%e5%ad%97%e7%ac%a6%e4%b8%b2string">#</a></h2>
<p>关于字符串的<code>value</code>：</p>
<ul>
<li><code>value</code> 可以用来存储任意格式的数据，如 <code>json</code>、<code>jpg</code> 甚至视频文件</li>
<li><code>value</code> 最大容量为 <code>512M</code></li>
<li><code>value</code> 可以存储3种类型的值：字节串（byte string）/整数（int）/浮点数（double）string / 对象</li>
</ul>
<p>其中，整数的取值范围和系统的长整数取值范围相同。</p>
<ul>
<li>在32位的操作系统上，整数就是32位的</li>
<li>在64位操作系统上，整数就是64位有符号整数</li>
<li>浮点数的取值范围和IEEE 754标准的双精度浮点数相同</li>
</ul>
<h2 id="简单操作">简单操作<a class="anchor" href="#%e7%ae%80%e5%8d%95%e6%93%8d%e4%bd%9c">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/*    字符串操作键值对    */</span>
</span></span><span style="display:flex;"><span>csRedis.Set(<span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#e6db74">&#34;wangpengliang&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.Set(<span style="color:#e6db74">&#34;name2&#34;</span>, <span style="color:#e6db74">&#34;wangkaining&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.Set(<span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#e6db74">&#34;wangpengliang2&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 根据键获取对应的值</span>
</span></span><span style="display:flex;"><span>csRedis.Get(<span style="color:#e6db74">&#34;name&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 移除元素</span>
</span></span><span style="display:flex;"><span>csRedis.Del(<span style="color:#e6db74">&#34;name2&#34;</span>);</span></span></code></pre></div><p>在对同一个键多次赋值时，该键的值是最后一次赋值时的值，实例中 <code>hello</code> 对应的值最终为<code>wangpengliang2</code>。</p>
<p>由于 <code>Redis</code> 可以对字符串的类型进行“识别”，所以除了对字符串进行增、删、查、之外，我们还可以对整数类型进行自增、自减操作，对字节串的一部分进行读取或者写入。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/*    数值操作    */</span>
</span></span><span style="display:flex;"><span>csRedis.Set(<span style="color:#e6db74">&#34;num-key&#34;</span>, <span style="color:#e6db74">&#34;24&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// value += 5</span>
</span></span><span style="display:flex;"><span>csRedis.IncrBy(<span style="color:#e6db74">&#34;num-key&#34;</span>,<span style="color:#ae81ff">5</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; 29</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// value -= 10</span>
</span></span><span style="display:flex;"><span>csRedis.IncrBy(<span style="color:#e6db74">&#34;num-key&#34;</span>, -<span style="color:#ae81ff">10</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; 19</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*    字节串操作    */</span>
</span></span><span style="display:flex;"><span>csRedis.Set(<span style="color:#e6db74">&#34;string-key&#34;</span>, <span style="color:#e6db74">&#34;hello &#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在指定key的value末尾追加字符串</span>
</span></span><span style="display:flex;"><span>csRedis.Append(<span style="color:#e6db74">&#34;string-key&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; &#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取从指定范围所有字符构成的子串（start:3,end:7）</span>
</span></span><span style="display:flex;"><span>csRedis.GetRange(<span style="color:#e6db74">&#34;string-key&#34;</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">7</span>)  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt;  &#34;lo wo&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 用新字符串从指定位置覆写原value（index:4）</span>
</span></span><span style="display:flex;"><span>csRedis.SetRange(<span style="color:#e6db74">&#34;string-key&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;aa&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; &#34;hellaaword&#34;</span></span></span></code></pre></div><h2 id="非正常情况">非正常情况<a class="anchor" href="#%e9%9d%9e%e6%ad%a3%e5%b8%b8%e6%83%85%e5%86%b5">#</a></h2>
<ul>
<li>对字节串进行自增、自减操作时，redis会报错</li>
<li>使用<code>Append</code>、<code>SetRange</code>方法对 <code>value</code> 写入时，字节串的长度可能不够用，这时redis会使用空字符(<code>null</code> ) 将 <code>value</code>扩充到指定长度，然后再进行写入操作</li>
</ul>
<h2 id="列表list">列表(List)<a class="anchor" href="#%e5%88%97%e8%a1%a8list">#</a></h2>
<blockquote class='book-hint '>
<p>The speed of adding a new element with the <a href="https://redis.io/commands/lpush">LPUSH</a> command to the head of a list with ten elements is the same as adding an element to the head of list with 10 million elements.</p>
<p>译：使用<code>LPUSH</code>命令，向包含10个元素的列表添加新元素的速度等于向包含一千万个元素的列表添加新元素的速度。</p>
</blockquote><ul>
<li>列表可以有序的存储多个字符串操作（字符串可以重复）</li>
<li>列表是通过链表来实现的，所以它添加新元素的速度非常快</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 从右端推入元素</span>
</span></span><span style="display:flex;"><span>csRedis.RPush(<span style="color:#e6db74">&#34;my-list&#34;</span>, <span style="color:#e6db74">&#34;item1&#34;</span>, <span style="color:#e6db74">&#34;item2&#34;</span>, <span style="color:#e6db74">&#34;item3&#34;</span>, <span style="color:#e6db74">&#34;item4&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从右端弹出元素</span>
</span></span><span style="display:flex;"><span>csRedis.RPop(<span style="color:#e6db74">&#34;my-list&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从左端推入元素</span>
</span></span><span style="display:flex;"><span>csRedis.LPush(<span style="color:#e6db74">&#34;my-list&#34;</span>,<span style="color:#e6db74">&#34;LeftPushItem&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从左端弹出元素</span>
</span></span><span style="display:flex;"><span>csRedis.LPop(<span style="color:#e6db74">&#34;my-list&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 遍历链表元素（start:0,end:-1即可返回所有元素）</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> item <span style="color:#66d9ef">in</span> csRedis.LRange(<span style="color:#e6db74">&#34;my-list&#34;</span>, <span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(item);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 按索引值获取元素（当索引值大于链表长度，返回空值，不会报错）</span>
</span></span><span style="display:flex;"><span>Console.WriteLine(<span style="color:#e6db74">$&#34;{csRedis.LIndex(&#34;</span>my-list<span style="color:#e6db74">&#34;, 1)}&#34;</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 修剪指定范围内的元素（start:4,end:10）</span>
</span></span><span style="display:flex;"><span>csRedis.LTrim(<span style="color:#e6db74">&#34;my-list&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">10</span>);</span></span></code></pre></div><p>除了对列表中的元素进行以上简单的处理之外，还可以将一个列表中的元素复制到另一个列表中。在语义上，列表的左端默认为“头部”，列表的右端为“尾部”。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 将my-list最后一个元素弹出并压入another-list的头部</span>
</span></span><span style="display:flex;"><span>csRedis.RPopLPush(<span style="color:#e6db74">&#34;my-list&#34;</span>, <span style="color:#e6db74">&#34;another-list&#34;</span>);</span></span></code></pre></div><h2 id="集合set">集合(Set)<a class="anchor" href="#%e9%9b%86%e5%90%88set">#</a></h2>
<p>集合以无序的方式存储<strong>各不相同</strong>的元素，也就是说在集合中的每个元素的<code>Key</code>都不重复。在 <code>Redis</code>中可以快速地对集合执行添加、移除等操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 实际上只插入了两个元素(&#34;item1&#34;,&#34;item2&#34;)</span>
</span></span><span style="display:flex;"><span>csRedis.SAdd(<span style="color:#e6db74">&#34;my-set&#34;</span>, <span style="color:#e6db74">&#34;item1&#34;</span>, <span style="color:#e6db74">&#34;item1&#34;</span>, <span style="color:#e6db74">&#34;item2&#34;</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 集合的遍历</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> member <span style="color:#66d9ef">in</span> csRedis.SMembers(<span style="color:#e6db74">&#34;my-set&#34;</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">$&#34;集合成员：{member.ToString()}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 判断元素是否存在</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">string</span> member = <span style="color:#e6db74">&#34;item1&#34;</span>;
</span></span><span style="display:flex;"><span>Console.WriteLine(<span style="color:#e6db74">$&#34;{member}是否存在:{csRedis.SIsMember(&#34;</span>my-<span style="color:#66d9ef">set</span><span style="color:#e6db74">&#34;, member)}&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 移除元素</span>
</span></span><span style="display:flex;"><span>csRedis.SRem(<span style="color:#e6db74">&#34;my-set&#34;</span>, member);
</span></span><span style="display:flex;"><span>Console.WriteLine(<span style="color:#e6db74">$&#34;{member}是否存在:{csRedis.SIsMember(&#34;</span>my-<span style="color:#66d9ef">set</span><span style="color:#e6db74">&#34;, member)}&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt;  False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 随机移除一个元素</span>
</span></span><span style="display:flex;"><span>csRedis.SPop(<span style="color:#e6db74">&#34;my-set&#34;</span>);</span></span></code></pre></div><p>以上是对一个集合中的元素进行操作，除此之外还可以对两个集合进行交、并、差操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>csRedis.SAdd(<span style="color:#e6db74">&#34;set-a&#34;</span>, <span style="color:#e6db74">&#34;item1&#34;</span>, <span style="color:#e6db74">&#34;item2&#34;</span>, <span style="color:#e6db74">&#34;item3&#34;</span>,<span style="color:#e6db74">&#34;item4&#34;</span>,<span style="color:#e6db74">&#34;item5&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.SAdd(<span style="color:#e6db74">&#34;set-b&#34;</span>, <span style="color:#e6db74">&#34;item2&#34;</span>, <span style="color:#e6db74">&#34;item5&#34;</span>, <span style="color:#e6db74">&#34;item6&#34;</span>, <span style="color:#e6db74">&#34;item7&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 差集</span>
</span></span><span style="display:flex;"><span>csRedis.SDiff(<span style="color:#e6db74">&#34;set-a&#34;</span>, <span style="color:#e6db74">&#34;set-b&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; &#34;item1&#34;, &#34;item3&#34;,&#34;item4&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 交集</span>
</span></span><span style="display:flex;"><span>csRedis.SInter(<span style="color:#e6db74">&#34;set-a&#34;</span>, <span style="color:#e6db74">&#34;set-b&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; &#34;item2&#34;,&#34;item5&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 并集</span>
</span></span><span style="display:flex;"><span>csRedis.SUnion(<span style="color:#e6db74">&#34;set-a&#34;</span>, <span style="color:#e6db74">&#34;set-b&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; &#34;item1&#34;,&#34;item2&#34;,&#34;item3&#34;,&#34;item4&#34;,&#34;item5&#34;,&#34;item6&#34;,&#34;item7&#34;</span></span></span></code></pre></div><p>另外还可以用 <code>SDiffStore</code>,<code>SInterStore</code>,<code>SUnionStore</code> 将操作后的结果存储在新的集合中。</p>
<h2 id="散列hashmap">散列(HashMap)<a class="anchor" href="#%e6%95%a3%e5%88%97hashmap">#</a></h2>
<p>在 <code>Redis</code> 中可以使用散列将多个键值对存储在一个 <code>key</code> 上，从而达到将一系列相关数据存放在一起的目的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 向散列添加元素</span>
</span></span><span style="display:flex;"><span>csRedis.HSet(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>, <span style="color:#e6db74">&#34;Title&#34;</span>, <span style="color:#e6db74">&#34;了解简单的Redis数据结构&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.HSet(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>, <span style="color:#e6db74">&#34;Author&#34;</span>, <span style="color:#e6db74">&#34;xscape&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.HSet(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>, <span style="color:#e6db74">&#34;PublishTime&#34;</span>, <span style="color:#e6db74">&#34;2019-01-01&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 根据Key获取散列中的元素</span>
</span></span><span style="display:flex;"><span>csRedis.HGet(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>, <span style="color:#e6db74">&#34;Title&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取散列中的所有元素</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> item <span style="color:#66d9ef">in</span> csRedis.HGetAll(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(item.Value);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>HGet</code>和<code>HSet</code>方法执行一次只能处理一个键值对，而<code>HMGet</code>和<code>HMSet</code>是他们的多参数版本，一次可以处理多个键值对。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> keys = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] { <span style="color:#e6db74">&#34;Title&#34;</span>,<span style="color:#e6db74">&#34;Author&#34;</span>,<span style="color:#e6db74">&#34;publishTime&#34;</span>};
</span></span><span style="display:flex;"><span>csRedis.HMGet(<span style="color:#e6db74">&#34;ID:10001&#34;</span>, keys);</span></span></code></pre></div><p>虽然使用<code>HGetAll</code>可以取出所有的value，但是<strong>有时候散列包含的值可能非常大，容易造成服务器的堵塞</strong>，为了避免这种情况，我们可以使用<code>HKeys</code>取到散列的所有键(<em><code>HVals可以取出所有值</code></em>)，然后再使用 <code>HGet</code>方法一个一个地取出键对应的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> item <span style="color:#66d9ef">in</span> csRedis.HKeys(<span style="color:#e6db74">&#34;ID:10001&#34;</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Console.WriteLine(<span style="color:#e6db74">$&#34;{item} - {csRedis.HGet(&#34;</span>ID:<span style="color:#ae81ff">10001</span><span style="color:#e6db74">&#34;, item)}&#34;</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>和处理字符串一样，也可以对散列中的值进行自增、自减操作，原理同字符串是一样的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>csRedis.HSet(<span style="color:#e6db74">&#34;ArticleID:10001&#34;</span>, <span style="color:#e6db74">&#34;votes&#34;</span>, <span style="color:#e6db74">&#34;257&#34;</span>);
</span></span><span style="display:flex;"><span>csRedis.HIncrBy(<span style="color:#e6db74">&#34;ID:10001&#34;</span>, <span style="color:#e6db74">&#34;votes&#34;</span>, <span style="color:#ae81ff">40</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// output -&gt; 297</span></span></span></code></pre></div><h2 id="有序集合">有序集合<a class="anchor" href="#%e6%9c%89%e5%ba%8f%e9%9b%86%e5%90%88">#</a></h2>
<p>有序集合可以看作是可排序的散列，不过有序集合的 <code>val</code> 成为<code>score</code> 分值，集合内的元素就是基于<code>score</code> 进行排序的，<code>score</code> 以双精度浮点数的格式存储。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 向有序集合添加元素</span>
</span></span><span style="display:flex;"><span>csRedis.ZAdd(<span style="color:#e6db74">&#34;Quiz&#34;</span>, (<span style="color:#ae81ff">79</span>, <span style="color:#e6db74">&#34;Math&#34;</span>));
</span></span><span style="display:flex;"><span>csRedis.ZAdd(<span style="color:#e6db74">&#34;Quiz&#34;</span>, (<span style="color:#ae81ff">98</span>, <span style="color:#e6db74">&#34;English&#34;</span>));
</span></span><span style="display:flex;"><span>csRedis.ZAdd(<span style="color:#e6db74">&#34;Quiz&#34;</span>, (<span style="color:#ae81ff">87</span>, <span style="color:#e6db74">&#34;Algorithm&#34;</span>));
</span></span><span style="display:flex;"><span>csRedis.ZAdd(<span style="color:#e6db74">&#34;Quiz&#34;</span>, (<span style="color:#ae81ff">84</span>, <span style="color:#e6db74">&#34;Database&#34;</span>));
</span></span><span style="display:flex;"><span>csRedis.ZAdd(<span style="color:#e6db74">&#34;Quiz&#34;</span>, (<span style="color:#ae81ff">59</span>, <span style="color:#e6db74">&#34;Operation System&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//返回集合中的元素数量</span>
</span></span><span style="display:flex;"><span>csRedis.ZCard(<span style="color:#e6db74">&#34;Quiz&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取集合中指定范围(90~100)的元素集合</span>
</span></span><span style="display:flex;"><span>csRedis.ZRangeByScore(<span style="color:#e6db74">&#34;Quiz&#34;</span>,<span style="color:#ae81ff">90</span>,<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取集合所有元素并升序排序</span>
</span></span><span style="display:flex;"><span>csRedis.ZRangeWithScores(<span style="color:#e6db74">&#34;Quiz&#34;</span>, <span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 移除集合中的元素</span>
</span></span><span style="display:flex;"><span>csRedis.ZRem(<span style="color:#e6db74">&#34;Quiz&#34;</span>, <span style="color:#e6db74">&#34;Math&#34;</span>);</span></span></code></pre></div><h2 id="事务">事务<a class="anchor" href="#%e4%ba%8b%e5%8a%a1">#</a></h2>
<p>事务可以保证一个客户端在执行多条命令时，不被其他客户端打断，这跟关系型数据库的事务是不一样的。事务需要使用 <code>MULTI</code> 和 <code>EXEC</code> 命令，<code>Redis</code> 会将被<code>MULTI</code> 和 <code>EXEC</code>所包围的代码依次执行，当该事务结束之后才会处理其他客户端的命令。</p>
<p><strong>管道(pipeline)</strong></p>
<p><code>Redis</code> 的事务是通过 <code>pipeline</code> 实现的，使用时客户端会自动调用 <code>MULTI</code> 和 <code>EXEX</code> 命令，<strong>将多条命令打包并一次性地发送给 <code>Redis</code>，然后 <code>Redis</code>再将命令的执行结果全部打包并一次性返回给客户端</strong>，这样有效的减少了Redis与客户端的通信次数，提升执行多次命令时的性能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 事务处理</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e"> [TestMethod]</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Transaction()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> strKey = Guid.NewGuid().ToString();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> strval = Faker.Name.FullName();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> intKey = Guid.NewGuid().ToString();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> intVal = Faker.RandomNumber.Next(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> one
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第一种方式:正常情况下redis命令批处理,返回[true,true]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">object</span>[] result = csRedis.StartPipe()
</span></span><span style="display:flex;"><span>                .Set(strKey, strval)
</span></span><span style="display:flex;"><span>                .Set(intKey, intVal)
</span></span><span style="display:flex;"><span>                .EndPipe();
</span></span><span style="display:flex;"><span>            Console.WriteLine(JsonConvert.SerializeObject(result));
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> two
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第二种方式：对string类型进行IncrBy操作,会抛出异常但不影响执行,返回[false, false, null]; Redis中多了两条数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">object</span>[] result2 = csRedis.StartPipe()
</span></span><span style="display:flex;"><span>                .Set(strKey, strval)
</span></span><span style="display:flex;"><span>                .Set(intKey, intVal)
</span></span><span style="display:flex;"><span>                .IncrBy(strKey, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>                .EndPipe();
</span></span><span style="display:flex;"><span>            Console.WriteLine(JsonConvert.SerializeObject(result2));
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> three
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第三种方式：对string类型进行IncrBy操作,错误的命令不被执行,Redis中多了两条数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">using</span> var rc = csRedis.Nodes.First().Value.Get();
</span></span><span style="display:flex;"><span>            rc.Value.Multi();
</span></span><span style="display:flex;"><span>            rc.Value.SAdd(strKey, strval);
</span></span><span style="display:flex;"><span>            rc.Value.SAdd(intKey, intVal);
</span></span><span style="display:flex;"><span>            rc.Value.SAdd(strKey, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 此时报错：EXEC  ---&gt; CSRedis.RedisException: WRONGTYPE Operation against a key holding the wrong kind of value</span>
</span></span><span style="display:flex;"><span>            rc.Value.Exec();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if</span> four
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第四种方式：对string类型进行IncrBy操作,错误的命令不被执行,Redis中多了两条数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> tran = csRedis.StartPipe();
</span></span><span style="display:flex;"><span>            tran.Set(strKey, strval);
</span></span><span style="display:flex;"><span>            tran.Set(intKey, intVal);
</span></span><span style="display:flex;"><span>            tran.IncrBy(strKey, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> b = tran.EndPipe();
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>        }</span></span></code></pre></div><h2 id="key的过期">Key的过期<a class="anchor" href="#key%e7%9a%84%e8%bf%87%e6%9c%9f">#</a></h2>
<p>Redis允许为key设置有效期，当key过期之后，key就不存在了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[TestMethod]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> KeyExpire()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> key = <span style="color:#e6db74">&#34;name&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span> = <span style="color:#e6db74">&#34;wangpengliang&#34;</span>;
</span></span><span style="display:flex;"><span>    csRedis.Set(key, <span style="color:#66d9ef">value</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    csRedis.Expire(key, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> result = csRedis.Get(key);
</span></span><span style="display:flex;"><span>    Assert.AreEqual(<span style="color:#66d9ef">value</span>, result);
</span></span><span style="display:flex;"><span>    Thread.Sleep(<span style="color:#ae81ff">4000</span>);
</span></span><span style="display:flex;"><span>    result = csRedis.Get(key);
</span></span><span style="display:flex;"><span>    Assert.AreEqual(<span style="color:#66d9ef">null</span>, result);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h2 id="分区">分区<a class="anchor" href="#%e5%88%86%e5%8c%ba">#</a></h2>
<p>多个服务节点共同分担存储，与官方的分区、集群、高可用方案不同。</p>
<blockquote class='book-hint '>
<p>例如：缓存数据达到500G，如果使用一台redis-server服务器光靠内存存储将非常吃力，使用硬盘又影响性能。
可以使用此功能自动管理N台redis-server服务器分担存储，每台服务器只需约 (500/N)G 内存，且每台服务器匀可以配置官方高可用架构。</p>
</blockquote><pre tabindex="0"><code>var rds = new CSRedis.CSRedisClient(null,
  &#34;127.0.0.1:6371,password=123,defaultDatabase=11,poolsize=10,ssl=false,writeBuffer=10240,prefix=key前辍&#34;, 
  &#34;127.0.0.1:6372,password=123,defaultDatabase=12,poolsize=11,ssl=false,writeBuffer=10240,prefix=key前辍&#34;,
  &#34;127.0.0.1:6373,password=123,defaultDatabase=13,poolsize=12,ssl=false,writeBuffer=10240,prefix=key前辍&#34;,
  &#34;127.0.0.1:6374,password=123,defaultDatabase=14,poolsize=13,ssl=false,writeBuffer=10240,prefix=key前辍&#34;);
//实现思路：根据key.GetHashCode() % 节点总数量，确定连向的节点
//也可以自定义规则(第一个参数设置)

rds.MSet(&#34;key1&#34;, 1, &#34;key2&#34;, 2, &#34;key3&#34;, 3, &#34;key4&#34;, 4);
rds.MGet(&#34;key1&#34;, &#34;key2&#34;, &#34;key3&#34;, &#34;key4&#34;);</code></pre><h2 id="发布订阅">发布订阅<a class="anchor" href="#%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85">#</a></h2>
<pre tabindex="0"><code>//普通订阅
rds.Subscribe(
  (&#34;chan1&#34;, msg =&gt; Console.WriteLine(msg.Body)),
  (&#34;chan2&#34;, msg =&gt; Console.WriteLine(msg.Body)));

//模式订阅（通配符）
rds.PSubscribe(new[] { &#34;test*&#34;, &#34;*test001&#34;, &#34;test*002&#34; }, msg =&gt; {
  Console.WriteLine($&#34;PSUB   {msg.MessageId}:{msg.Body}    {msg.Pattern}: chan:{msg.Channel}&#34;);
});
//模式订阅已经解决的难题：
//1、分区的节点匹配规则，导致通配符最大可能匹配全部节点，所以全部节点都要订阅
//2、本组 &#34;test*&#34;, &#34;*test001&#34;, &#34;test*002&#34; 订阅全部节点时，需要解决同一条消息不可执行多次

//发布
rds.Publish(&#34;chan1&#34;, &#34;123123123&#34;);
//无论是分区或普通模式，rds.Publish 都可以正常通信</code></pre><h2 id="缓存壳">缓存壳<a class="anchor" href="#%e7%bc%93%e5%ad%98%e5%a3%b3">#</a></h2>
<pre tabindex="0"><code>        /// &lt;summary&gt;
        /// 缓存壳
        /// &lt;/summary&gt;
        [TestMethod]
        public void CacheShell()
        {
            string value = &#34;wangpengliang&#34;;
#if debug
            // 一般的缓存代码，如不封装比较繁琐
            var cacheValue = csRedis.Get(&#34;name&#34;);
            // 如果已被缓存
            if (!string.IsNullOrEmpty(cacheValue))
            {
                try
                {
                    // 
                }
                catch
                {
                    //出错时删除key
                    csRedis.Del(&#34;name&#34;);
                    throw;
                }
            }
            else
            {
                csRedis.Set(&#34;name&#34;, value, 10);
            }
#endif
            // 判断key=name是否已存在,存在返回value,不存在设置
            string t1 = csRedis.CacheShell(&#34;name&#34;, 10, () =&gt; value);
            Assert.AreEqual(value, t1);
            string t2 = csRedis.CacheShell(&#34;name&#34;, 10, () =&gt; &#34;wangpengliang2&#34;);
            Assert.AreEqual(value, t2);
            string t3 = csRedis.CacheShell(&#34;name2&#34;, 10, () =&gt; &#34;wangpengliang2&#34;);
            Assert.AreEqual(&#34;wangpengliang2&#34;, t3);
        }</code></pre><h2 id="管道">管道<a class="anchor" href="#%e7%ae%a1%e9%81%93">#</a></h2>
<p>使用管道模式，打包多条命令一起执行，从而提高性能。</p>
<pre tabindex="0"><code>var ret1 = rds.StartPipe().Set(&#34;a&#34;, &#34;1&#34;).Get(&#34;a&#34;).EndPipe();
var ret2 = rds.StartPipe(p =&gt; p.Set(&#34;a&#34;, &#34;1&#34;).Get(&#34;a&#34;));

var ret3 = rds.StartPipe().Get(&#34;b&#34;).Get(&#34;a&#34;).Get(&#34;a&#34;).EndPipe();
//与 rds.MGet(&#34;b&#34;, &#34;a&#34;, &#34;a&#34;) 性能相比，经测试差之毫厘</code></pre><h2 id="多数据库">多数据库<a class="anchor" href="#%e5%a4%9a%e6%95%b0%e6%8d%ae%e5%ba%93">#</a></h2>
<blockquote class='book-hint '>
<p>如果确定一定以及肯定非要有切换数据库的需求，请看以下代码：通过定义多个CSRedisClient实现</p>
</blockquote><pre tabindex="0"><code>/// &lt;summary&gt;
/// 多数据库,使用多个CSRedisClient实现
/// &lt;/summary&gt;
[TestMethod]
public void MultiDatabase()
{
    // 实际使用必须要单例
    CSRedisClient[] redis = new CSRedisClient[14];
    for (int i = 0; i &lt; redis.Length; i++)
    {
        redis[i] = new CSRedisClient($&#34;{redisConnection},defaultDatabase={i}&#34;);
    }

    redis[0].Set(&#34;db0&#34;, &#34;db0&#34;);
    string t1 = redis[0].Get(&#34;db0&#34;);
    Assert.AreEqual(&#34;db0&#34;, t1);


    redis[1].Set(&#34;db1&#34;, &#34;db1&#34;);
    string t2 = redis[1].Get(&#34;db1&#34;);
    Assert.AreEqual(&#34;db1&#34;, t2);

    redis[2].Set(&#34;db2&#34;, &#34;db2&#34;);
    string t3 = redis[2].Get(&#34;db2&#34;);
    Assert.AreEqual(&#34;db2&#34;, t3);
}</code></pre></div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">
  <div>
  
    <a href="/posts/redis/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAredis%E9%9B%86%E7%BE%A4/" class="flex align-center">
      <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
      <span>使用 Docker搭建 Redis集群</span>
    </a>
  
  </div>
  <div>
  
    <a href="/posts/test/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" class="flex align-center">
      <span>单元测试</span>
      <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
    </a>
  
  </div>
</div>
 
        
  
 
        
        
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
  <aside class="book-toc">
    <div class="book-toc-content">
      
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#安装">安装</a></li>
    <li><a href="#封装">封装</a></li>
  </ul>

  <ul>
    <li><a href="#安装-1">安装</a></li>
    <li><a href="#初始化">初始化</a></li>
    <li><a href="#字符串string">字符串(string)</a></li>
    <li><a href="#简单操作">简单操作</a></li>
    <li><a href="#非正常情况">非正常情况</a></li>
    <li><a href="#列表list">列表(List)</a></li>
    <li><a href="#集合set">集合(Set)</a></li>
    <li><a href="#散列hashmap">散列(HashMap)</a></li>
    <li><a href="#有序集合">有序集合</a></li>
    <li><a href="#事务">事务</a></li>
    <li><a href="#key的过期">Key的过期</a></li>
    <li><a href="#分区">分区</a></li>
    <li><a href="#发布订阅">发布订阅</a></li>
    <li><a href="#缓存壳">缓存壳</a></li>
    <li><a href="#管道">管道</a></li>
    <li><a href="#多数据库">多数据库</a></li>
  </ul>
</nav>



    </div>
  </aside>
  
 
  </main>

  
</body>
</html>




















