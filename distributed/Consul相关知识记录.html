<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Wang’Notes’
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-exp.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 5.4.0"></head>

  <body>

    <div class="book-container">
      <div class="book-sidebar">
        <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>WANG’NOTES’</span>
  </a>
</div>
          <div id="menu" class="book-menu hide">
  <ul>
<li><a href="/index">Home</a></li>
</ul>
<h2 id="DotNET">DotNET</h2>
<ul>
<li>
<p>C#基础</p>
<ul>
<li><a href="/dotnet/%E5%9F%BA%E7%A1%80%E5%90%88%E9%9B%86">基础合集</a></li>
<li><a href="/dotnet/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">常用数据结构</a></li>
<li><a href="/dotnet/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%85%B3%E7%B3%BB">类和对象的关系</a></li>
<li><a href="/dotnet/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%BC%80%E5%8F%91">面向对象开发</a></li>
</ul>
</li>
<li>
<p>C#进阶</p>
<ul>
<li><a href="/dotnet/%E6%B3%9B%E5%9E%8B%E6%8A%80%E6%9C%AF">泛型技术</a></li>
<li><a href="/dotnet/%E5%8F%8D%E5%B0%84%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5">反射技术实践</a></li>
<li><a href="/dotnet/%E5%A7%94%E6%89%98%E5%92%8C%E4%BA%8B%E4%BB%B6%E8%AF%A6%E8%A7%A3">委托和事件详解</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91">多线程开发</a></li>
<li><a href="/dotnet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E6%8A%80%E6%9C%AF">多线程之线程同步技术</a></li>
<li><a href="/dotnet/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B">异步编程async/await</a></li>
<li><a href="/dotnet/%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D">值类型和引用类型的内存分配</a></li>
<li><a href="/dotnet/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B">并行编程</a></li>
</ul>
</li>
<li>
<p>NetCore</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="http://Asp.Net">Asp.Net</a> Mvc</p>
</li>
<li>
<p>DataProtection</p>
<ul>
<li><a href="">1.1 DataProtection简介</a></li>
<li><a href="">1.2 DataProtection方法介绍</a></li>
<li><a href="">1.3 落地实践及多环境调试</a></li>
<li><a href="">1.4 UserSecrets</a></li>
<li><a href="">1.5 基于DataProtection的数据保护方案</a></li>
<li><a href="">1.6 方案实践及集成AzureDevops管道</a></li>
</ul>
</li>
</ul>
<h2 id="Linux">Linux</h2>
<ul>
<li><a href="/linux/Centos%E5%AE%89%E8%A3%85">Centos安装</a></li>
<li><a href="/linux/Centos%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">Centos网络配置</a></li>
<li><a href="/linux/Centos7%E5%8D%87%E7%BA%A7gcc%E7%89%88%E6%9C%AC">Centos7升级gcc版本</a></li>
<li><a href="/linux/Linux%E7%9B%AE%E5%BD%95%E8%AF%B4%E6%98%8E">Linux目录说明</a></li>
<li><a href="/linux/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">Linux常用命令</a></li>
</ul>
<h2 id="Redis">Redis</h2>
<ul>
<li><a href="/redis/1.1NoSql%E6%A6%82%E8%BF%B0">1.1 NoSql概述</a></li>
<li><a href="/redis/1.2Redis%E5%AE%89%E8%A3%85">1.2 Redis安装</a></li>
<li><a href="/redis/1.3Redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.3 Redis基本数据类型</a></li>
<li><a href="/redis/1.4Redis%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">1.4 Redis特殊数据类型</a></li>
<li><a href="/redis/1.5Redis%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C">1.5 Redis事务操作</a></li>
<li><a href="/redis/1.6Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">1.6 Redis配置文件详解</a></li>
<li><a href="/redis/1.7Redis%E6%8C%81%E4%B9%85%E5%8C%96">1.7 Redis持久化</a></li>
<li><a href="/redis/1.8Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85">1.8 Redis发布订阅</a></li>
<li><a href="/redis/1.9Redis%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 Redis集群方案</a></li>
<li><a href="/redis/1.10Redis%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.10 Redis常见问题</a></li>
<li><a href="/redis/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5Redis">客户端连接Redis</a></li>
<li><a href="/redis/%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BARedis%E9%9B%86%E7%BE%A4">使用Docker搭建Redis集群</a></li>
</ul>
<h2 id="RabbitMQ">RabbitMQ</h2>
<ul>
<li><a href="/rabbitMq/1.1RabbitMQ%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 RabbitMQ概念及安装</a></li>
<li><a href="/rabbitMq/1.2%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D">1.2 工作模式介绍</a></li>
<li><a href="/rabbitMq/1.3%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E5%8F%8A%E6%8C%81%E4%B9%85%E5%8C%96">1.3 消息确认及持久化</a></li>
<li><a href="/rabbitMq/1.4%E4%B8%A4%E7%A7%8D%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F%E5%92%8CQOS%E7%9A%84%E5%AE%9E%E7%8E%B0">1.4 两种消费模式和QOS的实现</a></li>
<li><a href="/rabbitMq/1.5Channel%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95">1.5 Channel常见方法</a></li>
<li><a href="/rabbitMq/1.6RabbitMQ%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">1.6 RabbitMQ常用命令</a></li>
<li><a href="/rabbitMq/1.7RabbitMQ%E5%B8%B8%E8%A7%81%E7%AD%96%E7%95%A5">1.7 RabbitMQ常见策略</a></li>
<li><a href="/rabbitMq/1.8RabbitMQ%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">1.8 RabbitMQ常见问题</a></li>
<li><a href="/rabbitMq/1.9RabbitMQ%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88">1.9 RabbitMQ集群方案</a></li>
<li><a href="/rabbitMq/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5RabbitMQ">客户端连接RabbitMQ</a></li>
</ul>
<h2 id="Docker">Docker</h2>
<ul>
<li><a href="/docker/1.1Docker%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%AE%89%E8%A3%85">1.1 Docker概念及安装</a></li>
<li><a href="/docker/1.2Docker%E9%95%9C%E5%83%8F(Image)">1.2 Docker镜像(Image)</a></li>
<li><a href="/docker/1.3Docker%E5%AE%B9%E5%99%A8(Container)">1.3 Docker容器(Container)</a></li>
<li><a href="/docker/1.4Docker%E4%BB%93%E5%BA%93(Repository)">1.4 Docker仓库(Repository)</a></li>
<li><a href="/docker/1.5Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">1.5 Docker数据管理</a></li>
<li><a href="/docker/1.6Docker%E5%AE%B9%E5%99%A8%E5%9B%9B%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F">1.6 Docker容器四种网络模式</a></li>
<li><a href="/docker/1.7Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">1.7 Docker高级网络配置</a></li>
<li><a href="/docker/1.8Dockerfile">1.8 Dockerfile</a></li>
<li><a href="/docker/1.9Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerCompose">1.9 Docker三剑客之DockerCompose</a></li>
<li><a href="/docker/2.0Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerMachine">2.0 Docker三剑客之DockerMachine</a></li>
<li><a href="/docker/2.1Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDockerSwarm">2.1 Docker三剑客之DockerSwarm</a></li>
<li><a href="/docker/2.2Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">2.2 Docker常用命令</a></li>
<li><a href="/docker/Portainer%E5%8F%AF%E8%A7%86%E5%8C%96%E9%9D%A2%E6%9D%BF">Portainer可视化面板</a></li>
</ul>
<h2 id="分布式相关">分布式相关</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">分布式事务</a></li>
<li><a href="/%E5%9F%BA%E7%A1%80/1">分布式锁</a></li>
<li><a href="/%E5%9F%BA%E7%A1%80/1">分布式缓存</a></li>
<li><a href="/distributed/Consul%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E8%AE%B0%E5%BD%95">Consul 相关知识记录</a></li>
</ul>
<h2 id="UnitTest">UnitTest</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">Categories</a></li>
</ul>
<h2 id="23种设计模式">23种设计模式</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">Categories</a></li>
</ul>
<h2 id="SonarQube-代码质量把控">SonarQube 代码质量把控</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">Categories</a></li>
</ul>
<h2 id="Devops工具-AzureDevops">Devops工具 AzureDevops</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">Categories</a></li>
</ul>
<h2 id="Devops工具-Jenkins">Devops工具 Jenkins</h2>
<ul>
<li><a href="/%E5%9F%BA%E7%A1%80/1">Categories</a></li>
</ul>
<h2 id="示例项目：Microservice-Sample">示例项目：Microservice.Sample</h2>
<ul>
<li><a href="/sample/microservice/1.1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA">1.1 微服务入门：项目搭建</a></li>
<li><a href="/sample/microservice/1.2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0">1.2 微服务入门：服务注册与发现（Consul）</a></li>
<li><a href="/sample/microservice/1.3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E7%BD%91%E5%85%B3">1.3 微服务入门：网关（Ocelot）</a></li>
<li><a href="/sample/microservice/1.4%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8B%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF">1.4 微服务入门：事件总线（CAP）</a></li>
<li><a href="/sample/microservice/1.5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A5%E9%97%A8%E4%B9%8BDockerCompose">1.5 微服务入门：DockerCompose</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

      </div>

      <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

        <div class="off-canvas-content">
          <div class="columns">
            <div class="column col-10 col-lg-12">
              <div class="book-navbar">
                <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

              </div>
              <div class="book-content">
                
<article id="page">
  <h1></h1>
  <p>官网地址：<a target="_blank" rel="noopener" href="https://www.consul.io">https://www.consul.io</a></p>
<h1 id="1-使用-Consul">1. 使用 Consul</h1>
<h2 id="1-1-简介">1.1 简介</h2>
<p>Consul 是一个支持多数据中心分布式高可用的服务发现和配置共享的服务软件，由 HashiCorp 公司用 Go 语言开发, 基于 Mozilla Public License 2.0 的协议进行开源。 Consul 支持 健康检查，并允许 HTTP 、GRPC 和 DNS 协议调用 API 存储键值对。 一致性协议采用 Raft 算法,用来保证服务的高可用。使用 GOSSIP 协议管理成员和广播消息，并且支持 ACL 访问控制。</p>
<p>Consul 包含多个组件，但作为整体来看的话主要功能是：为基础设施提供服务发现和服务配置的工具，主要提供以下关键特性：</p>
<ul>
<li><strong>服务发现</strong>：Consul 的客户端用于注册服务，其他的客户端可以通过 Consul 来中找到这个注册的服务（使用 DNS 或 HTTP）</li>
<li><strong>健康检查</strong>：Consul 客户端可以提供任意数量的健康检查，要么与给定的服务相关联（“网络服务器是否返回 200 OK”），要么与本地节点（“内存利用率是否低于 90%”）相关联。可以通过这个信息来监控集群健康状况，并且服务发现组件可以使用它来避免将请求路由到了不健康的主机上</li>
<li><strong>KV 存储</strong>：应用程序可以将 Consul 的分层键/值存储用于多种目的，包括动态配置、功能标记、协调、领导选举等。简单的 HTTP API 使其易于使用。</li>
<li><strong>安全服务通信</strong>：Consul 可以为服务生成和分发 TLS 证书，以建立相互的 TLS 连接。 <a target="_blank" rel="noopener" href="https://www.consul.io/docs/connect/intentions">意图</a> 可用于定义允许哪些服务进行通信。可以通过实时更改意图轻松管理服务分段，而不是使用复杂的网络拓扑和静态防火墙规则</li>
<li><strong>多数据中心</strong>：Consul 支持开箱即用的多个数据中心。这意味着 Consul 的用户不必担心构建额外的抽象层以扩展到多个区域</li>
</ul>
<h2 id="1-2-Consul-Agent">1.2 Consul Agent</h2>
<p>每个为 Consul 提供服务的节点都会运行一个 Consul agent，启动 Consul 必须运行 agent（可以选择运行为 <code>Server</code> 或 <code>Client</code> 模式。每个数据中心至少要有一台 <code>Server</code>，一个 <code>Client</code>是一个非常轻量级的进程，用于注册服务，运行健康检查和转发对 <code>Server</code> 的查询） 这个 agent 功能主要在于：</p>
<ol>
<li>负责对节点上的服务以及节点本身进行健康检查</li>
<li>agent 会与一台或多台 Consul Server 保持通信（Consul Server 用于存储和复制数据）</li>
<li>Server 会自己选举一个 Leader。虽然 Consul 可以在一台服务器上运行，但建议使用 3 到 5 台以达到高可用。建议为每个数据中心启用 Consul Server集群</li>
<li>Server 维护一个目录，这个目录保存着所有 Agent 提交的信息，包括哪些服务可用、哪些节点运行哪些服务、运行状况信息等。可以在<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/anti-entropy#catalog">此处</a>找到 Agent 和目录的交互方式</li>
</ol>
<p>当需要查找 Consul 中注册的服务或者各节点的基础设施组件时可以查询任何 Consul Server 或者 任何 Consul 代理。代理自动将查询转发到 Server。</p>
<p>每个数据中心都运行一个 Consul 服务器集群。当进行跨数据中心的服务发现或配置请求时，本地 Consul Server 将请求转发到远程数据中心并返回结果。</p>
<h2 id="1-3-Consul-对比">1.3 Consul 对比</h2>
<p>针对服务注册发现有很多中间件都可以做，比如 <code>zookeeper</code>  、<code>Etcd</code> 、<code>doozerd</code> 、<code>eureka</code>，Consul 相比于这些软件优势在于：</p>
<ul>
<li>使用 <code>Raft</code> 算法来保证一致性：<code>Raft</code> 比复杂的 <code>Paxos</code> 算法更直接。（<code>zookeeper</code> 采用的是 <code>Paxos</code>,  <code>etcd</code> 使用的则是 <code>Raft</code>）</li>
<li>支持多数据中心：内外网服务采用不同端口进行监听，多数据中心集群可以避免单数据中心的单点故障。（<code>zookeeper</code> 和 <code>etcd</code> 不支持多数据中心）</li>
<li>支持健康检查： <code>etcd</code> 不支持此功能</li>
<li>支持 <code>HTTP</code>/<code>DNS</code> /<code>GPRS</code> 协议接口： <code>zookeeper</code> 集成比较复杂，<code>etcd</code> 只支持 <code>http 协议</code></li>
<li>官方提供 WEB 管理界面，etcd 无此功能</li>
</ul>
<p>综合比较，Consul 作为服务注册和配置管理的新星，还是比较值得关注和研究的。官网：<a target="_blank" rel="noopener" href="https://www.consul.io/docs/intro/vs/chef-puppet">Consul Vs Other Software </a>。</p>
<h2 id="1-4-Consul-架构">1.4 Consul 架构</h2>
<p><img src="../images/2021-09-20-04-10-46.png" alt=""></p>
<p>上图是官网给出的 Consul 架构图，简单了解一下这张图。首先可以看到有两个数据中心，分别标注为 &quot;DATACENTER1&quot;和 “DATACENTER2”。Consul对多个数据中心有天然非常好的支持，并推荐这么做。</p>
<p>每个数据中心内都混合着 <code>Client</code> 和 <code>Server</code>。推荐是3到5台 Server。这是在权衡故障场景下可用性和性能之间取得平衡给出的建议（随着机器的增加，共识的速度会逐渐变慢）。但Client 的数量没有限制的可以轻松地扩展到数千或数万。</p>
<p>所有在数据中心的代理都会参与一个<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/gossip%E3%80%81"><strong>Gossip</strong>协议</a>。这代表有一个 <code>Gossip</code> 池，其中保存着这个数据中心的所有 Agent。这么做目的在于：</p>
<ol>
<li>客户端不需要配置 Server地址，发现工作是自动完成的</li>
<li>检测代理故障的工作不放在单个Server上而是分布式的，使得故障检测的扩展性比原生的心跳方案要强得多。同时还为节点提供了故障检测，如果代理无法到达，那么该节点可能已经发生了故障</li>
<li>它被用作消息层，当发生重要事件（如Leader 选举）时进行通知</li>
</ol>
<p>每个数据中心的 Server 都会参与共同选举出一个 Leader，如果一个 Server 被选中为 Leader 那它会有额外的职责：<strong>Leader负责处理所有查询和事务</strong>。事务也会复制到所有参与选举的 Server。由于这个要求，当 <code>None-Leader Server</code> 收到RPC请求时，会将其转发给集群Leader。</p>
<blockquote>
<p>The server agents also operate as part of a WAN gossip pool. This pool is different from the LAN pool as it is optimized for the higher latency of the internet and is expected to contain only other Consul server agents. The purpose of this pool is to allow datacenters to discover each other in a low-touch manner. Bringing a new datacenter online is as easy as joining the existing WAN gossip pool. Because the servers are all operating in this pool, it also enables cross-datacenter requests. When a server receives a request for a different datacenter, it forwards it to a random server in the correct datacenter. That server may then forward to the local leader.</p>
<p>This results in a very low coupling between datacenters, but because of failure detection, connection caching and multiplexing, cross-datacenter requests are relatively fast and reliable.</p>
<p>In general, data is not replicated between different Consul datacenters. When a request is made for a resource in another datacenter, the local Consul servers forward an RPC request to the remote Consul servers for that resource and return the results. If the remote datacenter is not available, then those resources will also not be available, but that won’t otherwise affect the local datacenter. There are some special situations where a limited subset of data can be replicated, such as with Consul’s built-in <a target="_blank" rel="noopener" href="https://learn.hashicorp.com/tutorials/consul/access-control-replication-multiple-datacenters">ACL replication</a> capability, or external tools like <a target="_blank" rel="noopener" href="https://github.com/hashicorp/consul-replicate">consul-replicate</a>.</p>
<p>In some places, client agents may cache data from the servers to make it available locally for performance and reliability. Examples include Connect certificates and intentions which allow the client agent to make local decisions about inbound connection requests without a round trip to the servers. Some API endpoints also support optional result caching. This helps reliability because the local agent can continue to respond to some queries like service-discovery or Connect authorization from cache even if the connection to the servers is disrupted or the servers are temporarily unavailable.</p>
</blockquote>
<h2 id="1-5-Consul-安装">1.5 Consul 安装</h2>
<p>安装 Consul 没什么难度。具体参考官网：<a target="_blank" rel="noopener" href="https://www.consul.io/docs/install">Consul 安装</a> ，这里只记录如何使用 Docker 安装 Consul。</p>
<p>准备consul镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull consul <span class="comment"># 默认拉取latest</span></span><br><span class="line">docker pull consul:1.6.1 <span class="comment"># 拉取指定版本</span></span><br></pre></td></tr></table></figure>
<p>Consul 镜像提供了几个个常用环境变量</p>
<ul>
<li><code>CONSUL_CLIENT_INTERFACE</code> ：配置 Consul 的 <code>-client=&lt;interface ip&gt; </code>命令参数</li>
<li><code>CONSUL_BIND_INTERFACE</code>：配置 Consul 的 <code>-bind=&lt;interface ip&gt;</code>命令参数</li>
<li><code>CONSUL_DATA_DIR</code> ：配置 Consul 的数据持久化目录</li>
<li><code>CONSUL_CONFIG_DIR</code>：配置 Consul 的配置文件目录</li>
</ul>
<h2 id="1-6-Consul-单机">1.6 Consul 单机</h2>
<p>先启动一个单机版 Consul，由于是单机模式选择 <code>Server</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-01 coresrc]# docker run -d  --name=consul -p 8500:8500 consul  agent -server -bootstrap -ui -node=1 -client=&#x27;0.0.0.0&#x27;</span><br><span class="line">355be46f502ca9f9e1498022e4c86fabf96c9e72b161cf4c71deff9c2012338b</span><br><span class="line">[root@centos-01 coresrc]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                                                                         NAMES</span><br><span class="line">355be46f502c   consul    &quot;docker-entrypoint.s…&quot;   4 seconds ago   Up 3 seconds   8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp, :::8500-&gt;8500/tcp   consul</span><br><span class="line">[root@centos-01 coresrc]# </span><br></pre></td></tr></table></figure>
<ul>
<li><code>agent</code>：启动 agent 进程（前面提过启动 Consul 必须运行 agent）</li>
<li><code>-server</code>：以 <code>Server</code>  模式启动</li>
<li><code>-client</code>：以 <code> Cilent</code> 模式启动</li>
<li><code>bootstrap</code>：表示这个节点是 <code>Server-Leader</code> ，上面说过正常情况下 Leader 是通过 Raft 算法选举出来的，但是集群第一次启动时需要一个引导 Leader，在引导群集后，就不要使用此标志了</li>
<li><code>ui</code>：启动 Web UI 管理器（默认开放端口 <code>8500</code>）</li>
<li><code>node</code>：节点名称（集群中必须是唯一的，默认是该节点的主机名）</li>
<li><code>client</code>：consul 服务监听地址（这个地址提供 HTTP、DNS、RPC 等服务，默认是 <code>127.0.0.1</code> 不对外提供服务，需要对外提供服务改成 <code>0.0.0.0</code>）</li>
<li><code>join</code>：表示加入到某个集群中 （比·如：<code>-join=192.168.0.11</code>）</li>
</ul>
<p>浏览器访问：</p>
<p><img src="../images/2021-09-20-04-46-14.png" alt=""></p>
<p>上图显示已经成功 Consul，启动了一个节点名称为 <code>1</code> 的节点 ，并且可以通过管理器管理 Node 节点、Key/Value 功能等。</p>
<h1 id="Consul-集群">Consul 集群</h1>
<p>在上面单机版的基础上面来拓展集群，下面加入两个 Server 模式的 Consul 到集群中。Server 模式在集群中建议是 3个以上，这样更好的避免因为 Server 的宕机导致整个集群挂掉的风险，做到高可用。</p>
<h2 id="Server-加入集群">Server 加入集群</h2>
<p>查看集群信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-01 coresrc]<span class="comment"># docker exec -it consul  consul members</span></span><br><span class="line">Node  Address          Status  Type    Build   Protocol  DC   Segment</span><br><span class="line">1     172.17.0.2:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br></pre></td></tr></table></figure>
<p>加入两个 Server：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  --name=consul2  consul  agent -server -bootstrap -ui -node=2 -client=&#x27;0.0.0.0&#x27; -join=172.17.0.2</span><br><span class="line">docker run -d  --name=consul3  consul  agent -server -bootstrap -ui -node=3 -client=&#x27;0.0.0.0&#x27; -join=172.17.0.2</span><br></pre></td></tr></table></figure>
<p>查看集群信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-01 coresrc]<span class="comment"># docker exec -it consul  consul members</span></span><br><span class="line">Node  Address          Status  Type    Build   Protocol  DC   Segment</span><br><span class="line">1     172.17.0.2:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br><span class="line">2     172.17.0.3:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br><span class="line">3     172.17.0.4:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;C</span><br></pre></td></tr></table></figure>
<p>Web UI 也可以看到新加入了两个节点：</p>
<p><img src="../images/2021-09-20-05-01-35.png" alt=""></p>
<h2 id="Client-加入集群">Client 加入集群</h2>
<p>Client 在 Consul 集群中起到了代理 Server 的作用，Client 模式不持久化数据。一般情况每台应用服务器都会安装一个 Client ，这样可以减轻跨服务器访问带来性能损耗。也可以减轻 Server 的请求压力。</p>
<p>加入两个 Client：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=consul_client1 consul agent -client -node=4 -join=172.17.0.2 -client=<span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">docker run -d --name=consul_client2 consul agent -client -node=5 -join=172.17.0.2 -client=<span class="string">&#x27;0.0.0.0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>查看集群信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-01 coresrc]<span class="comment"># docker exec -it consul  consul members</span></span><br><span class="line">Node          Address          Status  Type    Build   Protocol  DC   Segment</span><br><span class="line">1             172.17.0.2:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br><span class="line">2             172.17.0.3:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br><span class="line">3             172.17.0.4:8301  alive   server  1.10.2  2         dc1  &lt;all&gt;</span><br><span class="line">66656e67bf3f  172.17.0.6:8301  alive   client  1.10.2  2         dc1  &lt;default&gt;</span><br><span class="line">fd748cf0c70d  172.17.0.5:8301  alive   client  1.10.2  2         dc1  &lt;default&gt;</span><br></pre></td></tr></table></figure>
<h1 id="Consul-对外接口">Consul 对外接口</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8500%2Fv1%2Fstatus%2Fleader">http://localhost:8500/v1/status/leader</a>: 显示当前集群的Leader</li>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8500%2Fv1%2Fagent%2Fmembers">http://localhost:8500/v1/agent/members</a>： 查看集群成员的详细信息</li>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8500%2Fv1%2Fstatus%2Fpeers">http://localhost:8500/v1/status/peers</a>：显示集群中的Server成员</li>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8500%2Fv1%2Fcatalog%2Fservices">http://localhost:8500/v1/catalog/services</a>： 显示所有服务</li>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8500%2Fv1%2Fcatalog%2Fnodes">http://localhost:8500/v1/catalog/nodes</a>：显示集群节点的详细信息</li>
</ul>
<h1 id="参考：">参考：</h1>
<p><a target="_blank" rel="noopener" href="https://www.consul.io/docs/install">https://www.consul.io/docs/install</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/consul-guide/06_setup_cluster.md">https://www.bookstack.cn/read/consul-guide/06_setup_cluster.md</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1416526">https://cloud.tencent.com/developer/article/1416526</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b12037fa3249">https://www.jianshu.com/p/b12037fa3249</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuzhuchen/article/details/81913562">https://blog.csdn.net/liuzhuchen/article/details/81913562</a></p>
<p><a target="_blank" rel="noopener" href="http://www.liangxiansen.cn/2017/04/06/consul/#%E4%BD%BF%E7%94%A8consul">http://www.liangxiansen.cn/2017/04/06/consul/#使用consul</a></p>

</article>

<div id="paginator">
  
</div>

                  <script src="https://utteranc.es/client.js" repo="wangpengliang815/blog-comments"
                    issue-term="pathname" label="issue" theme="github-light" crossorigin="anonymous" async>
                    </script>
              </div>
            </div>
            <div class="column col-2 hide-lg">
              <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="W"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Wang,PengLiang</div>
      <div>2021-09-20</div>
    </div>
  </div>

  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
            </div>
          </div>

        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>

  </body>

</html>


<script src="/js/book.js"></script>
