# Rdb

Rdb （Redis DataBase）是Redis用来进行持久化的一种方式，是把当前内存中的数据集快照写入磁盘，也就是 `Snapshot` 快照（数据库中所有键值对数据）。恢复时将快照文件直接读到内存里。

Rdb 是 Redis 默认的持久化方案。在指定的时间间隔内，执行指定次数的写操作，则会将内存中的数据写入到磁盘中。即在指定目录下生成一个 `dump.rdb` (默认名称)文件。`Redis` 重启会通过加载`dump.rdb`文件恢复数据。
<!-- more -->
## 基本原理

Rdb 持久化主要是通过 `SAVE` 和 `BGSAVE` 两个命令对 `Redis` 数据库中当前的数据做 `snapshot` 并生成 `rdb` 文件来实现的。其中`SAVE` 是阻塞的，`BGSAVE` 是非阻塞的，通过 `fork` 了一个子进程来完成的。在 Redis启动时会检测 `rdb` 文件，然后载入 `rdb` 文件中未过期的数据到服务器中。

## 触发方式

Rdb 有两种触发方式：自动触发/手动触发。

### **自动触发**

在 redis.conf 配置文件中的 `SNAPSHOTTING` 下

```bash
# You can set these explicitly by uncommenting the three following lines.
#
# *快照持久化规则设置
# *如果3600秒内，至少一个Key进行了修改，就会进行持久化
# save 3600 1
# save 300 100
# save 60 10000
# 60s内至少一个Key进行了修改就会进行持久化
save 60 1
```

**相关配置**

指定本地数据库文件名，一般采用默认的 `dump.rdb` 

```
dbfilename dump.rdb
```

指定本地数据库存放目录，一般用默认配置即可

```
dir ./
```

默认开启数据压缩

```
rdbcompression yes
```

```bash
[root@wangpengliang bin]# ls
conf      redis-benchmark  redis-check-rdb  redis-sentinel
dump.rdb  redis-check-aof  redis-cli        redis-server
# 删除dump.rdb文件
[root@wangpengliang bin]# rm -f dump.rdb
[root@wangpengliang bin]# ls
conf             redis-check-aof  redis-cli       redis-server
redis-benchmark  redis-check-rdb  redis-sentinel
```

```bash
[root@wangpengliang bin]# ./redis-server conf/redis.conf
# 触发自动快照策略
[root@wangpengliang bin]# ./redis-cli -p 6379
127.0.0.1:6379> SET KEY A
OK
127.0.0.1:6379> SET KEY B
OK
127.0.0.1:6379> SET KEY C
OK
127.0.0.1:6379> SET KEY D
OK
```

```bash
# dump.rdb又存在了
[root@wangpengliang bin]# ls
conf      redis-benchmark  redis-check-rdb  redis-sentinel
dump.rdb  redis-check-aof  redis-cli        redis-server
```

### **手动触发**

| 操作       | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| `save`     | 该命令会阻塞当前`Redis` 服务器，执行 `save` 命令期间，`Redis` 不能处理其他命令，直到 `Rdb`  过程完成为止 |
| `bgsave`   | 执行该命令时，`Redis` 会在后台异步进行快照操作，快照同时还可以响应客户端请求。具体操作是 `Redis` 进程执行 `fork` 操作创建子进程，Rdb 持久化过程由子进程负责，完成后自动结束。阻塞只发生在 `fork` 阶段，一般时间很短 |
| `flushall` |                                                              |
| `shutdown` |                                                              |


## Rdb文件恢复数据

将 `dump.rdb`  文件拷贝到 Redis 的安装目录的`bin` 目录下，重启 Redis 服务即可。在实际开发中，一般会考虑到物理机硬盘损坏情况，选择备份`dump.rdb` 。

## Rdb优缺点

| **优点**                                              | **缺点**                                                     |
| :---------------------------------------------------- | :----------------------------------------------------------- |
| 适合大规模的数据恢复                                  | 数据的完整性和一致性不高，因为可能在最后一次备份时宕机了     |
| 二进制压缩文件，恢复速度快                            | 备份时占用内存，因为Redis 在备份时会独立创建一个子进程，将数据写入到一个临时文件（此时内存中的数据是原来的两倍），最后再将临时文件替换之前的备份文件 |
| 如果业务对数据完整性和一致性要求不高，Rdb是很好的选择 |                                                              |

**注意**：假设 `save` 策略设置的是60秒，Redis在58秒宕机，会丢失最后一次的数据。


# Aof

Redis 默认不开启。它的出现是为了弥补Rdb的不足（数据的不一致性），所以它采用日志的形式来记录每个**写操作**，并**追加**到文件中。Redis 重启的会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。

## 基本原理

AOF（`Append Only File` ）持久化是通过将存储每次执行的客户端命令，然后由一个伪客户端来执行这些命令将数据写入到服务器中的方式实现的。一共分为命令追加（append）/文件写入/文件同步（sync）三个步骤完成。

在 redis.conf 配置文件中的`APPEND ONLY MODE`下

1 redis 默认关闭，开启需要手动把 `no` 改为 `yes`

```bash
appendonly yes
```

2 指定本地数据库文件名，默认值为 `appendonly.aof`

```bash
appendfilename "appendonly.aof"
```

3 指定更新日志条件

```bash
# appendfsync always
appendfsync everysec
# appendfsync no
```

`always`：同步持久化，每次发生数据变化会立刻写入到磁盘中。性能较差但数据完整性比较好（慢，安全）

`everysec`：出厂默认推荐，每秒异步记录一次（默认值）

`no`：不同步

4 配置重写触发机制

当 `aof` 文件大小是上次 `rewrite` 后大小的一倍且文件大于 `64M` 时触发；Redis 会 `fork出一条新进程，读取内存中的数据，并重新写到一个临时文件中。并没有读取旧文件最后替换旧的aof文件`。这里的“一倍”和“64M” 可以通过配置文件修改。

```bash
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

## 触发方式

根据 `redis.conf`  配置文件的配置内容触发。

## Aof文件恢复数据

正常情况下，将 `appendonly.aof` 文件拷贝到redis的安装目录的`bin` 目录下，重启redis服务即可。

## Aof文件修复

在实际开发中，可能因为某些原因导致 `appendonly.aof` 文件格式异常，从而导致数据还原失败，可以通过命令 `redis-check-aof --fix appendonly.aof` 进行修复。

## Aof 优缺点

| 优点                     | 缺点                                |
| ------------------------ | ----------------------------------- |
| 数据的完整性和一致性更高 | 因为AOF记录的内容多，文件会越来越大 |
|                          | 因为文件较大数据恢复也会比较慢      |

# 总结

Redis 默认开启rdb持久化方式。在指定的时间间隔内，执行指定次数的写操作，则将内存中的数据写入到磁盘中。

rdb持久化适合大规模的数据恢复但它的数据一致性和完整性较差。

Redis 需要手动开启 aof 持久化方式，默认是每秒将写操作日志追加到 aof 文件中。

aof 的数据完整性比 rdb 高，但记录内容多了，会影响数据恢复的效率。

Redis 针对 aof 文件大的问题，提供重写的瘦身机制。

若只打算用Redis 做缓存，可以关闭持久化。

若打算使用Redis 的持久化。建议rdb和aof都开启。其实rdb更适合做数据的备份，留一后手。aof 出问题了，还有 rdb。

当 rdb 和 aof 文件同时存在时，Redis会优先使用 aof 文件恢复。
